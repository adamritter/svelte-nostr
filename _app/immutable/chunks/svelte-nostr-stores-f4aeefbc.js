var Jr=Object.defineProperty;var Yr=(e,t,n)=>t in e?Jr(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n;var Me=(e,t,n)=>(Yr(e,typeof t!="symbol"?t+"":t,n),n);import{m as Gr,v as Qr,b as Xr,c as Zr,K as Le}from"./nostr.esm-2011dad1.js";import{r as ar,d as An,w as sr}from"./index-fd964354.js";/*! *****************************************************************************
Copyright (c) Microsoft Corporation.
Permission to use, copy, modify, and/or distribute this software for any
purpose with or without fee is hereby granted.
THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH
REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY
AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT,
INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM
LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR
OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
PERFORMANCE OF THIS SOFTWARE.
***************************************************************************** */var L=function(){return L=Object.assign||function(t){for(var n,r=1,i=arguments.length;r<i;r++){n=arguments[r];for(var o in n)Object.prototype.hasOwnProperty.call(n,o)&&(t[o]=n[o])}return t},L.apply(this,arguments)};function Zt(e,t,n){if(n||arguments.length===2)for(var r=0,i=t.length,o;r<i;r++)(o||!(r in t))&&(o||(o=Array.prototype.slice.call(t,0,r)),o[r]=t[r]);return e.concat(o||Array.prototype.slice.call(t))}var J=typeof globalThis<"u"?globalThis:typeof self<"u"?self:typeof window<"u"?window:global,Q=Object.keys,ne=Array.isArray;typeof Promise<"u"&&!J.Promise&&(J.Promise=Promise);function ie(e,t){return typeof t!="object"||Q(t).forEach(function(n){e[n]=t[n]}),e}var tt=Object.getPrototypeOf,ei={}.hasOwnProperty;function ae(e,t){return ei.call(e,t)}function Ve(e,t){typeof t=="function"&&(t=t(tt(e))),(typeof Reflect>"u"?Q:Reflect.ownKeys)(t).forEach(function(n){_e(e,n,t[n])})}var lr=Object.defineProperty;function _e(e,t,n,r){lr(e,t,ie(n&&ae(n,"get")&&typeof n.get=="function"?{get:n.get,set:n.set,configurable:!0}:{value:n,configurable:!0,writable:!0},r))}function qe(e){return{from:function(t){return e.prototype=Object.create(t.prototype),_e(e.prototype,"constructor",e),{extend:Ve.bind(null,e.prototype)}}}}var ti=Object.getOwnPropertyDescriptor;function Tn(e,t){var n=ti(e,t),r;return n||(r=tt(e))&&Tn(r,t)}var ni=[].slice;function jt(e,t,n){return ni.call(e,t,n)}function fr(e,t){return t(e)}function Ge(e){if(!e)throw new Error("Assertion Failed")}function cr(e){J.setImmediate?setImmediate(e):setTimeout(e,0)}function hr(e,t){return e.reduce(function(n,r,i){var o=t(r,i);return o&&(n[o[0]]=o[1]),n},{})}function ri(e,t,n){try{e.apply(null,n)}catch(r){t&&t(r)}}function be(e,t){if(ae(e,t))return e[t];if(!t)return e;if(typeof t!="string"){for(var n=[],r=0,i=t.length;r<i;++r){var o=be(e,t[r]);n.push(o)}return n}var u=t.indexOf(".");if(u!==-1){var a=e[t.substr(0,u)];return a===void 0?void 0:be(a,t.substr(u+1))}}function le(e,t,n){if(!(!e||t===void 0)&&!("isFrozen"in Object&&Object.isFrozen(e)))if(typeof t!="string"&&"length"in t){Ge(typeof n!="string"&&"length"in n);for(var r=0,i=t.length;r<i;++r)le(e,t[r],n[r])}else{var o=t.indexOf(".");if(o!==-1){var u=t.substr(0,o),a=t.substr(o+1);if(a==="")n===void 0?ne(e)&&!isNaN(parseInt(u))?e.splice(u,1):delete e[u]:e[u]=n;else{var s=e[u];(!s||!ae(e,u))&&(s=e[u]={}),le(s,a,n)}}else n===void 0?ne(e)&&!isNaN(parseInt(t))?e.splice(t,1):delete e[t]:e[t]=n}}function ii(e,t){typeof t=="string"?le(e,t,void 0):"length"in t&&[].map.call(t,function(n){le(e,n,void 0)})}function dr(e){var t={};for(var n in e)ae(e,n)&&(t[n]=e[n]);return t}var oi=[].concat;function pr(e){return oi.apply([],e)}var yr="Boolean,String,Date,RegExp,Blob,File,FileList,FileSystemFileHandle,ArrayBuffer,DataView,Uint8ClampedArray,ImageBitmap,ImageData,Map,Set,CryptoKey".split(",").concat(pr([8,16,32,64].map(function(e){return["Int","Uint","Float"].map(function(t){return t+e+"Array"})}))).filter(function(e){return J[e]}),ui=yr.map(function(e){return J[e]});hr(yr,function(e){return[e,!0]});var Se=null;function st(e){Se=typeof WeakMap<"u"&&new WeakMap;var t=en(e);return Se=null,t}function en(e){if(!e||typeof e!="object")return e;var t=Se&&Se.get(e);if(t)return t;if(ne(e)){t=[],Se&&Se.set(e,t);for(var n=0,r=e.length;n<r;++n)t.push(en(e[n]))}else if(ui.indexOf(e.constructor)>=0)t=e;else{var i=tt(e);t=i===Object.prototype?{}:Object.create(i),Se&&Se.set(e,t);for(var o in e)ae(e,o)&&(t[o]=en(e[o]))}return t}var ai={}.toString;function tn(e){return ai.call(e).slice(8,-1)}var nn=typeof Symbol<"u"?Symbol.iterator:"@@iterator",si=typeof nn=="symbol"?function(e){var t;return e!=null&&(t=e[nn])&&t.apply(e)}:function(){return null},je={};function ge(e){var t,n,r,i;if(arguments.length===1){if(ne(e))return e.slice();if(this===je&&typeof e=="string")return[e];if(i=si(e)){for(n=[];r=i.next(),!r.done;)n.push(r.value);return n}if(e==null)return[e];if(t=e.length,typeof t=="number"){for(n=new Array(t);t--;)n[t]=e[t];return n}return[e]}for(t=arguments.length,n=new Array(t);t--;)n[t]=arguments[t];return n}var On=typeof Symbol<"u"?function(e){return e[Symbol.toStringTag]==="AsyncFunction"}:function(){return!1},pe=typeof location<"u"&&/^(http|https):\/\/(localhost|127\.0\.0\.1)/.test(location.href);function vr(e,t){pe=e,gr=t}var gr=function(){return!0},li=!new Error("").stack;function Be(){if(li)try{throw Be.arguments,new Error}catch(e){return e}return new Error}function rn(e,t){var n=e.stack;return n?(t=t||0,n.indexOf(e.name)===0&&(t+=(e.name+e.message).split(`
`).length),n.split(`
`).slice(t).filter(gr).map(function(r){return`
`+r}).join("")):""}var fi=["Modify","Bulk","OpenFailed","VersionChange","Schema","Upgrade","InvalidTable","MissingAPI","NoSuchDatabase","InvalidArgument","SubTransaction","Unsupported","Internal","DatabaseClosed","PrematureCommit","ForeignAwait"],mr=["Unknown","Constraint","Data","TransactionInactive","ReadOnly","Version","NotFound","InvalidState","InvalidAccess","Abort","Timeout","QuotaExceeded","Syntax","DataClone"],Cn=fi.concat(mr),ci={VersionChanged:"Database version changed by other database connection",DatabaseClosed:"Database has been closed",Abort:"Transaction aborted",TransactionInactive:"Transaction has already completed or failed",MissingAPI:"IndexedDB API missing. Please visit https://tinyurl.com/y2uuvskb"};function Ue(e,t){this._e=Be(),this.name=e,this.message=t}qe(Ue).from(Error).extend({stack:{get:function(){return this._stack||(this._stack=this.name+": "+this.message+rn(this._e,2))}},toString:function(){return this.name+": "+this.message}});function br(e,t){return e+". Errors: "+Object.keys(t).map(function(n){return t[n].toString()}).filter(function(n,r,i){return i.indexOf(n)===r}).join(`
`)}function Ct(e,t,n,r){this._e=Be(),this.failures=t,this.failedKeys=r,this.successCount=n,this.message=br(e,t)}qe(Ct).from(Ue);function Xe(e,t){this._e=Be(),this.name="BulkError",this.failures=Object.keys(t).map(function(n){return t[n]}),this.failuresByPos=t,this.message=br(e,t)}qe(Xe).from(Ue);var Kn=Cn.reduce(function(e,t){return e[t]=t+"Error",e},{}),hi=Ue,I=Cn.reduce(function(e,t){var n=t+"Error";function r(i,o){this._e=Be(),this.name=n,i?typeof i=="string"?(this.message=""+i+(o?`
 `+o:""),this.inner=o||null):typeof i=="object"&&(this.message=i.name+" "+i.message,this.inner=i):(this.message=ci[t]||n,this.inner=null)}return qe(r).from(hi),e[t]=r,e},{});I.Syntax=SyntaxError;I.Type=TypeError;I.Range=RangeError;var zn=mr.reduce(function(e,t){return e[t+"Error"]=I[t],e},{});function di(e,t){if(!e||e instanceof Ue||e instanceof TypeError||e instanceof SyntaxError||!e.name||!zn[e.name])return e;var n=new zn[e.name](t||e.message,e);return"stack"in e&&_e(n,"stack",{get:function(){return this.inner.stack}}),n}var Nt=Cn.reduce(function(e,t){return["Syntax","Type","Range"].indexOf(t)===-1&&(e[t+"Error"]=I[t]),e},{});Nt.ModifyError=Ct;Nt.DexieError=Ue;Nt.BulkError=Xe;function W(){}function lt(e){return e}function pi(e,t){return e==null||e===lt?t:function(n){return t(e(n))}}function Ie(e,t){return function(){e.apply(this,arguments),t.apply(this,arguments)}}function yi(e,t){return e===W?t:function(){var n=e.apply(this,arguments);n!==void 0&&(arguments[0]=n);var r=this.onsuccess,i=this.onerror;this.onsuccess=null,this.onerror=null;var o=t.apply(this,arguments);return r&&(this.onsuccess=this.onsuccess?Ie(r,this.onsuccess):r),i&&(this.onerror=this.onerror?Ie(i,this.onerror):i),o!==void 0?o:n}}function vi(e,t){return e===W?t:function(){e.apply(this,arguments);var n=this.onsuccess,r=this.onerror;this.onsuccess=this.onerror=null,t.apply(this,arguments),n&&(this.onsuccess=this.onsuccess?Ie(n,this.onsuccess):n),r&&(this.onerror=this.onerror?Ie(r,this.onerror):r)}}function gi(e,t){return e===W?t:function(n){var r=e.apply(this,arguments);ie(n,r);var i=this.onsuccess,o=this.onerror;this.onsuccess=null,this.onerror=null;var u=t.apply(this,arguments);return i&&(this.onsuccess=this.onsuccess?Ie(i,this.onsuccess):i),o&&(this.onerror=this.onerror?Ie(o,this.onerror):o),r===void 0?u===void 0?void 0:u:ie(r,u)}}function mi(e,t){return e===W?t:function(){return t.apply(this,arguments)===!1?!1:e.apply(this,arguments)}}function Rn(e,t){return e===W?t:function(){var n=e.apply(this,arguments);if(n&&typeof n.then=="function"){for(var r=this,i=arguments.length,o=new Array(i);i--;)o[i]=arguments[i];return n.then(function(){return t.apply(r,o)})}return t.apply(this,arguments)}}var nt={},bi=100,_i=20,_r=100,kn=typeof Promise>"u"?[]:function(){var e=Promise.resolve();if(typeof crypto>"u"||!crypto.subtle)return[e,tt(e),e];var t=crypto.subtle.digest("SHA-512",new Uint8Array([0]));return[t,tt(t),e]}(),on=kn[0],Kt=kn[1],un=kn[2],wr=Kt&&Kt.then,wt=on&&on.constructor,Dn=!!un,an=!1,wi=un?function(){un.then(vt)}:J.setImmediate?setImmediate.bind(null,vt):J.MutationObserver?function(){var e=document.createElement("div");new MutationObserver(function(){vt(),e=null}).observe(e,{attributes:!0}),e.setAttribute("i","1")}:function(){setTimeout(vt,0)},rt=function(e,t){Qe.push([e,t]),Rt&&(wi(),Rt=!1)},sn=!0,Rt=!0,Re=[],Et=[],ln=null,fn=lt,Ne={id:"global",global:!0,ref:0,unhandleds:[],onunhandled:Yn,pgp:!1,env:{},finalize:function(){this.unhandleds.forEach(function(e){try{Yn(e[0],e[1])}catch{}})}},k=Ne,Qe=[],ke=0,St=[];function C(e){if(typeof this!="object")throw new TypeError("Promises must be constructed via new");this._listeners=[],this.onuncatched=W,this._lib=!1;var t=this._PSD=k;if(pe&&(this._stackHolder=Be(),this._prev=null,this._numPrev=0),typeof e!="function"){if(e!==nt)throw new TypeError("Not a function");this._state=arguments[1],this._value=arguments[2],this._state===!1&&hn(this,this._value);return}this._state=null,this._value=null,++t.ref,Sr(this,e)}var cn={get:function(){var e=k,t=kt;function n(r,i){var o=this,u=!e.global&&(e!==k||t!==kt),a=u&&!we(),s=new C(function(h,y){In(o,new Er(It(r,e,u,a),It(i,e,u,a),h,y,e))});return pe&&Tr(s,this),s}return n.prototype=nt,n},set:function(e){_e(this,"then",e&&e.prototype===nt?cn:{get:function(){return e},set:cn.set})}};Ve(C.prototype,{then:cn,_then:function(e,t){In(this,new Er(null,null,e,t,k))},catch:function(e){if(arguments.length===1)return this.then(null,e);var t=arguments[0],n=arguments[1];return typeof t=="function"?this.then(null,function(r){return r instanceof t?n(r):xt(r)}):this.then(null,function(r){return r&&r.name===t?n(r):xt(r)})},finally:function(e){return this.then(function(t){return e(),t},function(t){return e(),xt(t)})},stack:{get:function(){if(this._stack)return this._stack;try{an=!0;var e=Ar(this,[],_i),t=e.join(`
From previous: `);return this._state!==null&&(this._stack=t),t}finally{an=!1}}},timeout:function(e,t){var n=this;return e<1/0?new C(function(r,i){var o=setTimeout(function(){return i(new I.Timeout(t))},e);n.then(r,i).finally(clearTimeout.bind(null,o))}):this}});typeof Symbol<"u"&&Symbol.toStringTag&&_e(C.prototype,Symbol.toStringTag,"Dexie.Promise");Ne.env=Or();function Er(e,t,n,r,i){this.onFulfilled=typeof e=="function"?e:null,this.onRejected=typeof t=="function"?t:null,this.resolve=n,this.reject=r,this.psd=i}Ve(C,{all:function(){var e=ge.apply(null,arguments).map(Dt);return new C(function(t,n){e.length===0&&t([]);var r=e.length;e.forEach(function(i,o){return C.resolve(i).then(function(u){e[o]=u,--r||t(e)},n)})})},resolve:function(e){if(e instanceof C)return e;if(e&&typeof e.then=="function")return new C(function(n,r){e.then(n,r)});var t=new C(nt,!0,e);return Tr(t,ln),t},reject:xt,race:function(){var e=ge.apply(null,arguments).map(Dt);return new C(function(t,n){e.map(function(r){return C.resolve(r).then(t,n)})})},PSD:{get:function(){return k},set:function(e){return k=e}},totalEchoes:{get:function(){return kt}},newPSD:Ae,usePSD:ze,scheduler:{get:function(){return rt},set:function(e){rt=e}},rejectionMapper:{get:function(){return fn},set:function(e){fn=e}},follow:function(e,t){return new C(function(n,r){return Ae(function(i,o){var u=k;u.unhandleds=[],u.onunhandled=o,u.finalize=Ie(function(){var a=this;Si(function(){a.unhandleds.length===0?i():o(a.unhandleds[0])})},u.finalize),e()},t,n,r)})}});wt&&(wt.allSettled&&_e(C,"allSettled",function(){var e=ge.apply(null,arguments).map(Dt);return new C(function(t){e.length===0&&t([]);var n=e.length,r=new Array(n);e.forEach(function(i,o){return C.resolve(i).then(function(u){return r[o]={status:"fulfilled",value:u}},function(u){return r[o]={status:"rejected",reason:u}}).then(function(){return--n||t(r)})})})}),wt.any&&typeof AggregateError<"u"&&_e(C,"any",function(){var e=ge.apply(null,arguments).map(Dt);return new C(function(t,n){e.length===0&&n(new AggregateError([]));var r=e.length,i=new Array(r);e.forEach(function(o,u){return C.resolve(o).then(function(a){return t(a)},function(a){i[u]=a,--r||n(new AggregateError(i))})})})}));function Sr(e,t){try{t(function(n){if(e._state===null){if(n===e)throw new TypeError("A promise cannot be resolved with itself.");var r=e._lib&&ft();n&&typeof n.then=="function"?Sr(e,function(i,o){n instanceof C?n._then(i,o):n.then(i,o)}):(e._state=!0,e._value=n,xr(e)),r&&ct()}},hn.bind(null,e))}catch(n){hn(e,n)}}function hn(e,t){if(Et.push(t),e._state===null){var n=e._lib&&ft();t=fn(t),e._state=!1,e._value=t,pe&&t!==null&&typeof t=="object"&&!t._promise&&ri(function(){var r=Tn(t,"stack");t._promise=e,_e(t,"stack",{get:function(){return an?r&&(r.get?r.get.apply(t):r.value):e.stack}})}),xi(e),xr(e),n&&ct()}}function xr(e){var t=e._listeners;e._listeners=[];for(var n=0,r=t.length;n<r;++n)In(e,t[n]);var i=e._PSD;--i.ref||i.finalize(),ke===0&&(++ke,rt(function(){--ke===0&&Pn()},[]))}function In(e,t){if(e._state===null){e._listeners.push(t);return}var n=e._state?t.onFulfilled:t.onRejected;if(n===null)return(e._state?t.resolve:t.reject)(e._value);++t.psd.ref,++ke,rt(Ei,[n,e,t])}function Ei(e,t,n){try{ln=t;var r,i=t._value;t._state?r=e(i):(Et.length&&(Et=[]),r=e(i),Et.indexOf(i)===-1&&Ai(t)),n.resolve(r)}catch(o){n.reject(o)}finally{ln=null,--ke===0&&Pn(),--n.psd.ref||n.psd.finalize()}}function Ar(e,t,n){if(t.length===n)return t;var r="";if(e._state===!1){var i=e._value,o,u;i!=null?(o=i.name||"Error",u=i.message||i,r=rn(i,0)):(o=i,u=""),t.push(o+(u?": "+u:"")+r)}return pe&&(r=rn(e._stackHolder,2),r&&t.indexOf(r)===-1&&t.push(r),e._prev&&Ar(e._prev,t,n)),t}function Tr(e,t){var n=t?t._numPrev+1:0;n<bi&&(e._prev=t,e._numPrev=n)}function vt(){ft()&&ct()}function ft(){var e=sn;return sn=!1,Rt=!1,e}function ct(){var e,t,n;do for(;Qe.length>0;)for(e=Qe,Qe=[],n=e.length,t=0;t<n;++t){var r=e[t];r[0].apply(null,r[1])}while(Qe.length>0);sn=!0,Rt=!0}function Pn(){var e=Re;Re=[],e.forEach(function(r){r._PSD.onunhandled.call(null,r._value,r)});for(var t=St.slice(0),n=t.length;n;)t[--n]()}function Si(e){function t(){e(),St.splice(St.indexOf(t),1)}St.push(t),++ke,rt(function(){--ke===0&&Pn()},[])}function xi(e){Re.some(function(t){return t._value===e._value})||Re.push(e)}function Ai(e){for(var t=Re.length;t;)if(Re[--t]._value===e._value){Re.splice(t,1);return}}function xt(e){return new C(nt,!1,e)}function Y(e,t){var n=k;return function(){var r=ft(),i=k;try{return Te(n,!0),e.apply(this,arguments)}catch(o){t&&t(o)}finally{Te(i,!1),r&&ct()}}}var te={awaits:0,echoes:0,id:0},Ti=0,At=[],qt=0,kt=0,Oi=0;function Ae(e,t,n,r){var i=k,o=Object.create(i);o.parent=i,o.ref=0,o.global=!1,o.id=++Oi;var u=Ne.env;o.env=Dn?{Promise:C,PromiseProp:{value:C,configurable:!0,writable:!0},all:C.all,race:C.race,allSettled:C.allSettled,any:C.any,resolve:C.resolve,reject:C.reject,nthen:Hn(u.nthen,o),gthen:Hn(u.gthen,o)}:{},t&&ie(o,t),++i.ref,o.finalize=function(){--this.parent.ref||this.parent.finalize()};var a=ze(o,e,n,r);return o.ref===0&&o.finalize(),a}function We(){return te.id||(te.id=++Ti),++te.awaits,te.echoes+=_r,te.id}function we(){return te.awaits?(--te.awaits===0&&(te.id=0),te.echoes=te.awaits*_r,!0):!1}(""+wr).indexOf("[native code]")===-1&&(We=we=W);function Dt(e){return te.echoes&&e&&e.constructor===wt?(We(),e.then(function(t){return we(),t},function(t){return we(),X(t)})):e}function Ci(e){++kt,(!te.echoes||--te.echoes===0)&&(te.echoes=te.id=0),At.push(k),Te(e,!0)}function Ki(){var e=At[At.length-1];At.pop(),Te(e,!1)}function Te(e,t){var n=k;if((t?te.echoes&&(!qt++||e!==k):qt&&(!--qt||e!==k))&&Cr(t?Ci.bind(null,e):Ki),e!==k&&(k=e,n===Ne&&(Ne.env=Or()),Dn)){var r=Ne.env.Promise,i=e.env;Kt.then=i.nthen,r.prototype.then=i.gthen,(n.global||e.global)&&(Object.defineProperty(J,"Promise",i.PromiseProp),r.all=i.all,r.race=i.race,r.resolve=i.resolve,r.reject=i.reject,i.allSettled&&(r.allSettled=i.allSettled),i.any&&(r.any=i.any))}}function Or(){var e=J.Promise;return Dn?{Promise:e,PromiseProp:Object.getOwnPropertyDescriptor(J,"Promise"),all:e.all,race:e.race,allSettled:e.allSettled,any:e.any,resolve:e.resolve,reject:e.reject,nthen:Kt.then,gthen:e.prototype.then}:{}}function ze(e,t,n,r,i){var o=k;try{return Te(e,!0),t(n,r,i)}finally{Te(o,!1)}}function Cr(e){wr.call(on,e)}function It(e,t,n,r){return typeof e!="function"?e:function(){var i=k;n&&We(),Te(t,!0);try{return e.apply(this,arguments)}finally{Te(i,!1),r&&Cr(we)}}}function Hn(e,t){return function(n,r){return e.call(this,It(n,t),It(r,t))}}var Jn="unhandledrejection";function Yn(e,t){var n;try{n=t.onuncatched(e)}catch{}if(n!==!1)try{var r,i={promise:t,reason:e};if(J.document&&document.createEvent?(r=document.createEvent("Event"),r.initEvent(Jn,!0,!0),ie(r,i)):J.CustomEvent&&(r=new CustomEvent(Jn,{detail:i}),ie(r,i)),r&&J.dispatchEvent&&(dispatchEvent(r),!J.PromiseRejectionEvent&&J.onunhandledrejection))try{J.onunhandledrejection(r)}catch{}pe&&r&&!r.defaultPrevented&&console.warn("Unhandled rejection: "+(e.stack||e))}catch{}}var X=C.reject;function dn(e,t,n,r){if(!e.idbdb||!e._state.openComplete&&!k.letThrough&&!e._vip){if(e._state.openComplete)return X(new I.DatabaseClosed(e._state.dbOpenError));if(!e._state.isBeingOpened){if(!e._options.autoOpen)return X(new I.DatabaseClosed);e.open().catch(W)}return e._state.dbReadyPromise.then(function(){return dn(e,t,n,r)})}else{var i=e._createTransaction(t,n,e._dbSchema);try{i.create(),e._state.PR1398_maxLoop=3}catch(o){return o.name===Kn.InvalidState&&e.isOpen()&&--e._state.PR1398_maxLoop>0?(console.warn("Dexie: Need to reopen db"),e._close(),e.open().then(function(){return dn(e,t,n,r)})):X(o)}return i._promise(t,function(o,u){return Ae(function(){return k.trans=i,r(o,u,i)})}).then(function(o){return i._completion.then(function(){return o})})}}var Gn="3.2.2",Ke=String.fromCharCode(65535),pn=-1/0,ye="Invalid key provided. Keys must be of type string, number, Date or Array<string | number | Date>.",Kr="String expected.",Ze=[],Lt=typeof navigator<"u"&&/(MSIE|Trident|Edge)/.test(navigator.userAgent),Ri=Lt,ki=Lt,Rr=function(e){return!/(dexie\.js|dexie\.min\.js)/.test(e)},Vt="__dbnames",Ut="readonly",Wt="readwrite";function Pe(e,t){return e?t?function(){return e.apply(this,arguments)&&t.apply(this,arguments)}:e:t}var kr={type:3,lower:-1/0,lowerOpen:!1,upper:[[]],upperOpen:!1};function gt(e){return typeof e=="string"&&!/\./.test(e)?function(t){return t[e]===void 0&&e in t&&(t=st(t),delete t[e]),t}:function(t){return t}}var Di=function(){function e(){}return e.prototype._trans=function(t,n,r){var i=this._tx||k.trans,o=this.name;function u(s,h,y){if(!y.schema[o])throw new I.NotFound("Table "+o+" not part of transaction");return n(y.idbtrans,y)}var a=ft();try{return i&&i.db===this.db?i===k.trans?i._promise(t,u,r):Ae(function(){return i._promise(t,u,r)},{trans:i,transless:k.transless||k}):dn(this.db,t,[this.name],u)}finally{a&&ct()}},e.prototype.get=function(t,n){var r=this;return t&&t.constructor===Object?this.where(t).first(n):this._trans("readonly",function(i){return r.core.get({trans:i,key:t}).then(function(o){return r.hook.reading.fire(o)})}).then(n)},e.prototype.where=function(t){if(typeof t=="string")return new this.db.WhereClause(this,t);if(ne(t))return new this.db.WhereClause(this,"["+t.join("+")+"]");var n=Q(t);if(n.length===1)return this.where(n[0]).equals(t[n[0]]);var r=this.schema.indexes.concat(this.schema.primKey).filter(function(y){return y.compound&&n.every(function(v){return y.keyPath.indexOf(v)>=0})&&y.keyPath.every(function(v){return n.indexOf(v)>=0})})[0];if(r&&this.db._maxKey!==Ke)return this.where(r.name).equals(r.keyPath.map(function(y){return t[y]}));!r&&pe&&console.warn("The query "+JSON.stringify(t)+" on "+this.name+" would benefit of a "+("compound index ["+n.join("+")+"]"));var i=this.schema.idxByName,o=this.db._deps.indexedDB;function u(y,v){try{return o.cmp(y,v)===0}catch{return!1}}var a=n.reduce(function(y,v){var g=y[0],_=y[1],d=i[v],p=t[v];return[g||d,g||!d?Pe(_,d&&d.multi?function(c){var S=be(c,v);return ne(S)&&S.some(function(b){return u(p,b)})}:function(c){return u(p,be(c,v))}):_]},[null,null]),s=a[0],h=a[1];return s?this.where(s.name).equals(t[s.keyPath]).filter(h):r?this.filter(h):this.where(n).equals("")},e.prototype.filter=function(t){return this.toCollection().and(t)},e.prototype.count=function(t){return this.toCollection().count(t)},e.prototype.offset=function(t){return this.toCollection().offset(t)},e.prototype.limit=function(t){return this.toCollection().limit(t)},e.prototype.each=function(t){return this.toCollection().each(t)},e.prototype.toArray=function(t){return this.toCollection().toArray(t)},e.prototype.toCollection=function(){return new this.db.Collection(new this.db.WhereClause(this))},e.prototype.orderBy=function(t){return new this.db.Collection(new this.db.WhereClause(this,ne(t)?"["+t.join("+")+"]":t))},e.prototype.reverse=function(){return this.toCollection().reverse()},e.prototype.mapToClass=function(t){this.schema.mappedClass=t;var n=function(r){if(!r)return r;var i=Object.create(t.prototype);for(var o in r)if(ae(r,o))try{i[o]=r[o]}catch{}return i};return this.schema.readHook&&this.hook.reading.unsubscribe(this.schema.readHook),this.schema.readHook=n,this.hook("reading",n),t},e.prototype.defineClass=function(){function t(n){ie(this,n)}return this.mapToClass(t)},e.prototype.add=function(t,n){var r=this,i=this.schema.primKey,o=i.auto,u=i.keyPath,a=t;return u&&o&&(a=gt(u)(t)),this._trans("readwrite",function(s){return r.core.mutate({trans:s,type:"add",keys:n!=null?[n]:null,values:[a]})}).then(function(s){return s.numFailures?C.reject(s.failures[0]):s.lastResult}).then(function(s){if(u)try{le(t,u,s)}catch{}return s})},e.prototype.update=function(t,n){if(typeof t=="object"&&!ne(t)){var r=be(t,this.schema.primKey.keyPath);if(r===void 0)return X(new I.InvalidArgument("Given object does not contain its primary key"));try{typeof n!="function"?Q(n).forEach(function(i){le(t,i,n[i])}):n(t,{value:t,primKey:r})}catch{}return this.where(":id").equals(r).modify(n)}else return this.where(":id").equals(t).modify(n)},e.prototype.put=function(t,n){var r=this,i=this.schema.primKey,o=i.auto,u=i.keyPath,a=t;return u&&o&&(a=gt(u)(t)),this._trans("readwrite",function(s){return r.core.mutate({trans:s,type:"put",values:[a],keys:n!=null?[n]:null})}).then(function(s){return s.numFailures?C.reject(s.failures[0]):s.lastResult}).then(function(s){if(u)try{le(t,u,s)}catch{}return s})},e.prototype.delete=function(t){var n=this;return this._trans("readwrite",function(r){return n.core.mutate({trans:r,type:"delete",keys:[t]})}).then(function(r){return r.numFailures?C.reject(r.failures[0]):void 0})},e.prototype.clear=function(){var t=this;return this._trans("readwrite",function(n){return t.core.mutate({trans:n,type:"deleteRange",range:kr})}).then(function(n){return n.numFailures?C.reject(n.failures[0]):void 0})},e.prototype.bulkGet=function(t){var n=this;return this._trans("readonly",function(r){return n.core.getMany({keys:t,trans:r}).then(function(i){return i.map(function(o){return n.hook.reading.fire(o)})})})},e.prototype.bulkAdd=function(t,n,r){var i=this,o=Array.isArray(n)?n:void 0;r=r||(o?void 0:n);var u=r?r.allKeys:void 0;return this._trans("readwrite",function(a){var s=i.schema.primKey,h=s.auto,y=s.keyPath;if(y&&o)throw new I.InvalidArgument("bulkAdd(): keys argument invalid on tables with inbound keys");if(o&&o.length!==t.length)throw new I.InvalidArgument("Arguments objects and keys must have the same length");var v=t.length,g=y&&h?t.map(gt(y)):t;return i.core.mutate({trans:a,type:"add",keys:o,values:g,wantResults:u}).then(function(_){var d=_.numFailures,p=_.results,c=_.lastResult,S=_.failures,b=u?p:c;if(d===0)return b;throw new Xe(i.name+".bulkAdd(): "+d+" of "+v+" operations failed",S)})})},e.prototype.bulkPut=function(t,n,r){var i=this,o=Array.isArray(n)?n:void 0;r=r||(o?void 0:n);var u=r?r.allKeys:void 0;return this._trans("readwrite",function(a){var s=i.schema.primKey,h=s.auto,y=s.keyPath;if(y&&o)throw new I.InvalidArgument("bulkPut(): keys argument invalid on tables with inbound keys");if(o&&o.length!==t.length)throw new I.InvalidArgument("Arguments objects and keys must have the same length");var v=t.length,g=y&&h?t.map(gt(y)):t;return i.core.mutate({trans:a,type:"put",keys:o,values:g,wantResults:u}).then(function(_){var d=_.numFailures,p=_.results,c=_.lastResult,S=_.failures,b=u?p:c;if(d===0)return b;throw new Xe(i.name+".bulkPut(): "+d+" of "+v+" operations failed",S)})})},e.prototype.bulkDelete=function(t){var n=this,r=t.length;return this._trans("readwrite",function(i){return n.core.mutate({trans:i,type:"delete",keys:t})}).then(function(i){var o=i.numFailures,u=i.lastResult,a=i.failures;if(o===0)return u;throw new Xe(n.name+".bulkDelete(): "+o+" of "+r+" operations failed",a)})},e}();function ht(e){var t={},n=function(a,s){if(s){for(var h=arguments.length,y=new Array(h-1);--h;)y[h-1]=arguments[h];return t[a].subscribe.apply(null,y),e}else if(typeof a=="string")return t[a]};n.addEventType=o;for(var r=1,i=arguments.length;r<i;++r)o(arguments[r]);return n;function o(a,s,h){if(typeof a=="object")return u(a);s||(s=mi),h||(h=W);var y={subscribers:[],fire:h,subscribe:function(v){y.subscribers.indexOf(v)===-1&&(y.subscribers.push(v),y.fire=s(y.fire,v))},unsubscribe:function(v){y.subscribers=y.subscribers.filter(function(g){return g!==v}),y.fire=y.subscribers.reduce(s,h)}};return t[a]=n[a]=y,y}function u(a){Q(a).forEach(function(s){var h=a[s];if(ne(h))o(s,a[s][0],a[s][1]);else if(h==="asap")var y=o(s,lt,function(){for(var g=arguments.length,_=new Array(g);g--;)_[g]=arguments[g];y.subscribers.forEach(function(d){cr(function(){d.apply(null,_)})})});else throw new I.InvalidArgument("Invalid event config")})}}function dt(e,t){return qe(t).from({prototype:e}),t}function Ii(e){return dt(Di.prototype,function(n,r,i){this.db=e,this._tx=i,this.name=n,this.schema=r,this.hook=e._allTables[n]?e._allTables[n].hook:ht(null,{creating:[yi,W],reading:[pi,lt],updating:[gi,W],deleting:[vi,W]})})}function Fe(e,t){return!(e.filter||e.algorithm||e.or)&&(t?e.justLimit:!e.replayFilter)}function zt(e,t){e.filter=Pe(e.filter,t)}function Ht(e,t,n){var r=e.replayFilter;e.replayFilter=r?function(){return Pe(r(),t())}:t,e.justLimit=n&&!r}function Pi(e,t){e.isMatch=Pe(e.isMatch,t)}function Tt(e,t){if(e.isPrimKey)return t.primaryKey;var n=t.getIndexByKeyPath(e.index);if(!n)throw new I.Schema("KeyPath "+e.index+" on object store "+t.name+" is not indexed");return n}function Qn(e,t,n){var r=Tt(e,t.schema);return t.openCursor({trans:n,values:!e.keysOnly,reverse:e.dir==="prev",unique:!!e.unique,query:{index:r,range:e.range}})}function mt(e,t,n,r){var i=e.replayFilter?Pe(e.filter,e.replayFilter()):e.filter;if(e.or){var o={},u=function(a,s,h){if(!i||i(s,h,function(g){return s.stop(g)},function(g){return s.fail(g)})){var y=s.primaryKey,v=""+y;v==="[object ArrayBuffer]"&&(v=""+new Uint8Array(y)),ae(o,v)||(o[v]=!0,t(a,s,h))}};return Promise.all([e.or._iterate(u,n),Xn(Qn(e,r,n),e.algorithm,u,!e.keysOnly&&e.valueMapper)])}else return Xn(Qn(e,r,n),Pe(e.algorithm,i),t,!e.keysOnly&&e.valueMapper)}function Xn(e,t,n,r){var i=r?function(u,a,s){return n(r(u),a,s)}:n,o=Y(i);return e.then(function(u){if(u)return u.start(function(){var a=function(){return u.continue()};(!t||t(u,function(s){return a=s},function(s){u.stop(s),a=W},function(s){u.fail(s),a=W}))&&o(u.value,u,function(s){return a=s}),a()})})}function re(e,t){try{var n=Zn(e),r=Zn(t);if(n!==r)return n==="Array"?1:r==="Array"?-1:n==="binary"?1:r==="binary"?-1:n==="string"?1:r==="string"?-1:n==="Date"?1:r!=="Date"?NaN:-1;switch(n){case"number":case"Date":case"string":return e>t?1:e<t?-1:0;case"binary":return Mi(er(e),er(t));case"Array":return Bi(e,t)}}catch{}return NaN}function Bi(e,t){for(var n=e.length,r=t.length,i=n<r?n:r,o=0;o<i;++o){var u=re(e[o],t[o]);if(u!==0)return u}return n===r?0:n<r?-1:1}function Mi(e,t){for(var n=e.length,r=t.length,i=n<r?n:r,o=0;o<i;++o)if(e[o]!==t[o])return e[o]<t[o]?-1:1;return n===r?0:n<r?-1:1}function Zn(e){var t=typeof e;if(t!=="object")return t;if(ArrayBuffer.isView(e))return"binary";var n=tn(e);return n==="ArrayBuffer"?"binary":n}function er(e){return e instanceof Uint8Array?e:ArrayBuffer.isView(e)?new Uint8Array(e.buffer,e.byteOffset,e.byteLength):new Uint8Array(e)}var Fi=function(){function e(){}return e.prototype._read=function(t,n){var r=this._ctx;return r.error?r.table._trans(null,X.bind(null,r.error)):r.table._trans("readonly",t).then(n)},e.prototype._write=function(t){var n=this._ctx;return n.error?n.table._trans(null,X.bind(null,n.error)):n.table._trans("readwrite",t,"locked")},e.prototype._addAlgorithm=function(t){var n=this._ctx;n.algorithm=Pe(n.algorithm,t)},e.prototype._iterate=function(t,n){return mt(this._ctx,t,n,this._ctx.table.core)},e.prototype.clone=function(t){var n=Object.create(this.constructor.prototype),r=Object.create(this._ctx);return t&&ie(r,t),n._ctx=r,n},e.prototype.raw=function(){return this._ctx.valueMapper=null,this},e.prototype.each=function(t){var n=this._ctx;return this._read(function(r){return mt(n,t,r,n.table.core)})},e.prototype.count=function(t){var n=this;return this._read(function(r){var i=n._ctx,o=i.table.core;if(Fe(i,!0))return o.count({trans:r,query:{index:Tt(i,o.schema),range:i.range}}).then(function(a){return Math.min(a,i.limit)});var u=0;return mt(i,function(){return++u,!1},r,o).then(function(){return u})}).then(t)},e.prototype.sortBy=function(t,n){var r=t.split(".").reverse(),i=r[0],o=r.length-1;function u(h,y){return y?u(h[r[y]],y-1):h[i]}var a=this._ctx.dir==="next"?1:-1;function s(h,y){var v=u(h,o),g=u(y,o);return v<g?-a:v>g?a:0}return this.toArray(function(h){return h.sort(s)}).then(n)},e.prototype.toArray=function(t){var n=this;return this._read(function(r){var i=n._ctx;if(i.dir==="next"&&Fe(i,!0)&&i.limit>0){var o=i.valueMapper,u=Tt(i,i.table.core.schema);return i.table.core.query({trans:r,limit:i.limit,values:!0,query:{index:u,range:i.range}}).then(function(s){var h=s.result;return o?h.map(o):h})}else{var a=[];return mt(i,function(s){return a.push(s)},r,i.table.core).then(function(){return a})}},t)},e.prototype.offset=function(t){var n=this._ctx;return t<=0?this:(n.offset+=t,Fe(n)?Ht(n,function(){var r=t;return function(i,o){return r===0?!0:r===1?(--r,!1):(o(function(){i.advance(r),r=0}),!1)}}):Ht(n,function(){var r=t;return function(){return--r<0}}),this)},e.prototype.limit=function(t){return this._ctx.limit=Math.min(this._ctx.limit,t),Ht(this._ctx,function(){var n=t;return function(r,i,o){return--n<=0&&i(o),n>=0}},!0),this},e.prototype.until=function(t,n){return zt(this._ctx,function(r,i,o){return t(r.value)?(i(o),n):!0}),this},e.prototype.first=function(t){return this.limit(1).toArray(function(n){return n[0]}).then(t)},e.prototype.last=function(t){return this.reverse().first(t)},e.prototype.filter=function(t){return zt(this._ctx,function(n){return t(n.value)}),Pi(this._ctx,t),this},e.prototype.and=function(t){return this.filter(t)},e.prototype.or=function(t){return new this.db.WhereClause(this._ctx.table,t,this)},e.prototype.reverse=function(){return this._ctx.dir=this._ctx.dir==="prev"?"next":"prev",this._ondirectionchange&&this._ondirectionchange(this._ctx.dir),this},e.prototype.desc=function(){return this.reverse()},e.prototype.eachKey=function(t){var n=this._ctx;return n.keysOnly=!n.isMatch,this.each(function(r,i){t(i.key,i)})},e.prototype.eachUniqueKey=function(t){return this._ctx.unique="unique",this.eachKey(t)},e.prototype.eachPrimaryKey=function(t){var n=this._ctx;return n.keysOnly=!n.isMatch,this.each(function(r,i){t(i.primaryKey,i)})},e.prototype.keys=function(t){var n=this._ctx;n.keysOnly=!n.isMatch;var r=[];return this.each(function(i,o){r.push(o.key)}).then(function(){return r}).then(t)},e.prototype.primaryKeys=function(t){var n=this._ctx;if(n.dir==="next"&&Fe(n,!0)&&n.limit>0)return this._read(function(i){var o=Tt(n,n.table.core.schema);return n.table.core.query({trans:i,values:!1,limit:n.limit,query:{index:o,range:n.range}})}).then(function(i){var o=i.result;return o}).then(t);n.keysOnly=!n.isMatch;var r=[];return this.each(function(i,o){r.push(o.primaryKey)}).then(function(){return r}).then(t)},e.prototype.uniqueKeys=function(t){return this._ctx.unique="unique",this.keys(t)},e.prototype.firstKey=function(t){return this.limit(1).keys(function(n){return n[0]}).then(t)},e.prototype.lastKey=function(t){return this.reverse().firstKey(t)},e.prototype.distinct=function(){var t=this._ctx,n=t.index&&t.table.schema.idxByName[t.index];if(!n||!n.multi)return this;var r={};return zt(this._ctx,function(i){var o=i.primaryKey.toString(),u=ae(r,o);return r[o]=!0,!u}),this},e.prototype.modify=function(t){var n=this,r=this._ctx;return this._write(function(i){var o;if(typeof t=="function")o=t;else{var u=Q(t),a=u.length;o=function(S){for(var b=!1,w=0;w<a;++w){var f=u[w],l=t[f];be(S,f)!==l&&(le(S,f,l),b=!0)}return b}}var s=r.table.core,h=s.schema.primaryKey,y=h.outbound,v=h.extractKey,g=n.db._options.modifyChunkSize||200,_=[],d=0,p=[],c=function(S,b){var w=b.failures,f=b.numFailures;d+=S-f;for(var l=0,m=Q(w);l<m.length;l++){var A=m[l];_.push(w[A])}};return n.clone().primaryKeys().then(function(S){var b=function(w){var f=Math.min(g,S.length-w);return s.getMany({trans:i,keys:S.slice(w,w+f),cache:"immutable"}).then(function(l){for(var m=[],A=[],x=y?[]:null,O=[],T=0;T<f;++T){var j=l[T],V={value:st(j),primKey:S[w+T]};o.call(V,V.value,V)!==!1&&(V.value==null?O.push(S[w+T]):!y&&re(v(j),v(V.value))!==0?(O.push(S[w+T]),m.push(V.value)):(A.push(V.value),y&&x.push(S[w+T])))}var N=Fe(r)&&r.limit===1/0&&(typeof t!="function"||t===Jt)&&{index:r.index,range:r.range};return Promise.resolve(m.length>0&&s.mutate({trans:i,type:"add",values:m}).then(function(G){for(var B in G.failures)O.splice(parseInt(B),1);c(m.length,G)})).then(function(){return(A.length>0||N&&typeof t=="object")&&s.mutate({trans:i,type:"put",keys:x,values:A,criteria:N,changeSpec:typeof t!="function"&&t}).then(function(G){return c(A.length,G)})}).then(function(){return(O.length>0||N&&t===Jt)&&s.mutate({trans:i,type:"delete",keys:O,criteria:N}).then(function(G){return c(O.length,G)})}).then(function(){return S.length>w+f&&b(w+g)})})};return b(0).then(function(){if(_.length>0)throw new Ct("Error modifying one or more objects",_,d,p);return S.length})})})},e.prototype.delete=function(){var t=this._ctx,n=t.range;return Fe(t)&&(t.isPrimKey&&!ki||n.type===3)?this._write(function(r){var i=t.table.core.schema.primaryKey,o=n;return t.table.core.count({trans:r,query:{index:i,range:o}}).then(function(u){return t.table.core.mutate({trans:r,type:"deleteRange",range:o}).then(function(a){var s=a.failures;a.lastResult,a.results;var h=a.numFailures;if(h)throw new Ct("Could not delete some values",Object.keys(s).map(function(y){return s[y]}),u-h);return u-h})})}):this.modify(Jt)},e}(),Jt=function(e,t){return t.value=null};function $i(e){return dt(Fi.prototype,function(n,r){this.db=e;var i=kr,o=null;if(r)try{i=r()}catch(h){o=h}var u=n._ctx,a=u.table,s=a.hook.reading.fire;this._ctx={table:a,index:u.index,isPrimKey:!u.index||a.schema.primKey.keyPath&&u.index===a.schema.primKey.name,range:i,keysOnly:!1,dir:"next",unique:"",algorithm:null,filter:null,replayFilter:null,justLimit:!0,isMatch:null,offset:0,limit:1/0,error:o,or:u.or,valueMapper:s!==lt?s:null}})}function ji(e,t){return e<t?-1:e===t?0:1}function Ni(e,t){return e>t?-1:e===t?0:1}function ue(e,t,n){var r=e instanceof Ir?new e.Collection(e):e;return r._ctx.error=n?new n(t):new TypeError(t),r}function $e(e){return new e.Collection(e,function(){return Dr("")}).limit(0)}function Li(e){return e==="next"?function(t){return t.toUpperCase()}:function(t){return t.toLowerCase()}}function Vi(e){return e==="next"?function(t){return t.toLowerCase()}:function(t){return t.toUpperCase()}}function qi(e,t,n,r,i,o){for(var u=Math.min(e.length,r.length),a=-1,s=0;s<u;++s){var h=t[s];if(h!==r[s])return i(e[s],n[s])<0?e.substr(0,s)+n[s]+n.substr(s+1):i(e[s],r[s])<0?e.substr(0,s)+r[s]+n.substr(s+1):a>=0?e.substr(0,a)+t[a]+n.substr(a+1):null;i(e[s],h)<0&&(a=s)}return u<r.length&&o==="next"?e+n.substr(e.length):u<e.length&&o==="prev"?e.substr(0,n.length):a<0?null:e.substr(0,a)+r[a]+n.substr(a+1)}function bt(e,t,n,r){var i,o,u,a,s,h,y,v=n.length;if(!n.every(function(p){return typeof p=="string"}))return ue(e,Kr);function g(p){i=Li(p),o=Vi(p),u=p==="next"?ji:Ni;var c=n.map(function(S){return{lower:o(S),upper:i(S)}}).sort(function(S,b){return u(S.lower,b.lower)});a=c.map(function(S){return S.upper}),s=c.map(function(S){return S.lower}),h=p,y=p==="next"?"":r}g("next");var _=new e.Collection(e,function(){return Ee(a[0],s[v-1]+r)});_._ondirectionchange=function(p){g(p)};var d=0;return _._addAlgorithm(function(p,c,S){var b=p.key;if(typeof b!="string")return!1;var w=o(b);if(t(w,s,d))return!0;for(var f=null,l=d;l<v;++l){var m=qi(b,w,a[l],s[l],u,h);m===null&&f===null?d=l+1:(f===null||u(f,m)>0)&&(f=m)}return c(f!==null?function(){p.continue(f+y)}:S),!1}),_}function Ee(e,t,n,r){return{type:2,lower:e,upper:t,lowerOpen:n,upperOpen:r}}function Dr(e){return{type:1,lower:e,upper:e}}var Ir=function(){function e(){}return Object.defineProperty(e.prototype,"Collection",{get:function(){return this._ctx.table.db.Collection},enumerable:!1,configurable:!0}),e.prototype.between=function(t,n,r,i){r=r!==!1,i=i===!0;try{return this._cmp(t,n)>0||this._cmp(t,n)===0&&(r||i)&&!(r&&i)?$e(this):new this.Collection(this,function(){return Ee(t,n,!r,!i)})}catch{return ue(this,ye)}},e.prototype.equals=function(t){return t==null?ue(this,ye):new this.Collection(this,function(){return Dr(t)})},e.prototype.above=function(t){return t==null?ue(this,ye):new this.Collection(this,function(){return Ee(t,void 0,!0)})},e.prototype.aboveOrEqual=function(t){return t==null?ue(this,ye):new this.Collection(this,function(){return Ee(t,void 0,!1)})},e.prototype.below=function(t){return t==null?ue(this,ye):new this.Collection(this,function(){return Ee(void 0,t,!1,!0)})},e.prototype.belowOrEqual=function(t){return t==null?ue(this,ye):new this.Collection(this,function(){return Ee(void 0,t)})},e.prototype.startsWith=function(t){return typeof t!="string"?ue(this,Kr):this.between(t,t+Ke,!0,!0)},e.prototype.startsWithIgnoreCase=function(t){return t===""?this.startsWith(t):bt(this,function(n,r){return n.indexOf(r[0])===0},[t],Ke)},e.prototype.equalsIgnoreCase=function(t){return bt(this,function(n,r){return n===r[0]},[t],"")},e.prototype.anyOfIgnoreCase=function(){var t=ge.apply(je,arguments);return t.length===0?$e(this):bt(this,function(n,r){return r.indexOf(n)!==-1},t,"")},e.prototype.startsWithAnyOfIgnoreCase=function(){var t=ge.apply(je,arguments);return t.length===0?$e(this):bt(this,function(n,r){return r.some(function(i){return n.indexOf(i)===0})},t,Ke)},e.prototype.anyOf=function(){var t=this,n=ge.apply(je,arguments),r=this._cmp;try{n.sort(r)}catch{return ue(this,ye)}if(n.length===0)return $e(this);var i=new this.Collection(this,function(){return Ee(n[0],n[n.length-1])});i._ondirectionchange=function(u){r=u==="next"?t._ascending:t._descending,n.sort(r)};var o=0;return i._addAlgorithm(function(u,a,s){for(var h=u.key;r(h,n[o])>0;)if(++o,o===n.length)return a(s),!1;return r(h,n[o])===0?!0:(a(function(){u.continue(n[o])}),!1)}),i},e.prototype.notEqual=function(t){return this.inAnyRange([[pn,t],[t,this.db._maxKey]],{includeLowers:!1,includeUppers:!1})},e.prototype.noneOf=function(){var t=ge.apply(je,arguments);if(t.length===0)return new this.Collection(this);try{t.sort(this._ascending)}catch{return ue(this,ye)}var n=t.reduce(function(r,i){return r?r.concat([[r[r.length-1][1],i]]):[[pn,i]]},null);return n.push([t[t.length-1],this.db._maxKey]),this.inAnyRange(n,{includeLowers:!1,includeUppers:!1})},e.prototype.inAnyRange=function(t,n){var r=this,i=this._cmp,o=this._ascending,u=this._descending,a=this._min,s=this._max;if(t.length===0)return $e(this);if(!t.every(function(l){return l[0]!==void 0&&l[1]!==void 0&&o(l[0],l[1])<=0}))return ue(this,"First argument to inAnyRange() must be an Array of two-value Arrays [lower,upper] where upper must not be lower than lower",I.InvalidArgument);var h=!n||n.includeLowers!==!1,y=n&&n.includeUppers===!0;function v(l,m){for(var A=0,x=l.length;A<x;++A){var O=l[A];if(i(m[0],O[1])<0&&i(m[1],O[0])>0){O[0]=a(O[0],m[0]),O[1]=s(O[1],m[1]);break}}return A===x&&l.push(m),l}var g=o;function _(l,m){return g(l[0],m[0])}var d;try{d=t.reduce(v,[]),d.sort(_)}catch{return ue(this,ye)}var p=0,c=y?function(l){return o(l,d[p][1])>0}:function(l){return o(l,d[p][1])>=0},S=h?function(l){return u(l,d[p][0])>0}:function(l){return u(l,d[p][0])>=0};function b(l){return!c(l)&&!S(l)}var w=c,f=new this.Collection(this,function(){return Ee(d[0][0],d[d.length-1][1],!h,!y)});return f._ondirectionchange=function(l){l==="next"?(w=c,g=o):(w=S,g=u),d.sort(_)},f._addAlgorithm(function(l,m,A){for(var x=l.key;w(x);)if(++p,p===d.length)return m(A),!1;return b(x)?!0:(r._cmp(x,d[p][1])===0||r._cmp(x,d[p][0])===0||m(function(){g===o?l.continue(d[p][0]):l.continue(d[p][1])}),!1)}),f},e.prototype.startsWithAnyOf=function(){var t=ge.apply(je,arguments);return t.every(function(n){return typeof n=="string"})?t.length===0?$e(this):this.inAnyRange(t.map(function(n){return[n,n+Ke]})):ue(this,"startsWithAnyOf() only works with strings")},e}();function Ui(e){return dt(Ir.prototype,function(n,r,i){this.db=e,this._ctx={table:n,index:r===":id"?null:r,or:i};var o=e._deps.indexedDB;if(!o)throw new I.MissingAPI;this._cmp=this._ascending=o.cmp.bind(o),this._descending=function(u,a){return o.cmp(a,u)},this._max=function(u,a){return o.cmp(u,a)>0?u:a},this._min=function(u,a){return o.cmp(u,a)<0?u:a},this._IDBKeyRange=e._deps.IDBKeyRange})}function he(e){return Y(function(t){return it(t),e(t.target.error),!1})}function it(e){e.stopPropagation&&e.stopPropagation(),e.preventDefault&&e.preventDefault()}var ot="storagemutated",xe="x-storagemutated-1",Oe=ht(null,ot),Wi=function(){function e(){}return e.prototype._lock=function(){return Ge(!k.global),++this._reculock,this._reculock===1&&!k.global&&(k.lockOwnerFor=this),this},e.prototype._unlock=function(){if(Ge(!k.global),--this._reculock===0)for(k.global||(k.lockOwnerFor=null);this._blockedFuncs.length>0&&!this._locked();){var t=this._blockedFuncs.shift();try{ze(t[1],t[0])}catch{}}return this},e.prototype._locked=function(){return this._reculock&&k.lockOwnerFor!==this},e.prototype.create=function(t){var n=this;if(!this.mode)return this;var r=this.db.idbdb,i=this.db._state.dbOpenError;if(Ge(!this.idbtrans),!t&&!r)switch(i&&i.name){case"DatabaseClosedError":throw new I.DatabaseClosed(i);case"MissingAPIError":throw new I.MissingAPI(i.message,i);default:throw new I.OpenFailed(i)}if(!this.active)throw new I.TransactionInactive;return Ge(this._completion._state===null),t=this.idbtrans=t||(this.db.core?this.db.core.transaction(this.storeNames,this.mode,{durability:this.chromeTransactionDurability}):r.transaction(this.storeNames,this.mode,{durability:this.chromeTransactionDurability})),t.onerror=Y(function(o){it(o),n._reject(t.error)}),t.onabort=Y(function(o){it(o),n.active&&n._reject(new I.Abort(t.error)),n.active=!1,n.on("abort").fire(o)}),t.oncomplete=Y(function(){n.active=!1,n._resolve(),"mutatedParts"in t&&Oe.storagemutated.fire(t.mutatedParts)}),this},e.prototype._promise=function(t,n,r){var i=this;if(t==="readwrite"&&this.mode!=="readwrite")return X(new I.ReadOnly("Transaction is readonly"));if(!this.active)return X(new I.TransactionInactive);if(this._locked())return new C(function(u,a){i._blockedFuncs.push([function(){i._promise(t,n,r).then(u,a)},k])});if(r)return Ae(function(){var u=new C(function(a,s){i._lock();var h=n(a,s,i);h&&h.then&&h.then(a,s)});return u.finally(function(){return i._unlock()}),u._lib=!0,u});var o=new C(function(u,a){var s=n(u,a,i);s&&s.then&&s.then(u,a)});return o._lib=!0,o},e.prototype._root=function(){return this.parent?this.parent._root():this},e.prototype.waitFor=function(t){var n=this._root(),r=C.resolve(t);if(n._waitingFor)n._waitingFor=n._waitingFor.then(function(){return r});else{n._waitingFor=r,n._waitingQueue=[];var i=n.idbtrans.objectStore(n.storeNames[0]);(function u(){for(++n._spinCount;n._waitingQueue.length;)n._waitingQueue.shift()();n._waitingFor&&(i.get(-1/0).onsuccess=u)})()}var o=n._waitingFor;return new C(function(u,a){r.then(function(s){return n._waitingQueue.push(Y(u.bind(null,s)))},function(s){return n._waitingQueue.push(Y(a.bind(null,s)))}).finally(function(){n._waitingFor===o&&(n._waitingFor=null)})})},e.prototype.abort=function(){this.active&&(this.active=!1,this.idbtrans&&this.idbtrans.abort(),this._reject(new I.Abort))},e.prototype.table=function(t){var n=this._memoizedTables||(this._memoizedTables={});if(ae(n,t))return n[t];var r=this.schema[t];if(!r)throw new I.NotFound("Table "+t+" not part of transaction");var i=new this.db.Table(t,r,this);return i.core=this.db.core.table(t),n[t]=i,i},e}();function zi(e){return dt(Wi.prototype,function(n,r,i,o,u){var a=this;this.db=e,this.mode=n,this.storeNames=r,this.schema=i,this.chromeTransactionDurability=o,this.idbtrans=null,this.on=ht(this,"complete","error","abort"),this.parent=u||null,this.active=!0,this._reculock=0,this._blockedFuncs=[],this._resolve=null,this._reject=null,this._waitingFor=null,this._waitingQueue=null,this._spinCount=0,this._completion=new C(function(s,h){a._resolve=s,a._reject=h}),this._completion.then(function(){a.active=!1,a.on.complete.fire()},function(s){var h=a.active;return a.active=!1,a.on.error.fire(s),a.parent?a.parent._reject(s):h&&a.idbtrans&&a.idbtrans.abort(),X(s)})})}function yn(e,t,n,r,i,o,u){return{name:e,keyPath:t,unique:n,multi:r,auto:i,compound:o,src:(n&&!u?"&":"")+(r?"*":"")+(i?"++":"")+Pr(t)}}function Pr(e){return typeof e=="string"?e:e?"["+[].join.call(e,"+")+"]":""}function Br(e,t,n){return{name:e,primKey:t,indexes:n,mappedClass:null,idxByName:hr(n,function(r){return[r.name,r]})}}function Hi(e){return e.length===1?e[0]:e}var ut=function(e){try{return e.only([[]]),ut=function(){return[[]]},[[]]}catch{return ut=function(){return Ke},Ke}};function vn(e){return e==null?function(){}:typeof e=="string"?Ji(e):function(t){return be(t,e)}}function Ji(e){var t=e.split(".");return t.length===1?function(n){return n[e]}:function(n){return be(n,e)}}function tr(e){return[].slice.call(e)}var Yi=0;function et(e){return e==null?":id":typeof e=="string"?e:"["+e.join("+")+"]"}function Gi(e,t,n){function r(v,g){var _=tr(v.objectStoreNames);return{schema:{name:v.name,tables:_.map(function(d){return g.objectStore(d)}).map(function(d){var p=d.keyPath,c=d.autoIncrement,S=ne(p),b=p==null,w={},f={name:d.name,primaryKey:{name:null,isPrimaryKey:!0,outbound:b,compound:S,keyPath:p,autoIncrement:c,unique:!0,extractKey:vn(p)},indexes:tr(d.indexNames).map(function(l){return d.index(l)}).map(function(l){var m=l.name,A=l.unique,x=l.multiEntry,O=l.keyPath,T=ne(O),j={name:m,compound:T,keyPath:O,unique:A,multiEntry:x,extractKey:vn(O)};return w[et(O)]=j,j}),getIndexByKeyPath:function(l){return w[et(l)]}};return w[":id"]=f.primaryKey,p!=null&&(w[et(p)]=f.primaryKey),f})},hasGetAll:_.length>0&&"getAll"in g.objectStore(_[0])&&!(typeof navigator<"u"&&/Safari/.test(navigator.userAgent)&&!/(Chrome\/|Edge\/)/.test(navigator.userAgent)&&[].concat(navigator.userAgent.match(/Safari\/(\d*)/))[1]<604)}}function i(v){if(v.type===3)return null;if(v.type===4)throw new Error("Cannot convert never type to IDBKeyRange");var g=v.lower,_=v.upper,d=v.lowerOpen,p=v.upperOpen,c=g===void 0?_===void 0?null:t.upperBound(_,!!p):_===void 0?t.lowerBound(g,!!d):t.bound(g,_,!!d,!!p);return c}function o(v){var g=v.name;function _(c){var S=c.trans,b=c.type,w=c.keys,f=c.values,l=c.range;return new Promise(function(m,A){m=Y(m);var x=S.objectStore(g),O=x.keyPath==null,T=b==="put"||b==="add";if(!T&&b!=="delete"&&b!=="deleteRange")throw new Error("Invalid operation type: "+b);var j=(w||f||{length:1}).length;if(w&&f&&w.length!==f.length)throw new Error("Given keys array must have same length as given values array.");if(j===0)return m({numFailures:0,failures:{},results:[],lastResult:void 0});var V,N=[],G=[],B=0,q=function(R){++B,it(R)};if(b==="deleteRange"){if(l.type===4)return m({numFailures:B,failures:G,results:[],lastResult:void 0});l.type===3?N.push(V=x.clear()):N.push(V=x.delete(i(l)))}else{var E=T?O?[f,w]:[f,null]:[w,null],K=E[0],P=E[1];if(T)for(var D=0;D<j;++D)N.push(V=P&&P[D]!==void 0?x[b](K[D],P[D]):x[b](K[D])),V.onerror=q;else for(var D=0;D<j;++D)N.push(V=x[b](K[D])),V.onerror=q}var $=function(R){var M=R.target.result;N.forEach(function(F,U){return F.error!=null&&(G[U]=F.error)}),m({numFailures:B,failures:G,results:b==="delete"?w:N.map(function(F){return F.result}),lastResult:M})};V.onerror=function(R){q(R),$(R)},V.onsuccess=$})}function d(c){var S=c.trans,b=c.values,w=c.query,f=c.reverse,l=c.unique;return new Promise(function(m,A){m=Y(m);var x=w.index,O=w.range,T=S.objectStore(g),j=x.isPrimaryKey?T:T.index(x.name),V=f?l?"prevunique":"prev":l?"nextunique":"next",N=b||!("openKeyCursor"in j)?j.openCursor(i(O),V):j.openKeyCursor(i(O),V);N.onerror=he(A),N.onsuccess=Y(function(G){var B=N.result;if(!B){m(null);return}B.___id=++Yi,B.done=!1;var q=B.continue.bind(B),E=B.continuePrimaryKey;E&&(E=E.bind(B));var K=B.advance.bind(B),P=function(){throw new Error("Cursor not started")},D=function(){throw new Error("Cursor not stopped")};B.trans=S,B.stop=B.continue=B.continuePrimaryKey=B.advance=P,B.fail=Y(A),B.next=function(){var $=this,R=1;return this.start(function(){return R--?$.continue():$.stop()}).then(function(){return $})},B.start=function($){var R=new Promise(function(F,U){F=Y(F),N.onerror=he(U),B.fail=U,B.stop=function(H){B.stop=B.continue=B.continuePrimaryKey=B.advance=D,F(H)}}),M=function(){if(N.result)try{$()}catch(F){B.fail(F)}else B.done=!0,B.start=function(){throw new Error("Cursor behind last entry")},B.stop()};return N.onsuccess=Y(function(F){N.onsuccess=M,M()}),B.continue=q,B.continuePrimaryKey=E,B.advance=K,M(),R},m(B)},A)})}function p(c){return function(S){return new Promise(function(b,w){b=Y(b);var f=S.trans,l=S.values,m=S.limit,A=S.query,x=m===1/0?void 0:m,O=A.index,T=A.range,j=f.objectStore(g),V=O.isPrimaryKey?j:j.index(O.name),N=i(T);if(m===0)return b({result:[]});if(c){var G=l?V.getAll(N,x):V.getAllKeys(N,x);G.onsuccess=function(K){return b({result:K.target.result})},G.onerror=he(w)}else{var B=0,q=l||!("openKeyCursor"in V)?V.openCursor(N):V.openKeyCursor(N),E=[];q.onsuccess=function(K){var P=q.result;if(!P)return b({result:E});if(E.push(l?P.value:P.primaryKey),++B===m)return b({result:E});P.continue()},q.onerror=he(w)}})}}return{name:g,schema:v,mutate:_,getMany:function(c){var S=c.trans,b=c.keys;return new Promise(function(w,f){w=Y(w);for(var l=S.objectStore(g),m=b.length,A=new Array(m),x=0,O=0,T,j=function(B){var q=B.target;(A[q._pos]=q.result)!=null,++O===x&&w(A)},V=he(f),N=0;N<m;++N){var G=b[N];G!=null&&(T=l.get(b[N]),T._pos=N,T.onsuccess=j,T.onerror=V,++x)}x===0&&w(A)})},get:function(c){var S=c.trans,b=c.key;return new Promise(function(w,f){w=Y(w);var l=S.objectStore(g),m=l.get(b);m.onsuccess=function(A){return w(A.target.result)},m.onerror=he(f)})},query:p(s),openCursor:d,count:function(c){var S=c.query,b=c.trans,w=S.index,f=S.range;return new Promise(function(l,m){var A=b.objectStore(g),x=w.isPrimaryKey?A:A.index(w.name),O=i(f),T=O?x.count(O):x.count();T.onsuccess=Y(function(j){return l(j.target.result)}),T.onerror=he(m)})}}}var u=r(e,n),a=u.schema,s=u.hasGetAll,h=a.tables.map(function(v){return o(v)}),y={};return h.forEach(function(v){return y[v.name]=v}),{stack:"dbcore",transaction:e.transaction.bind(e),table:function(v){var g=y[v];if(!g)throw new Error("Table '"+v+"' not found");return y[v]},MIN_KEY:-1/0,MAX_KEY:ut(t),schema:a}}function Qi(e,t){return t.reduce(function(n,r){var i=r.create;return L(L({},n),i(n))},e)}function Xi(e,t,n,r){var i=n.IDBKeyRange;n.indexedDB;var o=Qi(Gi(t,i,r),e.dbcore);return{dbcore:o}}function Bn(e,t){var n=e._novip,r=t.db,i=Xi(n._middlewares,r,n._deps,t);n.core=i.dbcore,n.tables.forEach(function(o){var u=o.name;n.core.schema.tables.some(function(a){return a.name===u})&&(o.core=n.core.table(u),n[u]instanceof n.Table&&(n[u].core=o.core))})}function Pt(e,t,n,r){var i=e._novip;n.forEach(function(o){var u=r[o];t.forEach(function(a){var s=Tn(a,o);(!s||"value"in s&&s.value===void 0)&&(a===i.Transaction.prototype||a instanceof i.Transaction?_e(a,o,{get:function(){return this.table(o)},set:function(h){lr(this,o,{value:h,writable:!0,configurable:!0,enumerable:!0})}}):a[o]=new i.Table(o,u))})})}function gn(e,t){var n=e._novip;t.forEach(function(r){for(var i in r)r[i]instanceof n.Table&&delete r[i]})}function Zi(e,t){return e._cfg.version-t._cfg.version}function eo(e,t,n,r){var i=e._dbSchema,o=e._createTransaction("readwrite",e._storeNames,i);o.create(n),o._completion.catch(r);var u=o._reject.bind(o),a=k.transless||k;Ae(function(){k.trans=o,k.transless=a,t===0?(Q(i).forEach(function(s){Mn(n,s,i[s].primKey,i[s].indexes)}),Bn(e,n),C.follow(function(){return e.on.populate.fire(o)}).catch(u)):to(e,t,o,n).catch(u)})}function to(e,t,n,r){var i=e._novip,o=[],u=i._versions,a=i._dbSchema=Fn(i,i.idbdb,r),s=!1,h=u.filter(function(v){return v._cfg.version>=t});h.forEach(function(v){o.push(function(){var g=a,_=v._cfg.dbschema;bn(i,g,r),bn(i,_,r),a=i._dbSchema=_;var d=Mr(g,_);d.add.forEach(function(f){Mn(r,f[0],f[1].primKey,f[1].indexes)}),d.change.forEach(function(f){if(f.recreate)throw new I.Upgrade("Not yet support for changing primary key");var l=r.objectStore(f.name);f.add.forEach(function(m){return mn(l,m)}),f.change.forEach(function(m){l.deleteIndex(m.name),mn(l,m)}),f.del.forEach(function(m){return l.deleteIndex(m)})});var p=v._cfg.contentUpgrade;if(p&&v._cfg.version>t){Bn(i,r),n._memoizedTables={},s=!0;var c=dr(_);d.del.forEach(function(f){c[f]=g[f]}),gn(i,[i.Transaction.prototype]),Pt(i,[i.Transaction.prototype],Q(c),c),n.schema=c;var S=On(p);S&&We();var b,w=C.follow(function(){if(b=p(n),b&&S){var f=we.bind(null,null);b.then(f,f)}});return b&&typeof b.then=="function"?C.resolve(b):w.then(function(){return b})}}),o.push(function(g){if(!s||!Ri){var _=v._cfg.dbschema;ro(_,g)}gn(i,[i.Transaction.prototype]),Pt(i,[i.Transaction.prototype],i._storeNames,i._dbSchema),n.schema=i._dbSchema})});function y(){return o.length?C.resolve(o.shift()(n.idbtrans)).then(y):C.resolve()}return y().then(function(){no(a,r)})}function Mr(e,t){var n={del:[],add:[],change:[]},r;for(r in e)t[r]||n.del.push(r);for(r in t){var i=e[r],o=t[r];if(!i)n.add.push([r,o]);else{var u={name:r,def:o,recreate:!1,del:[],add:[],change:[]};if(""+(i.primKey.keyPath||"")!=""+(o.primKey.keyPath||"")||i.primKey.auto!==o.primKey.auto&&!Lt)u.recreate=!0,n.change.push(u);else{var a=i.idxByName,s=o.idxByName,h=void 0;for(h in a)s[h]||u.del.push(h);for(h in s){var y=a[h],v=s[h];y?y.src!==v.src&&u.change.push(v):u.add.push(v)}(u.del.length>0||u.add.length>0||u.change.length>0)&&n.change.push(u)}}}return n}function Mn(e,t,n,r){var i=e.db.createObjectStore(t,n.keyPath?{keyPath:n.keyPath,autoIncrement:n.auto}:{autoIncrement:n.auto});return r.forEach(function(o){return mn(i,o)}),i}function no(e,t){Q(e).forEach(function(n){t.db.objectStoreNames.contains(n)||Mn(t,n,e[n].primKey,e[n].indexes)})}function ro(e,t){[].slice.call(t.db.objectStoreNames).forEach(function(n){return e[n]==null&&t.db.deleteObjectStore(n)})}function mn(e,t){e.createIndex(t.name,t.keyPath,{unique:t.unique,multiEntry:t.multi})}function Fn(e,t,n){var r={},i=jt(t.objectStoreNames,0);return i.forEach(function(o){for(var u=n.objectStore(o),a=u.keyPath,s=yn(Pr(a),a||"",!1,!1,!!u.autoIncrement,a&&typeof a!="string",!0),h=[],y=0;y<u.indexNames.length;++y){var v=u.index(u.indexNames[y]);a=v.keyPath;var g=yn(v.name,a,!!v.unique,!!v.multiEntry,!1,a&&typeof a!="string",!1);h.push(g)}r[o]=Br(o,s,h)}),r}function io(e,t,n){var r=e._novip;r.verno=t.version/10;var i=r._dbSchema=Fn(r,t,n);r._storeNames=jt(t.objectStoreNames,0),Pt(r,[r._allTables],Q(i),i)}function oo(e,t){var n=Fn(e,e.idbdb,t),r=Mr(n,e._dbSchema);return!(r.add.length||r.change.some(function(i){return i.add.length||i.change.length}))}function bn(e,t,n){for(var r=e._novip,i=n.db.objectStoreNames,o=0;o<i.length;++o){var u=i[o],a=n.objectStore(u);r._hasGetAll="getAll"in a;for(var s=0;s<a.indexNames.length;++s){var h=a.indexNames[s],y=a.index(h).keyPath,v=typeof y=="string"?y:"["+jt(y).join("+")+"]";if(t[u]){var g=t[u].idxByName[v];g&&(g.name=h,delete t[u].idxByName[v],t[u].idxByName[h]=g)}}}typeof navigator<"u"&&/Safari/.test(navigator.userAgent)&&!/(Chrome\/|Edge\/)/.test(navigator.userAgent)&&J.WorkerGlobalScope&&J instanceof J.WorkerGlobalScope&&[].concat(navigator.userAgent.match(/Safari\/(\d*)/))[1]<604&&(r._hasGetAll=!1)}function uo(e){return e.split(",").map(function(t,n){t=t.trim();var r=t.replace(/([&*]|\+\+)/g,""),i=/^\[/.test(r)?r.match(/^\[(.*)\]$/)[1].split("+"):r;return yn(r,i||null,/\&/.test(t),/\*/.test(t),/\+\+/.test(t),ne(i),n===0)})}var ao=function(){function e(){}return e.prototype._parseStoresSpec=function(t,n){Q(t).forEach(function(r){if(t[r]!==null){var i=uo(t[r]),o=i.shift();if(o.multi)throw new I.Schema("Primary key cannot be multi-valued");i.forEach(function(u){if(u.auto)throw new I.Schema("Only primary key can be marked as autoIncrement (++)");if(!u.keyPath)throw new I.Schema("Index must have a name and cannot be an empty string")}),n[r]=Br(r,o,i)}})},e.prototype.stores=function(t){var n=this.db;this._cfg.storesSource=this._cfg.storesSource?ie(this._cfg.storesSource,t):t;var r=n._versions,i={},o={};return r.forEach(function(u){ie(i,u._cfg.storesSource),o=u._cfg.dbschema={},u._parseStoresSpec(i,o)}),n._dbSchema=o,gn(n,[n._allTables,n,n.Transaction.prototype]),Pt(n,[n._allTables,n,n.Transaction.prototype,this._cfg.tables],Q(o),o),n._storeNames=Q(o),this},e.prototype.upgrade=function(t){return this._cfg.contentUpgrade=Rn(this._cfg.contentUpgrade||W,t),this},e}();function so(e){return dt(ao.prototype,function(n){this.db=e,this._cfg={version:n,storesSource:null,dbschema:{},tables:{},contentUpgrade:null}})}function $n(e,t){var n=e._dbNamesDB;return n||(n=e._dbNamesDB=new Vn(Vt,{addons:[],indexedDB:e,IDBKeyRange:t}),n.version(1).stores({dbnames:"name"})),n.table("dbnames")}function jn(e){return e&&typeof e.databases=="function"}function lo(e){var t=e.indexedDB,n=e.IDBKeyRange;return jn(t)?Promise.resolve(t.databases()).then(function(r){return r.map(function(i){return i.name}).filter(function(i){return i!==Vt})}):$n(t,n).toCollection().primaryKeys()}function fo(e,t){var n=e.indexedDB,r=e.IDBKeyRange;!jn(n)&&t!==Vt&&$n(n,r).put({name:t}).catch(W)}function co(e,t){var n=e.indexedDB,r=e.IDBKeyRange;!jn(n)&&t!==Vt&&$n(n,r).delete(t).catch(W)}function _n(e){return Ae(function(){return k.letThrough=!0,e()})}function ho(){var e=!navigator.userAgentData&&/Safari\//.test(navigator.userAgent)&&!/Chrom(e|ium)\//.test(navigator.userAgent);if(!e||!indexedDB.databases)return Promise.resolve();var t;return new Promise(function(n){var r=function(){return indexedDB.databases().finally(n)};t=setInterval(r,100),r()}).finally(function(){return clearInterval(t)})}function po(e){var t=e._state,n=e._deps.indexedDB;if(t.isBeingOpened||e.idbdb)return t.dbReadyPromise.then(function(){return t.dbOpenError?X(t.dbOpenError):e});pe&&(t.openCanceller._stackHolder=Be()),t.isBeingOpened=!0,t.dbOpenError=null,t.openComplete=!1;var r=t.openCanceller;function i(){if(t.openCanceller!==r)throw new I.DatabaseClosed("db.open() was cancelled")}var o=t.dbReadyResolve,u=null,a=!1;return C.race([r,(typeof navigator>"u"?C.resolve():ho()).then(function(){return new C(function(s,h){if(i(),!n)throw new I.MissingAPI;var y=e.name,v=t.autoSchema?n.open(y):n.open(y,Math.round(e.verno*10));if(!v)throw new I.MissingAPI;v.onerror=he(h),v.onblocked=Y(e._fireOnBlocked),v.onupgradeneeded=Y(function(g){if(u=v.transaction,t.autoSchema&&!e._options.allowEmptyDB){v.onerror=it,u.abort(),v.result.close();var _=n.deleteDatabase(y);_.onsuccess=_.onerror=Y(function(){h(new I.NoSuchDatabase("Database "+y+" doesnt exist"))})}else{u.onerror=he(h);var d=g.oldVersion>Math.pow(2,62)?0:g.oldVersion;a=d<1,e._novip.idbdb=v.result,eo(e,d/10,u,h)}},h),v.onsuccess=Y(function(){u=null;var g=e._novip.idbdb=v.result,_=jt(g.objectStoreNames);if(_.length>0)try{var d=g.transaction(Hi(_),"readonly");t.autoSchema?io(e,g,d):(bn(e,e._dbSchema,d),oo(e,d)||console.warn("Dexie SchemaDiff: Schema was extended without increasing the number passed to db.version(). Some queries may fail.")),Bn(e,d)}catch{}Ze.push(e),g.onversionchange=Y(function(p){t.vcFired=!0,e.on("versionchange").fire(p)}),g.onclose=Y(function(p){e.on("close").fire(p)}),a&&fo(e._deps,y),s()},h)})})]).then(function(){return i(),t.onReadyBeingFired=[],C.resolve(_n(function(){return e.on.ready.fire(e.vip)})).then(function s(){if(t.onReadyBeingFired.length>0){var h=t.onReadyBeingFired.reduce(Rn,W);return t.onReadyBeingFired=[],C.resolve(_n(function(){return h(e.vip)})).then(s)}})}).finally(function(){t.onReadyBeingFired=null,t.isBeingOpened=!1}).then(function(){return e}).catch(function(s){t.dbOpenError=s;try{u&&u.abort()}catch{}return r===t.openCanceller&&e._close(),X(s)}).finally(function(){t.openComplete=!0,o()})}function wn(e){var t=function(u){return e.next(u)},n=function(u){return e.throw(u)},r=o(t),i=o(n);function o(u){return function(a){var s=u(a),h=s.value;return s.done?h:!h||typeof h.then!="function"?ne(h)?Promise.all(h).then(r,i):r(h):h.then(r,i)}}return o(t)()}function yo(e,t,n){var r=arguments.length;if(r<2)throw new I.InvalidArgument("Too few arguments");for(var i=new Array(r-1);--r;)i[r-1]=arguments[r];n=i.pop();var o=pr(i);return[e,o,n]}function Fr(e,t,n,r,i){return C.resolve().then(function(){var o=k.transless||k,u=e._createTransaction(t,n,e._dbSchema,r),a={trans:u,transless:o};if(r)u.idbtrans=r.idbtrans;else try{u.create(),e._state.PR1398_maxLoop=3}catch(v){return v.name===Kn.InvalidState&&e.isOpen()&&--e._state.PR1398_maxLoop>0?(console.warn("Dexie: Need to reopen db"),e._close(),e.open().then(function(){return Fr(e,t,n,null,i)})):X(v)}var s=On(i);s&&We();var h,y=C.follow(function(){if(h=i.call(u,u),h)if(s){var v=we.bind(null,null);h.then(v,v)}else typeof h.next=="function"&&typeof h.throw=="function"&&(h=wn(h))},a);return(h&&typeof h.then=="function"?C.resolve(h).then(function(v){return u.active?v:X(new I.PrematureCommit("Transaction committed too early. See http://bit.ly/2kdckMn"))}):y.then(function(){return h})).then(function(v){return r&&u._resolve(),u._completion.then(function(){return v})}).catch(function(v){return u._reject(v),X(v)})})}function _t(e,t,n){for(var r=ne(e)?e.slice():[e],i=0;i<n;++i)r.push(t);return r}function vo(e){return L(L({},e),{table:function(t){var n=e.table(t),r=n.schema,i={},o=[];function u(p,c,S){var b=et(p),w=i[b]=i[b]||[],f=p==null?0:typeof p=="string"?1:p.length,l=c>0,m=L(L({},S),{isVirtual:l,keyTail:c,keyLength:f,extractKey:vn(p),unique:!l&&S.unique});if(w.push(m),m.isPrimaryKey||o.push(m),f>1){var A=f===2?p[0]:p.slice(0,f-1);u(A,c+1,S)}return w.sort(function(x,O){return x.keyTail-O.keyTail}),m}var a=u(r.primaryKey.keyPath,0,r.primaryKey);i[":id"]=[a];for(var s=0,h=r.indexes;s<h.length;s++){var y=h[s];u(y.keyPath,0,y)}function v(p){var c=i[et(p)];return c&&c[0]}function g(p,c){return{type:p.type===1?2:p.type,lower:_t(p.lower,p.lowerOpen?e.MAX_KEY:e.MIN_KEY,c),lowerOpen:!0,upper:_t(p.upper,p.upperOpen?e.MIN_KEY:e.MAX_KEY,c),upperOpen:!0}}function _(p){var c=p.query.index;return c.isVirtual?L(L({},p),{query:{index:c,range:g(p.query.range,c.keyTail)}}):p}var d=L(L({},n),{schema:L(L({},r),{primaryKey:a,indexes:o,getIndexByKeyPath:v}),count:function(p){return n.count(_(p))},query:function(p){return n.query(_(p))},openCursor:function(p){var c=p.query.index,S=c.keyTail,b=c.isVirtual,w=c.keyLength;if(!b)return n.openCursor(p);function f(l){function m(x){x!=null?l.continue(_t(x,p.reverse?e.MAX_KEY:e.MIN_KEY,S)):p.unique?l.continue(l.key.slice(0,w).concat(p.reverse?e.MIN_KEY:e.MAX_KEY,S)):l.continue()}var A=Object.create(l,{continue:{value:m},continuePrimaryKey:{value:function(x,O){l.continuePrimaryKey(_t(x,e.MAX_KEY,S),O)}},primaryKey:{get:function(){return l.primaryKey}},key:{get:function(){var x=l.key;return w===1?x[0]:x.slice(0,w)}},value:{get:function(){return l.value}}});return A}return n.openCursor(_(p)).then(function(l){return l&&f(l)})}});return d}})}var go={stack:"dbcore",name:"VirtualIndexMiddleware",level:1,create:vo};function Nn(e,t,n,r){return n=n||{},r=r||"",Q(e).forEach(function(i){if(!ae(t,i))n[r+i]=void 0;else{var o=e[i],u=t[i];if(typeof o=="object"&&typeof u=="object"&&o&&u){var a=tn(o),s=tn(u);a!==s?n[r+i]=t[i]:a==="Object"?Nn(o,u,n,r+i+"."):o!==u&&(n[r+i]=t[i])}else o!==u&&(n[r+i]=t[i])}}),Q(t).forEach(function(i){ae(e,i)||(n[r+i]=t[i])}),n}function mo(e,t){return t.type==="delete"?t.keys:t.keys||t.values.map(e.extractKey)}var bo={stack:"dbcore",name:"HooksMiddleware",level:2,create:function(e){return L(L({},e),{table:function(t){var n=e.table(t),r=n.schema.primaryKey,i=L(L({},n),{mutate:function(o){var u=k.trans,a=u.table(t).hook,s=a.deleting,h=a.creating,y=a.updating;switch(o.type){case"add":if(h.fire===W)break;return u._promise("readwrite",function(){return v(o)},!0);case"put":if(h.fire===W&&y.fire===W)break;return u._promise("readwrite",function(){return v(o)},!0);case"delete":if(s.fire===W)break;return u._promise("readwrite",function(){return v(o)},!0);case"deleteRange":if(s.fire===W)break;return u._promise("readwrite",function(){return g(o)},!0)}return n.mutate(o);function v(d){var p=k.trans,c=d.keys||mo(r,d);if(!c)throw new Error("Keys missing");return d=d.type==="add"||d.type==="put"?L(L({},d),{keys:c}):L({},d),d.type!=="delete"&&(d.values=Zt([],d.values,!0)),d.keys&&(d.keys=Zt([],d.keys,!0)),_o(n,d,c).then(function(S){var b=c.map(function(w,f){var l=S[f],m={onerror:null,onsuccess:null};if(d.type==="delete")s.fire.call(m,w,l,p);else if(d.type==="add"||l===void 0){var A=h.fire.call(m,w,d.values[f],p);w==null&&A!=null&&(w=A,d.keys[f]=w,r.outbound||le(d.values[f],r.keyPath,w))}else{var x=Nn(l,d.values[f]),O=y.fire.call(m,x,w,l,p);if(O){var T=d.values[f];Object.keys(O).forEach(function(j){ae(T,j)?T[j]=O[j]:le(T,j,O[j])})}}return m});return n.mutate(d).then(function(w){for(var f=w.failures,l=w.results,m=w.numFailures,A=w.lastResult,x=0;x<c.length;++x){var O=l?l[x]:c[x],T=b[x];O==null?T.onerror&&T.onerror(f[x]):T.onsuccess&&T.onsuccess(d.type==="put"&&S[x]?d.values[x]:O)}return{failures:f,results:l,numFailures:m,lastResult:A}}).catch(function(w){return b.forEach(function(f){return f.onerror&&f.onerror(w)}),Promise.reject(w)})})}function g(d){return _(d.trans,d.range,1e4)}function _(d,p,c){return n.query({trans:d,values:!1,query:{index:r,range:p},limit:c}).then(function(S){var b=S.result;return v({type:"delete",keys:b,trans:d}).then(function(w){return w.numFailures>0?Promise.reject(w.failures[0]):b.length<c?{failures:[],numFailures:0,lastResult:void 0}:_(d,L(L({},p),{lower:b[b.length-1],lowerOpen:!0}),c)})})}}});return i}})}};function _o(e,t,n){return t.type==="add"?Promise.resolve([]):e.getMany({trans:t.trans,keys:n,cache:"immutable"})}function $r(e,t,n){try{if(!t||t.keys.length<e.length)return null;for(var r=[],i=0,o=0;i<t.keys.length&&o<e.length;++i)re(t.keys[i],e[o])===0&&(r.push(n?st(t.values[i]):t.values[i]),++o);return r.length===e.length?r:null}catch{return null}}var wo={stack:"dbcore",level:-1,create:function(e){return{table:function(t){var n=e.table(t);return L(L({},n),{getMany:function(r){if(!r.cache)return n.getMany(r);var i=$r(r.keys,r.trans._cache,r.cache==="clone");return i?C.resolve(i):n.getMany(r).then(function(o){return r.trans._cache={keys:r.keys,values:r.cache==="clone"?st(o):o},o})},mutate:function(r){return r.type!=="add"&&(r.trans._cache=null),n.mutate(r)}})}}}},Yt;function Ln(e){return!("from"in e)}var ve=function(e,t){if(this)ie(this,arguments.length?{d:1,from:e,to:arguments.length>1?t:e}:{d:0});else{var n=new ve;return e&&"d"in e&&ie(n,e),n}};Ve(ve.prototype,(Yt={add:function(e){return Bt(this,e),this},addKey:function(e){return at(this,e,e),this},addKeys:function(e){var t=this;return e.forEach(function(n){return at(t,n,n)}),this}},Yt[nn]=function(){return En(this)},Yt));function at(e,t,n){var r=re(t,n);if(!isNaN(r)){if(r>0)throw RangeError();if(Ln(e))return ie(e,{from:t,to:n,d:1});var i=e.l,o=e.r;if(re(n,e.from)<0)return i?at(i,t,n):e.l={from:t,to:n,d:1,l:null,r:null},nr(e);if(re(t,e.to)>0)return o?at(o,t,n):e.r={from:t,to:n,d:1,l:null,r:null},nr(e);re(t,e.from)<0&&(e.from=t,e.l=null,e.d=o?o.d+1:1),re(n,e.to)>0&&(e.to=n,e.r=null,e.d=e.l?e.l.d+1:1);var u=!e.r;i&&!e.l&&Bt(e,i),o&&u&&Bt(e,o)}}function Bt(e,t){function n(r,i){var o=i.from,u=i.to,a=i.l,s=i.r;at(r,o,u),a&&n(r,a),s&&n(r,s)}Ln(t)||n(e,t)}function Eo(e,t){var n=En(t),r=n.next();if(r.done)return!1;for(var i=r.value,o=En(e),u=o.next(i.from),a=u.value;!r.done&&!u.done;){if(re(a.from,i.to)<=0&&re(a.to,i.from)>=0)return!0;re(i.from,a.from)<0?i=(r=n.next(a.from)).value:a=(u=o.next(i.from)).value}return!1}function En(e){var t=Ln(e)?null:{s:0,n:e};return{next:function(n){for(var r=arguments.length>0;t;)switch(t.s){case 0:if(t.s=1,r)for(;t.n.l&&re(n,t.n.from)<0;)t={up:t,n:t.n.l,s:1};else for(;t.n.l;)t={up:t,n:t.n.l,s:1};case 1:if(t.s=2,!r||re(n,t.n.to)<=0)return{value:t.n,done:!1};case 2:if(t.n.r){t.s=3,t={up:t,n:t.n.r,s:0};continue}case 3:t=t.up}return{done:!0}}}}function nr(e){var t,n,r=(((t=e.r)===null||t===void 0?void 0:t.d)||0)-(((n=e.l)===null||n===void 0?void 0:n.d)||0),i=r>1?"r":r<-1?"l":"";if(i){var o=i==="r"?"l":"r",u=L({},e),a=e[i];e.from=a.from,e.to=a.to,e[i]=a[i],u[i]=a[o],e[o]=u,u.d=rr(u)}e.d=rr(e)}function rr(e){var t=e.r,n=e.l;return(t?n?Math.max(t.d,n.d):t.d:n?n.d:0)+1}var So={stack:"dbcore",level:0,create:function(e){var t=e.schema.name,n=new ve(e.MIN_KEY,e.MAX_KEY);return L(L({},e),{table:function(r){var i=e.table(r),o=i.schema,u=o.primaryKey,a=u.extractKey,s=u.outbound,h=L(L({},i),{mutate:function(g){var _=g.trans,d=_.mutatedParts||(_.mutatedParts={}),p=function(A){var x="idb://"+t+"/"+r+"/"+A;return d[x]||(d[x]=new ve)},c=p(""),S=p(":dels"),b=g.type,w=g.type==="deleteRange"?[g.range]:g.type==="delete"?[g.keys]:g.values.length<50?[[],g.values]:[],f=w[0],l=w[1],m=g.trans._cache;return i.mutate(g).then(function(A){if(ne(f)){b!=="delete"&&(f=A.results),c.addKeys(f);var x=$r(f,m);!x&&b!=="add"&&S.addKeys(f),(x||l)&&xo(p,o,x,l)}else if(f){var O={from:f.lower,to:f.upper};S.add(O),c.add(O)}else c.add(n),S.add(n),o.indexes.forEach(function(T){return p(T.name).add(n)});return A})}}),y=function(g){var _,d,p=g.query,c=p.index,S=p.range;return[c,new ve((_=S.lower)!==null&&_!==void 0?_:e.MIN_KEY,(d=S.upper)!==null&&d!==void 0?d:e.MAX_KEY)]},v={get:function(g){return[u,new ve(g.key)]},getMany:function(g){return[u,new ve().addKeys(g.keys)]},count:y,query:y,openCursor:y};return Q(v).forEach(function(g){h[g]=function(_){var d=k.subscr;if(d){var p=function(m){var A="idb://"+t+"/"+r+"/"+m;return d[A]||(d[A]=new ve)},c=p(""),S=p(":dels"),b=v[g](_),w=b[0],f=b[1];if(p(w.name||"").add(f),!w.isPrimaryKey)if(g==="count")S.add(n);else{var l=g==="query"&&s&&_.values&&i.query(L(L({},_),{values:!1}));return i[g].apply(this,arguments).then(function(m){if(g==="query"){if(s&&_.values)return l.then(function(T){var j=T.result;return c.addKeys(j),m});var A=_.values?m.result.map(a):m.result;_.values?c.addKeys(A):S.addKeys(A)}else if(g==="openCursor"){var x=m,O=_.values;return x&&Object.create(x,{key:{get:function(){return S.addKey(x.primaryKey),x.key}},primaryKey:{get:function(){var T=x.primaryKey;return S.addKey(T),T}},value:{get:function(){return O&&c.addKey(x.primaryKey),x.value}}})}return m})}}return i[g].apply(this,arguments)}}),h}})}};function xo(e,t,n,r){function i(o){var u=e(o.name||"");function a(h){return h!=null?o.extractKey(h):null}var s=function(h){return o.multiEntry&&ne(h)?h.forEach(function(y){return u.addKey(y)}):u.addKey(h)};(n||r).forEach(function(h,y){var v=n&&a(n[y]),g=r&&a(r[y]);re(v,g)!==0&&(v!=null&&s(v),g!=null&&s(g))})}t.indexes.forEach(i)}var Vn=function(){function e(t,n){var r=this;this._middlewares={},this.verno=0;var i=e.dependencies;this._options=n=L({addons:e.addons,autoOpen:!0,indexedDB:i.indexedDB,IDBKeyRange:i.IDBKeyRange},n),this._deps={indexedDB:n.indexedDB,IDBKeyRange:n.IDBKeyRange};var o=n.addons;this._dbSchema={},this._versions=[],this._storeNames=[],this._allTables={},this.idbdb=null,this._novip=this;var u={dbOpenError:null,isBeingOpened:!1,onReadyBeingFired:null,openComplete:!1,dbReadyResolve:W,dbReadyPromise:null,cancelOpen:W,openCanceller:null,autoSchema:!0,PR1398_maxLoop:3};u.dbReadyPromise=new C(function(a){u.dbReadyResolve=a}),u.openCanceller=new C(function(a,s){u.cancelOpen=s}),this._state=u,this.name=t,this.on=ht(this,"populate","blocked","versionchange","close",{ready:[Rn,W]}),this.on.ready.subscribe=fr(this.on.ready.subscribe,function(a){return function(s,h){e.vip(function(){var y=r._state;if(y.openComplete)y.dbOpenError||C.resolve().then(s),h&&a(s);else if(y.onReadyBeingFired)y.onReadyBeingFired.push(s),h&&a(s);else{a(s);var v=r;h||a(function g(){v.on.ready.unsubscribe(s),v.on.ready.unsubscribe(g)})}})}}),this.Collection=$i(this),this.Table=Ii(this),this.Transaction=zi(this),this.Version=so(this),this.WhereClause=Ui(this),this.on("versionchange",function(a){a.newVersion>0?console.warn("Another connection wants to upgrade database '"+r.name+"'. Closing db now to resume the upgrade."):console.warn("Another connection wants to delete database '"+r.name+"'. Closing db now to resume the delete request."),r.close()}),this.on("blocked",function(a){!a.newVersion||a.newVersion<a.oldVersion?console.warn("Dexie.delete('"+r.name+"') was blocked"):console.warn("Upgrade '"+r.name+"' blocked by other connection holding version "+a.oldVersion/10)}),this._maxKey=ut(n.IDBKeyRange),this._createTransaction=function(a,s,h,y){return new r.Transaction(a,s,h,r._options.chromeTransactionDurability,y)},this._fireOnBlocked=function(a){r.on("blocked").fire(a),Ze.filter(function(s){return s.name===r.name&&s!==r&&!s._state.vcFired}).map(function(s){return s.on("versionchange").fire(a)})},this.use(go),this.use(bo),this.use(So),this.use(wo),this.vip=Object.create(this,{_vip:{value:!0}}),o.forEach(function(a){return a(r)})}return e.prototype.version=function(t){if(isNaN(t)||t<.1)throw new I.Type("Given version is not a positive number");if(t=Math.round(t*10)/10,this.idbdb||this._state.isBeingOpened)throw new I.Schema("Cannot add version when database is open");this.verno=Math.max(this.verno,t);var n=this._versions,r=n.filter(function(i){return i._cfg.version===t})[0];return r||(r=new this.Version(t),n.push(r),n.sort(Zi),r.stores({}),this._state.autoSchema=!1,r)},e.prototype._whenReady=function(t){var n=this;return this.idbdb&&(this._state.openComplete||k.letThrough||this._vip)?t():new C(function(r,i){if(n._state.openComplete)return i(new I.DatabaseClosed(n._state.dbOpenError));if(!n._state.isBeingOpened){if(!n._options.autoOpen){i(new I.DatabaseClosed);return}n.open().catch(W)}n._state.dbReadyPromise.then(r,i)}).then(t)},e.prototype.use=function(t){var n=t.stack,r=t.create,i=t.level,o=t.name;o&&this.unuse({stack:n,name:o});var u=this._middlewares[n]||(this._middlewares[n]=[]);return u.push({stack:n,create:r,level:i??10,name:o}),u.sort(function(a,s){return a.level-s.level}),this},e.prototype.unuse=function(t){var n=t.stack,r=t.name,i=t.create;return n&&this._middlewares[n]&&(this._middlewares[n]=this._middlewares[n].filter(function(o){return i?o.create!==i:r?o.name!==r:!1})),this},e.prototype.open=function(){return po(this)},e.prototype._close=function(){var t=this._state,n=Ze.indexOf(this);if(n>=0&&Ze.splice(n,1),this.idbdb){try{this.idbdb.close()}catch{}this._novip.idbdb=null}t.dbReadyPromise=new C(function(r){t.dbReadyResolve=r}),t.openCanceller=new C(function(r,i){t.cancelOpen=i})},e.prototype.close=function(){this._close();var t=this._state;this._options.autoOpen=!1,t.dbOpenError=new I.DatabaseClosed,t.isBeingOpened&&t.cancelOpen(t.dbOpenError)},e.prototype.delete=function(){var t=this,n=arguments.length>0,r=this._state;return new C(function(i,o){var u=function(){t.close();var a=t._deps.indexedDB.deleteDatabase(t.name);a.onsuccess=Y(function(){co(t._deps,t.name),i()}),a.onerror=he(o),a.onblocked=t._fireOnBlocked};if(n)throw new I.InvalidArgument("Arguments not allowed in db.delete()");r.isBeingOpened?r.dbReadyPromise.then(u):u()})},e.prototype.backendDB=function(){return this.idbdb},e.prototype.isOpen=function(){return this.idbdb!==null},e.prototype.hasBeenClosed=function(){var t=this._state.dbOpenError;return t&&t.name==="DatabaseClosed"},e.prototype.hasFailed=function(){return this._state.dbOpenError!==null},e.prototype.dynamicallyOpened=function(){return this._state.autoSchema},Object.defineProperty(e.prototype,"tables",{get:function(){var t=this;return Q(this._allTables).map(function(n){return t._allTables[n]})},enumerable:!1,configurable:!0}),e.prototype.transaction=function(){var t=yo.apply(this,arguments);return this._transaction.apply(this,t)},e.prototype._transaction=function(t,n,r){var i=this,o=k.trans;(!o||o.db!==this||t.indexOf("!")!==-1)&&(o=null);var u=t.indexOf("?")!==-1;t=t.replace("!","").replace("?","");var a,s;try{if(s=n.map(function(y){var v=y instanceof i.Table?y.name:y;if(typeof v!="string")throw new TypeError("Invalid table argument to Dexie.transaction(). Only Table or String are allowed");return v}),t=="r"||t===Ut)a=Ut;else if(t=="rw"||t==Wt)a=Wt;else throw new I.InvalidArgument("Invalid transaction mode: "+t);if(o){if(o.mode===Ut&&a===Wt)if(u)o=null;else throw new I.SubTransaction("Cannot enter a sub-transaction with READWRITE mode when parent transaction is READONLY");o&&s.forEach(function(y){if(o&&o.storeNames.indexOf(y)===-1)if(u)o=null;else throw new I.SubTransaction("Table "+y+" not included in parent transaction.")}),u&&o&&!o.active&&(o=null)}}catch(y){return o?o._promise(null,function(v,g){g(y)}):X(y)}var h=Fr.bind(null,this,a,s,o,r);return o?o._promise(a,h,"lock"):k.trans?ze(k.transless,function(){return i._whenReady(h)}):this._whenReady(h)},e.prototype.table=function(t){if(!ae(this._allTables,t))throw new I.InvalidTable("Table "+t+" does not exist");return this._allTables[t]},e}(),Ao=typeof Symbol<"u"&&"observable"in Symbol?Symbol.observable:"@@observable",To=function(){function e(t){this._subscribe=t}return e.prototype.subscribe=function(t,n,r){return this._subscribe(!t||typeof t=="function"?{next:t,error:n,complete:r}:t)},e.prototype[Ao]=function(){return this},e}();function jr(e,t){return Q(t).forEach(function(n){var r=e[n]||(e[n]=new ve);Bt(r,t[n])}),e}function Oo(e){return new To(function(t){var n=On(e);function r(_){n&&We();var d=function(){return Ae(e,{subscr:_,trans:null})},p=k.trans?ze(k.transless,d):d();return n&&p.then(we,we),p}var i=!1,o={},u={},a={get closed(){return i},unsubscribe:function(){i=!0,Oe.storagemutated.unsubscribe(v)}};t.start&&t.start(a);var s=!1,h=!1;function y(){return Q(u).some(function(_){return o[_]&&Eo(o[_],u[_])})}var v=function(_){jr(o,_),y()&&g()},g=function(){if(!(s||i)){o={};var _={},d=r(_);h||(Oe(ot,v),h=!0),s=!0,Promise.resolve(d).then(function(p){s=!1,!i&&(y()?g():(o={},u=_,t.next&&t.next(p)))},function(p){s=!1,t.error&&t.error(p),a.unsubscribe()})}};return g(),a})}var Sn;try{Sn={indexedDB:J.indexedDB||J.mozIndexedDB||J.webkitIndexedDB||J.msIndexedDB,IDBKeyRange:J.IDBKeyRange||J.webkitIDBKeyRange}}catch{Sn={indexedDB:null,IDBKeyRange:null}}var Ce=Vn;Ve(Ce,L(L({},Nt),{delete:function(e){var t=new Ce(e,{addons:[]});return t.delete()},exists:function(e){return new Ce(e,{addons:[]}).open().then(function(t){return t.close(),!0}).catch("NoSuchDatabaseError",function(){return!1})},getDatabaseNames:function(e){try{return lo(Ce.dependencies).then(e)}catch{return X(new I.MissingAPI)}},defineClass:function(){function e(t){ie(this,t)}return e},ignoreTransaction:function(e){return k.trans?ze(k.transless,e):e()},vip:_n,async:function(e){return function(){try{var t=wn(e.apply(this,arguments));return!t||typeof t.then!="function"?C.resolve(t):t}catch(n){return X(n)}}},spawn:function(e,t,n){try{var r=wn(e.apply(n,t||[]));return!r||typeof r.then!="function"?C.resolve(r):r}catch(i){return X(i)}},currentTransaction:{get:function(){return k.trans||null}},waitFor:function(e,t){var n=C.resolve(typeof e=="function"?Ce.ignoreTransaction(e):e).timeout(t||6e4);return k.trans?k.trans.waitFor(n):n},Promise:C,debug:{get:function(){return pe},set:function(e){vr(e,e==="dexie"?function(){return!0}:Rr)}},derive:qe,extend:ie,props:Ve,override:fr,Events:ht,on:Oe,liveQuery:Oo,extendObservabilitySet:jr,getByKeyPath:be,setByKeyPath:le,delByKeyPath:ii,shallowClone:dr,deepClone:st,getObjectDiff:Nn,cmp:re,asap:cr,minKey:pn,addons:[],connections:Ze,errnames:Kn,dependencies:Sn,semVer:Gn,version:Gn.split(".").map(function(e){return parseInt(e)}).reduce(function(e,t,n){return e+t/Math.pow(10,n*2)})}));Ce.maxKey=ut(Ce.dependencies.IDBKeyRange);typeof dispatchEvent<"u"&&typeof addEventListener<"u"&&(Oe(ot,function(e){if(!me){var t;Lt?(t=document.createEvent("CustomEvent"),t.initCustomEvent(xe,!0,!0,e)):t=new CustomEvent(xe,{detail:e}),me=!0,dispatchEvent(t),me=!1}}),addEventListener(xe,function(e){var t=e.detail;me||Mt(t)}));function Mt(e){var t=me;try{me=!0,Oe.storagemutated.fire(e)}finally{me=t}}var me=!1;if(typeof BroadcastChannel<"u"){var ir=new BroadcastChannel(xe);Oe(ot,function(e){me||ir.postMessage(e)}),ir.onmessage=function(e){e.data&&Mt(e.data)}}else if(typeof self<"u"&&typeof navigator<"u"){Oe(ot,function(e){try{me||(typeof localStorage<"u"&&localStorage.setItem(xe,JSON.stringify({trig:Math.random(),changedParts:e})),typeof self.clients=="object"&&Zt([],self.clients.matchAll({includeUncontrolled:!0}),!0).forEach(function(t){return t.postMessage({type:xe,changedParts:e})}))}catch{}}),typeof addEventListener<"u"&&addEventListener("storage",function(e){if(e.key===xe){var t=JSON.parse(e.newValue);t&&Mt(t.changedParts)}});var or=self.document&&navigator.serviceWorker;or&&or.addEventListener("message",Co)}function Co(e){var t=e.data;t&&t.type===xe&&Mt(t.changedParts)}C.rejectionMapper=di;vr(pe,Rr);var Ft={},Ko={get exports(){return Ft},set exports(e){Ft=e}};(function(e,t){const{hasOwnProperty:n}=Object.prototype,r=w();r.configure=w,r.stringify=r,r.default=r,t.stringify=r,t.configure=w,e.exports=r;const i=/[\u0000-\u001f\u0022\u005c\ud800-\udfff]|[\ud800-\udbff](?![\udc00-\udfff])|(?:[^\ud800-\udbff]|^)[\udc00-\udfff]/,o=new RegExp(i,"g"),u=["\\u0000","\\u0001","\\u0002","\\u0003","\\u0004","\\u0005","\\u0006","\\u0007","\\b","\\t","\\n","\\u000b","\\f","\\r","\\u000e","\\u000f","\\u0010","\\u0011","\\u0012","\\u0013","\\u0014","\\u0015","\\u0016","\\u0017","\\u0018","\\u0019","\\u001a","\\u001b","\\u001c","\\u001d","\\u001e","\\u001f","","",'\\"',"","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","\\\\"];function a(f){if(f.length===2){const m=f.charCodeAt(1);return`${f[0]}\\u${m.toString(16)}`}const l=f.charCodeAt(0);return u.length>l?u[l]:`\\u${l.toString(16)}`}function s(f){if(f.length<5e3&&!i.test(f))return f;if(f.length>100)return f.replace(o,a);let l="",m=0;for(let A=0;A<f.length;A++){const x=f.charCodeAt(A);if(x===34||x===92||x<32)l+=`${f.slice(m,A)}${u[x]}`,m=A+1;else if(x>=55296&&x<=57343){if(x<=56319&&A+1<f.length){const O=f.charCodeAt(A+1);if(O>=56320&&O<=57343){A++;continue}}l+=`${f.slice(m,A)}\\u${x.toString(16)}`,m=A+1}}return l+=f.slice(m),l}function h(f){if(f.length>200)return f.sort();for(let l=1;l<f.length;l++){const m=f[l];let A=l;for(;A!==0&&f[A-1]>m;)f[A]=f[A-1],A--;f[A]=m}return f}const y=Object.getOwnPropertyDescriptor(Object.getPrototypeOf(Object.getPrototypeOf(new Int8Array)),Symbol.toStringTag).get;function v(f){return y.call(f)!==void 0&&f.length!==0}function g(f,l,m){f.length<m&&(m=f.length);const A=l===","?"":" ";let x=`"0":${A}${f[0]}`;for(let O=1;O<m;O++)x+=`${l}"${O}":${A}${f[O]}`;return x}function _(f){if(n.call(f,"circularValue")){const l=f.circularValue;if(typeof l=="string")return`"${l}"`;if(l==null)return l;if(l===Error||l===TypeError)return{toString(){throw new TypeError("Converting circular structure to JSON")}};throw new TypeError('The "circularValue" argument must be of type string or the value null or undefined')}return'"[Circular]"'}function d(f,l){let m;if(n.call(f,l)&&(m=f[l],typeof m!="boolean"))throw new TypeError(`The "${l}" argument must be of type boolean`);return m===void 0?!0:m}function p(f,l){let m;if(n.call(f,l)){if(m=f[l],typeof m!="number")throw new TypeError(`The "${l}" argument must be of type number`);if(!Number.isInteger(m))throw new TypeError(`The "${l}" argument must be an integer`);if(m<1)throw new RangeError(`The "${l}" argument must be >= 1`)}return m===void 0?1/0:m}function c(f){return f===1?"1 item":`${f} items`}function S(f){const l=new Set;for(const m of f)(typeof m=="string"||typeof m=="number")&&l.add(String(m));return l}function b(f){if(n.call(f,"strict")){const l=f.strict;if(typeof l!="boolean")throw new TypeError('The "strict" argument must be of type boolean');if(l)return m=>{let A=`Object can not safely be stringified. Received type ${typeof m}`;throw typeof m!="function"&&(A+=` (${m.toString()})`),new Error(A)}}}function w(f){f={...f};const l=b(f);l&&(f.bigint===void 0&&(f.bigint=!1),"circularValue"in f||(f.circularValue=Error));const m=_(f),A=d(f,"bigint"),x=d(f,"deterministic"),O=p(f,"maximumDepth"),T=p(f,"maximumBreadth");function j(q,E,K,P,D,$){let R=E[q];switch(typeof R=="object"&&R!==null&&typeof R.toJSON=="function"&&(R=R.toJSON(q)),R=P.call(E,q,R),typeof R){case"string":return`"${s(R)}"`;case"object":{if(R===null)return"null";if(K.indexOf(R)!==-1)return m;let M="",F=",";const U=$;if(Array.isArray(R)){if(R.length===0)return"[]";if(O<K.length+1)return'"[Array]"';K.push(R),D!==""&&($+=D,M+=`
${$}`,F=`,
${$}`);const oe=Math.min(R.length,T);let fe=0;for(;fe<oe-1;fe++){const yt=j(fe,R,K,P,D,$);M+=yt!==void 0?yt:"null",M+=F}const ce=j(fe,R,K,P,D,$);if(M+=ce!==void 0?ce:"null",R.length-1>T){const yt=R.length-T-1;M+=`${F}"... ${c(yt)} not stringified"`}return D!==""&&(M+=`
${U}`),K.pop(),`[${M}]`}let H=Object.keys(R);const Z=H.length;if(Z===0)return"{}";if(O<K.length+1)return'"[Object]"';let z="",ee="";D!==""&&($+=D,F=`,
${$}`,z=" ");let se=Math.min(Z,T);v(R)&&(M+=g(R,F,T),H=H.slice(R.length),se-=R.length,ee=F),x&&(H=h(H)),K.push(R);for(let oe=0;oe<se;oe++){const fe=H[oe],ce=j(fe,R,K,P,D,$);ce!==void 0&&(M+=`${ee}"${s(fe)}":${z}${ce}`,ee=F)}if(Z>T){const oe=Z-T;M+=`${ee}"...":${z}"${c(oe)} not stringified"`,ee=F}return D!==""&&ee.length>1&&(M=`
${$}${M}
${U}`),K.pop(),`{${M}}`}case"number":return isFinite(R)?String(R):l?l(R):"null";case"boolean":return R===!0?"true":"false";case"undefined":return;case"bigint":if(A)return String(R);default:return l?l(R):void 0}}function V(q,E,K,P,D,$){switch(typeof E=="object"&&E!==null&&typeof E.toJSON=="function"&&(E=E.toJSON(q)),typeof E){case"string":return`"${s(E)}"`;case"object":{if(E===null)return"null";if(K.indexOf(E)!==-1)return m;const R=$;let M="",F=",";if(Array.isArray(E)){if(E.length===0)return"[]";if(O<K.length+1)return'"[Array]"';K.push(E),D!==""&&($+=D,M+=`
${$}`,F=`,
${$}`);const Z=Math.min(E.length,T);let z=0;for(;z<Z-1;z++){const se=V(z,E[z],K,P,D,$);M+=se!==void 0?se:"null",M+=F}const ee=V(z,E[z],K,P,D,$);if(M+=ee!==void 0?ee:"null",E.length-1>T){const se=E.length-T-1;M+=`${F}"... ${c(se)} not stringified"`}return D!==""&&(M+=`
${R}`),K.pop(),`[${M}]`}K.push(E);let U="";D!==""&&($+=D,F=`,
${$}`,U=" ");let H="";for(const Z of P){const z=V(Z,E[Z],K,P,D,$);z!==void 0&&(M+=`${H}"${s(Z)}":${U}${z}`,H=F)}return D!==""&&H.length>1&&(M=`
${$}${M}
${R}`),K.pop(),`{${M}}`}case"number":return isFinite(E)?String(E):l?l(E):"null";case"boolean":return E===!0?"true":"false";case"undefined":return;case"bigint":if(A)return String(E);default:return l?l(E):void 0}}function N(q,E,K,P,D){switch(typeof E){case"string":return`"${s(E)}"`;case"object":{if(E===null)return"null";if(typeof E.toJSON=="function"){if(E=E.toJSON(q),typeof E!="object")return N(q,E,K,P,D);if(E===null)return"null"}if(K.indexOf(E)!==-1)return m;const $=D;if(Array.isArray(E)){if(E.length===0)return"[]";if(O<K.length+1)return'"[Array]"';K.push(E),D+=P;let z=`
${D}`;const ee=`,
${D}`,se=Math.min(E.length,T);let oe=0;for(;oe<se-1;oe++){const ce=N(oe,E[oe],K,P,D);z+=ce!==void 0?ce:"null",z+=ee}const fe=N(oe,E[oe],K,P,D);if(z+=fe!==void 0?fe:"null",E.length-1>T){const ce=E.length-T-1;z+=`${ee}"... ${c(ce)} not stringified"`}return z+=`
${$}`,K.pop(),`[${z}]`}let R=Object.keys(E);const M=R.length;if(M===0)return"{}";if(O<K.length+1)return'"[Object]"';D+=P;const F=`,
${D}`;let U="",H="",Z=Math.min(M,T);v(E)&&(U+=g(E,F,T),R=R.slice(E.length),Z-=E.length,H=F),x&&(R=h(R)),K.push(E);for(let z=0;z<Z;z++){const ee=R[z],se=N(ee,E[ee],K,P,D);se!==void 0&&(U+=`${H}"${s(ee)}": ${se}`,H=F)}if(M>T){const z=M-T;U+=`${H}"...": "${c(z)} not stringified"`,H=F}return H!==""&&(U=`
${D}${U}
${$}`),K.pop(),`{${U}}`}case"number":return isFinite(E)?String(E):l?l(E):"null";case"boolean":return E===!0?"true":"false";case"undefined":return;case"bigint":if(A)return String(E);default:return l?l(E):void 0}}function G(q,E,K){switch(typeof E){case"string":return`"${s(E)}"`;case"object":{if(E===null)return"null";if(typeof E.toJSON=="function"){if(E=E.toJSON(q),typeof E!="object")return G(q,E,K);if(E===null)return"null"}if(K.indexOf(E)!==-1)return m;let P="";if(Array.isArray(E)){if(E.length===0)return"[]";if(O<K.length+1)return'"[Array]"';K.push(E);const F=Math.min(E.length,T);let U=0;for(;U<F-1;U++){const Z=G(U,E[U],K);P+=Z!==void 0?Z:"null",P+=","}const H=G(U,E[U],K);if(P+=H!==void 0?H:"null",E.length-1>T){const Z=E.length-T-1;P+=`,"... ${c(Z)} not stringified"`}return K.pop(),`[${P}]`}let D=Object.keys(E);const $=D.length;if($===0)return"{}";if(O<K.length+1)return'"[Object]"';let R="",M=Math.min($,T);v(E)&&(P+=g(E,",",T),D=D.slice(E.length),M-=E.length,R=","),x&&(D=h(D)),K.push(E);for(let F=0;F<M;F++){const U=D[F],H=G(U,E[U],K);H!==void 0&&(P+=`${R}"${s(U)}":${H}`,R=",")}if($>T){const F=$-T;P+=`${R}"...":"${c(F)} not stringified"`}return K.pop(),`{${P}}`}case"number":return isFinite(E)?String(E):l?l(E):"null";case"boolean":return E===!0?"true":"false";case"undefined":return;case"bigint":if(A)return String(E);default:return l?l(E):void 0}}function B(q,E,K){if(arguments.length>1){let P="";if(typeof K=="number"?P=" ".repeat(Math.min(K,10)):typeof K=="string"&&(P=K.slice(0,10)),E!=null){if(typeof E=="function")return j("",{"":q},[],E,P,"");if(Array.isArray(E))return V("",q,[],S(E),P,"")}if(P.length!==0)return N("",q,[],P,"")}return G("",q,[])}return B}})(Ko,Ft);const $t=Ft;$t.configure;const de=$t;function Ro(e,t,n=30,r=null){let i=[];for(let o of e){o={...o},delete o.limit,delete o.since,delete o.until,delete o.relay;let u=new Map;for(let a of Io(o))u.set(de(a),[]);for(let a of t)Gr(o,a)&&ko(u,o,a);for(let[a,s]of u)Do(i,a,s,n,r)}return i}function Je(e,t,n,r,i=null,o=!1){if(n){if(t[n]&&t[n].length>1){for(let u of t[n])if(o){for(let a of r.tags)if(a[0]==i&&a[1]===u){Gt(e,{...t,[n]:[u]},r);break}}else if(i!=null&&r[i]===u){Gt(e,{...t,[n]:[u]},r);break}return!0}return!1}else Gt(e,t,r)}function Gt(e,t,n){let r=de(t),i=e.get(r);i?i.push(n):e.set(r,[n])}function ko(e,t,n){Je(e,t,"authors",n,"pubkey",!1)||Je(e,t,"ids",n,"ids",!1)||Je(e,t,"#p",n,"p",!0)||Je(e,t,"#e",n,"e",!0)||Je(e,t,null,n)}function Do(e,t,n,r,i){n=n.sort((o,u)=>o.created_at-u.created_at);for(let o=0;o<n.length;o+=r)r>1||n.length==1?e.push({filter:t,events:n.slice(o,o+r)}):e.push({filter:t,event:n[o]});i&&e.push({filter:t,query_info:i})}function Io(e){let t=[];if(e.authors&&e.authors.length>1)for(let n of e.authors)t.push({...e,authors:[n]});else if(e.ids&&e.ids.length>1)for(let n of e.ids)t.push({...e,ids:[n]});else if(e["#p"]&&e["#p"].length>1)for(let n of e["#p"])t.push({...e,"#p":[n]});else if(e["#e"]&&e["#e"].length>1)for(let n of e["#e"])t.push({...e,"#e":[n]});else t.push(e);return t}function Po(e,t){let n=new Map;for(let r of e)n.set(t(r),r);return n}function qn(e,t){return e.reduce((n,r)=>{const i=t(r);return n.get(i)||n.set(i,[]),n.get(i).push(r),n},new Map)}function Bo(e){return[...new Set(e)]}function Mo(e,t){return new Map(Array.from(e.entries()).map(([n,r])=>[n,t(r)]))}function Fo(e,t){if(t={...t},t.ids){if(t.ids=t.ids.filter(n=>!e.find(r=>r.id==De(n))),!t.ids.length)return null}else if(t.authors){if(t.authors=t.authors.filter(n=>!e.find(r=>r.pubkey==De(n))),!t.authors.length)return null}else throw new Error("onlyOne option not supported for this filter"+de(t));return t}function Nr(e){let t=[],n=new Map;for(let r of e){let i=!1;for(let o in r)if(r[o]&&(["ids","authors","kinds"].includes(o)||o.startsWith("#"))){let u={...r};delete u[o];let a=o+de(u),s=n.get(a);if(s!==void 0){let h=t[s];for(let y in h)if(y!=o){let v={...h};delete v[y];let g=y+de(v);n.delete(g)}t[s][o]=[...new Set(t[s][o].concat(r[o]))],i=!0;break}n.set(a,t.length)}i||t.push(r)}return t}function $o(e,t,n,r,i){t=Nr(t);let o=[];for(let u of t){u={...u};let a=n.onlyOne;if(u.ids&&u.ids.length==0||u.authors&&u.authors.length==0||u.kinds&&u.kinds.length==0){console.timeLog(e,"no need to send subscription because filter is empty");continue}if((u.ids||u.authors&&u.kinds&&u.kinds.length==1&&(u.kinds[0]==0||u.kinds[0]==3))&&(a=!0),a){let y=Fo(r,u);if(!y){console.timeLog(e,"no need to send subscription because all events are already in the database");continue}u=y}const s=3600;if(u.authors&&!u.retrieve_old){let y=qn(r,d=>d.pubkey),v=Mo(y,d=>Math.max(...d.map(p=>p.created_at))),g=[],_=new Map;for(let d of u.authors){d=De(d);let p=v.get(De(d));for(let c of i){let S=c.query_info;S.req_sent_at&&(!p||S.req_sent_at>p)&&c.filter==de({...u,authors:[d],limit:void 0})&&(p=S.req_sent_at)}if(p==null)g.push(d);else if(_.get(Math.round(p/s))){let c=_.get(Math.round(p/s));if(!c||!c.authors)throw new Error("new_filter or authors is undefined");c.since&&c.since>p+1&&(c.since=p+1),c.authors.push(d),u.limit&&(c.limit=Math.round(c.authors.length*u.limit/u.authors.length))}else{let c={...u};c.authors=[d],c.since=p+1,c.limit&&(c.limit=Math.round(c.limit/u.authors.length));let S=Ot(c);o.push(S),_.set(Math.round(p/s),S)}}if(g.length==0)continue;u.limit&&(u.limit=Math.round(u.limit*g.length/u.authors.length)),u.authors=g}let h=!1;for(let y of Object.keys(u)){if(!y.startsWith("#"))continue;let v=u[y],g=[],_=new Map;for(let d of v){let p=y.slice(1),c=Math.max(...r.filter(b=>b.tags.find(w=>w[0]==p&&w[1]==d)).map(b=>b.created_at));c==-1/0&&(c=void 0);let S={...u};S[y]=[d],S.limit=void 0;for(let b of i){let w=b.query_info;w.req_sent_at&&(!c||w.req_sent_at>c)&&b.filter==de(S)&&(c=w.req_sent_at)}if(c==null)g.push(d);else if(_.get(Math.round(c/s))){let b=_.get(Math.round(c/s));if(!b||!b[y])throw new Error("new_filter or authors is undefined");b.since&&b.since>c+1&&(b.since=c+1),b[y].push(d),u.limit&&(b.limit=Math.round(b[y].length*u.limit/u[y].length))}else{let b={...u};b[y]=[d],b.since=c+1;let w=Ot(b);o.push(w),_.set(Math.round(c/s),w)}}if(g.length==0){h=!0;break}u.limit&&(u.limit=Math.round(u.limit*g.length/u[y].length)),u[y]=g}h||o.push(Ot(u))}if(o.length!=0)return o}let De=e=>typeof e=="string"?e:e[0];function Ot(e){let t={};e.ids&&(t.ids=e.ids.map(De)),e.kinds&&(t.kinds=e.kinds),e.authors&&(t.authors=e.authors.map(De)),e.since&&(t.since=e.since),e.until&&(t.until=e.until),e.limit&&(t.limit=e.limit),e.relay&&(t.relay=e.relay);for(let n of Object.keys(e))n.startsWith("#")&&(t[n]=e[n].map(De));return t}function Lr(e){let t=Ot(e);return delete t.relay,t}class jo extends Vn{constructor(){super("nostr_events",{chromeTransactionDurability:"relaxed"}),this.version(1).stores({events:"++,filter"})}}const Vr=new jo;function Ye(e,t){return t?e[t]&&e[t].length>1?e[t].map(n=>de({...e,[t]:[n]})):null:[de(e)]}function No(e){let t=Ye(e,"authors")||Ye(e,"ids")||Ye(e,"#p")||Ye(e,"#e")||Ye(e,null);if(!t)throw new Error("splitWhereClause bug");return t}function ur(e){return e.store_filter?[de(e.store_filter)]:No(Lr(e))}function qr(e,t,n=30,r=null){console.log("putEvents called with ",t.length," events");let i=Ro(e,t,n,r);return Vr.events.bulkPut(i)}function Lo(e){let t=[];for(let r of e)r={...r},delete r.limit,delete r.since,delete r.until,delete r.relay,delete r.retrieve_old,console.log("filter keys for ",r,ur(r)),t.push(ur(r));return Vr.events.where("filter").anyOf(t.flat()).toArray().then(r=>{let i=r.map(u=>u.events||u.event||[]).flat(),o=r.filter(u=>u.query_info);return{events:i,query_infos:o}})}function Vo(e){var t,n;let r=!1,i=[];var o={},u={connect:[],disconnect:[],error:[],notice:[]},a={},s={};async function h(){return new Promise((_,d)=>{t=new WebSocket(e),t.onopen=()=>{r=!0;for(let p in o)v(["REQ",p,...o[p].filters]);for(let p of i)t.send(p);i=[],u.connect.forEach(p=>p()),_()},t.onerror=()=>{u.error.forEach(p=>p()),d()},t.onclose=async()=>{r=!1,u.disconnect.forEach(p=>p()),n&&n()},t.onmessage=async p=>{var S,b,w,f;var c;try{c=JSON.parse(p.data)}catch{c=p.data}if(c.length>=1)switch(c[0]){case"EVENT":if(c.length!==3)return;let l=c[1],m=c[2];Qr(m)&&o[l]&&(o[l].skipVerification||Xr(m))&&Zr(o[l].filters,m)&&(o[l],(((S=a[l])==null?void 0:S.event)||[]).forEach(x=>x(m)));return;case"EOSE":{if(c.length!==2)return;let x=c[1];(((b=a[x])==null?void 0:b.eose)||[]).forEach(O=>O());return}case"OK":{if(c.length<3)return;let x=c[1],O=c[2],T=c[3]||"";O?(w=s[x])==null||w.ok.forEach(j=>j()):(f=s[x])==null||f.failed.forEach(j=>j(T));return}case"NOTICE":if(c.length!==2)return;let A=c[1];u.notice.forEach(x=>x(A));return}}})}async function y(){t!=null&&t.readyState&&t.readyState===1||await h()}async function v(_){let d=JSON.stringify(_);r?t.send(d):i.push(d)}const g=(_,{skipVerification:d=!1,id:p=Math.random().toString().slice(2)}={})=>{let c=p;return o[c]={id:c,filters:_,skipVerification:d},r&&v(["REQ",c,..._]),{sub:(S,b={})=>g(S||_,{skipVerification:b.skipVerification||d,id:c}),unsub:()=>{delete o[c],delete a[c],r&&v(["CLOSE",c])},on:(S,b)=>{a[c]=a[c]||{event:[],eose:[]},a[c][S].push(b)},off:(S,b)=>{let w=a[c],f=w[S].indexOf(b);f>=0&&w[S].splice(f,1)}}};return{url:e,sub:g,on:(_,d)=>{u[_].push(d),_==="connect"&&(t==null?void 0:t.readyState)===1&&d()},off:(_,d)=>{let p=u[_].indexOf(d);p!==-1&&u[_].splice(p,1)},publish(_){if(!_.id)throw new Error(`event ${_} has no id`);let d=_.id;var p=!1,c=!1;v(["EVENT",_]).then(()=>{p=!0,c&&(S(),c=!1)}).catch(()=>{});const S=()=>{let b=g([{ids:[d]}],{id:`monitor-${d.slice(0,5)}`}),w=setTimeout(()=>{var f;(((f=s[d])==null?void 0:f.failed)||[]).forEach(l=>l("event not seen after 5 seconds")),b.unsub()},5e3);b.on("event",()=>{var f;clearTimeout(w),(((f=s[d])==null?void 0:f.seen)||[]).forEach(l=>l())})};return{on:(b,w)=>{s[d]=s[d]||{ok:[],seen:[],failed:[]},s[d][b].push(w),b==="seen"&&(p?S():c=!0)},off:(b,w)=>{let f=s[d];if(!f)return;let l=f[b].indexOf(w);l>=0&&f[b].splice(l,1)}}},connect:y,close(){return t.close(),new Promise(_=>{n=_})},get status(){return(t==null?void 0:t.readyState)??3}}}var Qt=e=>[...new Set(e)],qo=class{constructor(e){Me(this,"relayByUrl");Me(this,"noticecbs");if(this.relayByUrl=new Map,this.noticecbs=[],e)for(let t of Qt(e))this.addOrGetRelay(t)}addOrGetRelay(e){let t=this.relayByUrl.get(e);return t||(t=Vo(e),this.relayByUrl.set(e,t),t.connect().then(n=>{t==null||t.on("notice",r=>{this.noticecbs.forEach(i=>i(e+": "+r))})},n=>{console.warn("failed to connect to relay "+e)}),t)}close(){for(let e of this.relayByUrl.values())e.close();this.relayByUrl.clear()}sub(e,t){t=Qt(t);let n=[],r=new Map,i=[];for(let u of e){let a=u.relay;if(a){let s=r.get(a);s?s.push({...u,relay:void 0}):r.set(a,[{...u,relay:void 0}])}else i.push(u)}let o=[];for(let u of t)if(!r.get(u)&&i.length>0){let s=this.addOrGetRelay(u);n.push(s.sub(i)),o.push(u)}for(let[u,a]of r){let s=this.addOrGetRelay(u);t.includes(u)&&(a=a.concat(i)),n.push(s.sub(a)),o.push(u)}return new Uo(n,o)}publish(e,t){for(let n of Qt(t))this.addOrGetRelay(n).publish(e)}onnotice(e){this.noticecbs.push(e)}onerror(e){this.relayByUrl.forEach((t,n)=>t.on("error",r=>e(n+": "+r)))}ondisconnect(e){this.relayByUrl.forEach((t,n)=>t.on("disconnect",r=>e(n+": "+r)))}},Uo=class{constructor(e,t){Me(this,"subscriptions");Me(this,"eventsBySub");Me(this,"urlsBySub");this.subscriptions=e,this.eventsBySub=new Map,this.urlsBySub=new Map;for(let n=0;n<e.length;n++)this.urlsBySub.set(e[n],t[n])}onevent(e){return this.subscriptions.forEach(t=>{this.eventsBySub.set(t,[]),t.on("event",n=>{let r=this.eventsBySub.get(t);r&&r.push(n),e(n,r===void 0,this.urlsBySub.get(t))})}),()=>{this.subscriptions.forEach(t=>t.off("event",e))}}oneose(e){return this.subscriptions.forEach(t=>t.on("eose",()=>{let n=this.eventsBySub.get(t);this.eventsBySub.delete(t),e(n,this.urlsBySub.get(t))})),()=>{this.subscriptions.forEach(t=>t.off("eose",e))}}unsub(){this.subscriptions.forEach(e=>e.unsub())}};let Xt=0,Wo=["wss://relay.damus.io","wss://nostr.fmt.wiz.biz","wss://nostr.bongbong.com","wss://nostr-2.zebedee.cloud","wss://nostr.zaprite.io","wss://relay.nostr.ch","wss://nostr.delo.software","wss://nostr.nodeofsven.com","wss://nostr.oxtr.dev","wss://nostr-relay.wlvs.space","wss://nostr-pub.wellorder.net","wss:://brb.io","wss://nostr.v0l.io"];const pt=new qo;pt.onerror=e=>{console.log("RelayPool error",e)};pt.onnotice(e=>{console.log("RelayPool notice",e)});function Un(e,t){for(let n of e)if(n.id==t)return!0;return!1}let zo=e=>{var t;(t=e.sub)==null||t.unsub(),e.sub=void 0};function Ho(e,t){e.query_info.eose_received_at=xn(),e.query_info.total_events=e.events.length,e.query_info.new_events=t.length;let n=t.filter(r=>!Un(e.storedEvents,r.id));console.timeLog(e.label,"EOSE with "+t.length+" events, from that "+n.length+" not stored yet, total events seen: ",e.events.length,", total events stored: ",e.storedEvents.length,", query_info: ",e.query_info,", recieved events: ",t,", stored events: ",e.storedEvents),console.log("Writing query info",e.query_info),qr(e.filters,n,void 0,e.query_info),e.storedEvents=e.storedEvents.concat(n),e.changed&&e.callback&&e.callback(e.events)}function Jo(e,t,n){e.changed=!0,e.events.push(t);let r=!1;n?(r=!0,e.callback(e.events)):e.newEvents.push(t),r&&(Un(e.storedEvents,t.id)||(qr(e.filters,[t]),e.storedEvents.push(t)))}function Yo(e,t,n){e.query_info.received_events++,Un(e.events,t.id)||Jo(e,t,n)}pt.ondisconnect(e=>{console.log("relay disconnected",e)});function Go(e){console.log("relay.sub",e.subText,...e.filters);let t=pt.sub(e.filters,Wo);e.sub=t,t.onevent((n,r)=>{Yo(e,n,r)}),t.oneose((n,r)=>{console.log("eose received at",r),n?Ho(e,n):console.warn("eose received without events (server sent eose twice")})}const xn=()=>Math.floor(Date.now()/1e3);function Ur(e,t,n={}){console.log("in subscribe");let r="sub"+Xt,i=r;console.time(i),Xt=Xt+1;let o=xn(),u;return Lo(e.map(Lr)).then(({events:a,query_infos:s})=>{console.log("got events");let h=a.length;if(a.length&&t(a),n.offline){console.timeLog(i,"offline mode, no subscription",a,s),console.timeEnd(),n.dbread&&n.dbread();return}n.dbread&&n.dbread();let y=$o(i,e,n,a,s);console.timeLog(i,"filter: ",e,`got ${h} indexedDB events for filter, query_infos`,s,"filter_result",y),y&&(u={events:a,callback:t,filters:y,changed:!1,options:n,label:i,subText:r,newEvents:[],storedEvents:a,query_info:{db_queried_at:o,req_sent_at:xn(),received_events:0}},console.log("sending subscription REQ",r,...u.filters,", original label",u.label,", req_sent_at",u.query_info.req_sent_at),Go(u))}),()=>{u&&(console.timeEnd(u.label),zo(u),u.callback=null)}}function pu(e,t){let n=pt.sub(e,t),r=Date.now();n.oneose((i,o)=>{console.log("subdebug",o,Date.now()-r,"ms",e,i)})}function He(e,t){return console.log("subscribeAndCacheResultsStore",e,t),ar([],function(r){return Ur(e,r,t)})}function Wn(e,t,n){let r=null;return ar([],function(o){return e.subscribe(u=>{r&&r(),r=Ur(t(u),o,n)}),()=>{r&&r()}})}let Qo=(e,t=500)=>He([{authors:[e],limit:t}]),Xo=(e,t=500)=>He([{"#p":[e],limit:t}]),Zo=(e,t)=>Wn(e,n=>{let r={kinds:[0],authors:[t]};console.log("filtering profiles",n);for(let i=0;i<n.length;i++){let o=n[i];r.authors=Bo(r.authors.concat(o.tags.filter(u=>u[0]=="p"&&u[1]&&u[1].length>8).map(u=>u[1])))}return[r]},{onlyOne:!0}),eu=e=>An(e,t=>Po(t,n=>n.pubkey)),tu=e=>An(e,t=>{var r;return((r=t.findLast(i=>i.kind===Le.Contacts))==null?void 0:r.tags.map(i=>i[1]))||[]}),nu=e=>t=>t.filter(n=>n.kind===e),ru=(e,t=500)=>Wn(e,n=>[{authors:n,limit:t}]),Wr=e=>{let t=e.filter(i=>i.kind==Le.Text).map(i=>i.tags).flat().filter(i=>i[0]=="e").map(i=>i.slice(1)),n=qn(t,i=>i[0]),r=[];for(let[i,o]of n){let u=o.map(a=>a.slice(1)).flat();r.push([i,...new Set(u)])}return{ids:r}},iu=e=>An(He([Wr(e)],{onlyOne:!0}),t=>qn(t,n=>n.id));function ou(e,t=null){const{subscribe:n,set:r}=sr(JSON.parse(localStorage.getItem(e))||t);return{subscribe:n,set:i=>{localStorage.setItem(e,JSON.stringify(i)),r(i)}}}function zr(e,t=null){const{subscribe:n,set:r}=sr(localStorage.getItem(e)||t);return{subscribe:n,set:i=>{localStorage.setItem(e,i),r(i)}}}let uu=()=>zr("nostr_profile_state");async function au(e,t={}){let n=He([{kinds:[Le.Contacts],authors:[e]}],{onlyOne:!0,...t});return new Promise((r,i)=>{n.subscribe(o=>{o.length>0&&r(o[0].tags.filter(u=>u[0]=="p").map(u=>u[1]))})})}let su=(e,t,n)=>He([{authors:[e],limit:200},{"#p":[e],limit:200},{authors:t.concat([e]),kinds:[Le.Contacts,Le.Metadata]},{authors:t,limit:1e3},{"#p":t,limit:1e3}],n);function lu(e,t){let n=new Map;for(let r of e)for(let i of r.tags)if(i[0]==t){let o=i[1],u=n.get(o);n.set(o,u||[r])}return n}function Hr(e){let t=[],n=new Set;for(let r of e){let i=JSON.stringify(r);n.has(i)||(n.add(i),t.push(r))}return t}function fu(e,t,n){let r=new Set(e.map(u=>u.id)),i=new Set(e.filter(u=>u.kind==0).map(u=>u.pubkey)),o=[];for(let u of e)if(u.kind==Le.Text&&(u.pubkey==t||n.includes(u.pubkey))){for(let a of u.tags)if(a[0]=="p"){if(i.has(a[1]))continue;let s={authors:[a[1]],kinds:[0]};a[2]&&a[2]!=""&&(s.relay=a[2]),s.store_filter=$t({authors:[u.pubkey]}),o.push(s)}else if(a[0]=="e"){if(r.has(a[1]))continue;let s={ids:[a[1]]};a[2]&&a[2]!=""&&(s.relay=a[2]),s.store_filter=$t({authors:[u.pubkey]}),o.push(s)}}return Nr(Hr(o))}const yu=Object.freeze(Object.defineProperty({__proto__:null,subscribeAndCacheResultsStore:He,derivedSubscribeStore:Wn,publishedStore:Qo,receivedStore:Xo,publishedProfilesStore:Zo,publishedProfilesByPubKeyStore:eu,contactsStore:tu,filterByKind:nu,eventsFromFollowedStore:ru,repliesFilter:Wr,repliesStore:iu,localStorageJSONStore:ou,localStorageStore:zr,profileStateLocalStore:uu,getFollowed:au,getEvents:su,groupByTag:lu,stringifyUnique:Hr,filtersFromEventTags:fu},Symbol.toStringTag,{value:"Module"}));export{su as a,Lo as b,Po as c,Vr as d,He as e,fu as f,qn as g,Wr as h,lu as i,pu as j,Wo as k,yu as l,Nr as m,Ot as r,Hr as s};
