var Wr=Object.defineProperty;var zr=(e,t,n)=>t in e?Wr(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n;var He=(e,t,n)=>(zr(e,typeof t!="symbol"?t+"":t,n),n);import{v as qr,b as Hr,m as Yr,K as Ce}from"./nostr.esm-759a0f0c.js";import{r as or,d as xn,w as ur}from"./index-fd964354.js";/*! *****************************************************************************
Copyright (c) Microsoft Corporation.
Permission to use, copy, modify, and/or distribute this software for any
purpose with or without fee is hereby granted.
THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH
REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY
AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT,
INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM
LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR
OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
PERFORMANCE OF THIS SOFTWARE.
***************************************************************************** */var L=function(){return L=Object.assign||function(t){for(var n,r=1,i=arguments.length;r<i;r++){n=arguments[r];for(var o in n)Object.prototype.hasOwnProperty.call(n,o)&&(t[o]=n[o])}return t},L.apply(this,arguments)};function Xt(e,t,n){if(n||arguments.length===2)for(var r=0,i=t.length,o;r<i;r++)(o||!(r in t))&&(o||(o=Array.prototype.slice.call(t,0,r)),o[r]=t[r]);return e.concat(o||Array.prototype.slice.call(t))}var Y=typeof globalThis<"u"?globalThis:typeof self<"u"?self:typeof window<"u"?window:global,Q=Object.keys,ne=Array.isArray;typeof Promise<"u"&&!Y.Promise&&(Y.Promise=Promise);function ie(e,t){return typeof t!="object"||Q(t).forEach(function(n){e[n]=t[n]}),e}var tt=Object.getPrototypeOf,Jr={}.hasOwnProperty;function ae(e,t){return Jr.call(e,t)}function Ne(e,t){typeof t=="function"&&(t=t(tt(e))),(typeof Reflect>"u"?Q:Reflect.ownKeys)(t).forEach(function(n){be(e,n,t[n])})}var ar=Object.defineProperty;function be(e,t,n,r){ar(e,t,ie(n&&ae(n,"get")&&typeof n.get=="function"?{get:n.get,set:n.set,configurable:!0}:{value:n,configurable:!0,writable:!0},r))}function Ve(e){return{from:function(t){return e.prototype=Object.create(t.prototype),be(e.prototype,"constructor",e),{extend:Ne.bind(null,e.prototype)}}}}var Gr=Object.getOwnPropertyDescriptor;function An(e,t){var n=Gr(e,t),r;return n||(r=tt(e))&&An(r,t)}var Qr=[].slice;function Ft(e,t,n){return Qr.call(e,t,n)}function sr(e,t){return t(e)}function Ge(e){if(!e)throw new Error("Assertion Failed")}function lr(e){Y.setImmediate?setImmediate(e):setTimeout(e,0)}function fr(e,t){return e.reduce(function(n,r,i){var o=t(r,i);return o&&(n[o[0]]=o[1]),n},{})}function Xr(e,t,n){try{e.apply(null,n)}catch(r){t&&t(r)}}function me(e,t){if(ae(e,t))return e[t];if(!t)return e;if(typeof t!="string"){for(var n=[],r=0,i=t.length;r<i;++r){var o=me(e,t[r]);n.push(o)}return n}var u=t.indexOf(".");if(u!==-1){var a=e[t.substr(0,u)];return a===void 0?void 0:me(a,t.substr(u+1))}}function le(e,t,n){if(!(!e||t===void 0)&&!("isFrozen"in Object&&Object.isFrozen(e)))if(typeof t!="string"&&"length"in t){Ge(typeof n!="string"&&"length"in n);for(var r=0,i=t.length;r<i;++r)le(e,t[r],n[r])}else{var o=t.indexOf(".");if(o!==-1){var u=t.substr(0,o),a=t.substr(o+1);if(a==="")n===void 0?ne(e)&&!isNaN(parseInt(u))?e.splice(u,1):delete e[u]:e[u]=n;else{var s=e[u];(!s||!ae(e,u))&&(s=e[u]={}),le(s,a,n)}}else n===void 0?ne(e)&&!isNaN(parseInt(t))?e.splice(t,1):delete e[t]:e[t]=n}}function Zr(e,t){typeof t=="string"?le(e,t,void 0):"length"in t&&[].map.call(t,function(n){le(e,n,void 0)})}function cr(e){var t={};for(var n in e)ae(e,n)&&(t[n]=e[n]);return t}var ei=[].concat;function hr(e){return ei.apply([],e)}var dr="Boolean,String,Date,RegExp,Blob,File,FileList,FileSystemFileHandle,ArrayBuffer,DataView,Uint8ClampedArray,ImageBitmap,ImageData,Map,Set,CryptoKey".split(",").concat(hr([8,16,32,64].map(function(e){return["Int","Uint","Float"].map(function(t){return t+e+"Array"})}))).filter(function(e){return Y[e]}),ti=dr.map(function(e){return Y[e]});fr(dr,function(e){return[e,!0]});var Ee=null;function st(e){Ee=typeof WeakMap<"u"&&new WeakMap;var t=Zt(e);return Ee=null,t}function Zt(e){if(!e||typeof e!="object")return e;var t=Ee&&Ee.get(e);if(t)return t;if(ne(e)){t=[],Ee&&Ee.set(e,t);for(var n=0,r=e.length;n<r;++n)t.push(Zt(e[n]))}else if(ti.indexOf(e.constructor)>=0)t=e;else{var i=tt(e);t=i===Object.prototype?{}:Object.create(i),Ee&&Ee.set(e,t);for(var o in e)ae(e,o)&&(t[o]=Zt(e[o]))}return t}var ni={}.toString;function en(e){return ni.call(e).slice(8,-1)}var tn=typeof Symbol<"u"?Symbol.iterator:"@@iterator",ri=typeof tn=="symbol"?function(e){var t;return e!=null&&(t=e[tn])&&t.apply(e)}:function(){return null},Fe={};function ve(e){var t,n,r,i;if(arguments.length===1){if(ne(e))return e.slice();if(this===Fe&&typeof e=="string")return[e];if(i=ri(e)){for(n=[];r=i.next(),!r.done;)n.push(r.value);return n}if(e==null)return[e];if(t=e.length,typeof t=="number"){for(n=new Array(t);t--;)n[t]=e[t];return n}return[e]}for(t=arguments.length,n=new Array(t);t--;)n[t]=arguments[t];return n}var Tn=typeof Symbol<"u"?function(e){return e[Symbol.toStringTag]==="AsyncFunction"}:function(){return!1},de=typeof location<"u"&&/^(http|https):\/\/(localhost|127\.0\.0\.1)/.test(location.href);function pr(e,t){de=e,yr=t}var yr=function(){return!0},ii=!new Error("").stack;function Be(){if(ii)try{throw Be.arguments,new Error}catch(e){return e}return new Error}function nn(e,t){var n=e.stack;return n?(t=t||0,n.indexOf(e.name)===0&&(t+=(e.name+e.message).split(`
`).length),n.split(`
`).slice(t).filter(yr).map(function(r){return`
`+r}).join("")):""}var oi=["Modify","Bulk","OpenFailed","VersionChange","Schema","Upgrade","InvalidTable","MissingAPI","NoSuchDatabase","InvalidArgument","SubTransaction","Unsupported","Internal","DatabaseClosed","PrematureCommit","ForeignAwait"],vr=["Unknown","Constraint","Data","TransactionInactive","ReadOnly","Version","NotFound","InvalidState","InvalidAccess","Abort","Timeout","QuotaExceeded","Syntax","DataClone"],On=oi.concat(vr),ui={VersionChanged:"Database version changed by other database connection",DatabaseClosed:"Database has been closed",Abort:"Transaction aborted",TransactionInactive:"Transaction has already completed or failed",MissingAPI:"IndexedDB API missing. Please visit https://tinyurl.com/y2uuvskb"};function Ue(e,t){this._e=Be(),this.name=e,this.message=t}Ve(Ue).from(Error).extend({stack:{get:function(){return this._stack||(this._stack=this.name+": "+this.message+nn(this._e,2))}},toString:function(){return this.name+": "+this.message}});function gr(e,t){return e+". Errors: "+Object.keys(t).map(function(n){return t[n].toString()}).filter(function(n,r,i){return i.indexOf(n)===r}).join(`
`)}function Ot(e,t,n,r){this._e=Be(),this.failures=t,this.failedKeys=r,this.successCount=n,this.message=gr(e,t)}Ve(Ot).from(Ue);function Xe(e,t){this._e=Be(),this.name="BulkError",this.failures=Object.keys(t).map(function(n){return t[n]}),this.failuresByPos=t,this.message=gr(e,t)}Ve(Xe).from(Ue);var Cn=On.reduce(function(e,t){return e[t]=t+"Error",e},{}),ai=Ue,D=On.reduce(function(e,t){var n=t+"Error";function r(i,o){this._e=Be(),this.name=n,i?typeof i=="string"?(this.message=""+i+(o?`
 `+o:""),this.inner=o||null):typeof i=="object"&&(this.message=i.name+" "+i.message,this.inner=i):(this.message=ui[t]||n,this.inner=null)}return Ve(r).from(ai),e[t]=r,e},{});D.Syntax=SyntaxError;D.Type=TypeError;D.Range=RangeError;var zn=vr.reduce(function(e,t){return e[t+"Error"]=D[t],e},{});function si(e,t){if(!e||e instanceof Ue||e instanceof TypeError||e instanceof SyntaxError||!e.name||!zn[e.name])return e;var n=new zn[e.name](t||e.message,e);return"stack"in e&&be(n,"stack",{get:function(){return this.inner.stack}}),n}var $t=On.reduce(function(e,t){return["Syntax","Type","Range"].indexOf(t)===-1&&(e[t+"Error"]=D[t]),e},{});$t.ModifyError=Ot;$t.DexieError=Ue;$t.BulkError=Xe;function z(){}function lt(e){return e}function li(e,t){return e==null||e===lt?t:function(n){return t(e(n))}}function Pe(e,t){return function(){e.apply(this,arguments),t.apply(this,arguments)}}function fi(e,t){return e===z?t:function(){var n=e.apply(this,arguments);n!==void 0&&(arguments[0]=n);var r=this.onsuccess,i=this.onerror;this.onsuccess=null,this.onerror=null;var o=t.apply(this,arguments);return r&&(this.onsuccess=this.onsuccess?Pe(r,this.onsuccess):r),i&&(this.onerror=this.onerror?Pe(i,this.onerror):i),o!==void 0?o:n}}function ci(e,t){return e===z?t:function(){e.apply(this,arguments);var n=this.onsuccess,r=this.onerror;this.onsuccess=this.onerror=null,t.apply(this,arguments),n&&(this.onsuccess=this.onsuccess?Pe(n,this.onsuccess):n),r&&(this.onerror=this.onerror?Pe(r,this.onerror):r)}}function hi(e,t){return e===z?t:function(n){var r=e.apply(this,arguments);ie(n,r);var i=this.onsuccess,o=this.onerror;this.onsuccess=null,this.onerror=null;var u=t.apply(this,arguments);return i&&(this.onsuccess=this.onsuccess?Pe(i,this.onsuccess):i),o&&(this.onerror=this.onerror?Pe(o,this.onerror):o),r===void 0?u===void 0?void 0:u:ie(r,u)}}function di(e,t){return e===z?t:function(){return t.apply(this,arguments)===!1?!1:e.apply(this,arguments)}}function Kn(e,t){return e===z?t:function(){var n=e.apply(this,arguments);if(n&&typeof n.then=="function"){for(var r=this,i=arguments.length,o=new Array(i);i--;)o[i]=arguments[i];return n.then(function(){return t.apply(r,o)})}return t.apply(this,arguments)}}var nt={},pi=100,yi=20,mr=100,Rn=typeof Promise>"u"?[]:function(){var e=Promise.resolve();if(typeof crypto>"u"||!crypto.subtle)return[e,tt(e),e];var t=crypto.subtle.digest("SHA-512",new Uint8Array([0]));return[t,tt(t),e]}(),rn=Rn[0],Ct=Rn[1],on=Rn[2],br=Ct&&Ct.then,wt=rn&&rn.constructor,In=!!on,un=!1,vi=on?function(){on.then(yt)}:Y.setImmediate?setImmediate.bind(null,yt):Y.MutationObserver?function(){var e=document.createElement("div");new MutationObserver(function(){yt(),e=null}).observe(e,{attributes:!0}),e.setAttribute("i","1")}:function(){setTimeout(yt,0)},rt=function(e,t){Qe.push([e,t]),Kt&&(vi(),Kt=!1)},an=!0,Kt=!0,Re=[],_t=[],sn=null,ln=lt,$e={id:"global",global:!0,ref:0,unhandleds:[],onunhandled:Yn,pgp:!1,env:{},finalize:function(){this.unhandleds.forEach(function(e){try{Yn(e[0],e[1])}catch{}})}},I=$e,Qe=[],Ie=0,Et=[];function C(e){if(typeof this!="object")throw new TypeError("Promises must be constructed via new");this._listeners=[],this.onuncatched=z,this._lib=!1;var t=this._PSD=I;if(de&&(this._stackHolder=Be(),this._prev=null,this._numPrev=0),typeof e!="function"){if(e!==nt)throw new TypeError("Not a function");this._state=arguments[1],this._value=arguments[2],this._state===!1&&cn(this,this._value);return}this._state=null,this._value=null,++t.ref,_r(this,e)}var fn={get:function(){var e=I,t=Rt;function n(r,i){var o=this,u=!e.global&&(e!==I||t!==Rt),a=u&&!we(),s=new C(function(c,y){Pn(o,new wr(Pt(r,e,u,a),Pt(i,e,u,a),c,y,e))});return de&&xr(s,this),s}return n.prototype=nt,n},set:function(e){be(this,"then",e&&e.prototype===nt?fn:{get:function(){return e},set:fn.set})}};Ne(C.prototype,{then:fn,_then:function(e,t){Pn(this,new wr(null,null,e,t,I))},catch:function(e){if(arguments.length===1)return this.then(null,e);var t=arguments[0],n=arguments[1];return typeof t=="function"?this.then(null,function(r){return r instanceof t?n(r):St(r)}):this.then(null,function(r){return r&&r.name===t?n(r):St(r)})},finally:function(e){return this.then(function(t){return e(),t},function(t){return e(),St(t)})},stack:{get:function(){if(this._stack)return this._stack;try{un=!0;var e=Sr(this,[],yi),t=e.join(`
From previous: `);return this._state!==null&&(this._stack=t),t}finally{un=!1}}},timeout:function(e,t){var n=this;return e<1/0?new C(function(r,i){var o=setTimeout(function(){return i(new D.Timeout(t))},e);n.then(r,i).finally(clearTimeout.bind(null,o))}):this}});typeof Symbol<"u"&&Symbol.toStringTag&&be(C.prototype,Symbol.toStringTag,"Dexie.Promise");$e.env=Ar();function wr(e,t,n,r,i){this.onFulfilled=typeof e=="function"?e:null,this.onRejected=typeof t=="function"?t:null,this.resolve=n,this.reject=r,this.psd=i}Ne(C,{all:function(){var e=ve.apply(null,arguments).map(It);return new C(function(t,n){e.length===0&&t([]);var r=e.length;e.forEach(function(i,o){return C.resolve(i).then(function(u){e[o]=u,--r||t(e)},n)})})},resolve:function(e){if(e instanceof C)return e;if(e&&typeof e.then=="function")return new C(function(n,r){e.then(n,r)});var t=new C(nt,!0,e);return xr(t,sn),t},reject:St,race:function(){var e=ve.apply(null,arguments).map(It);return new C(function(t,n){e.map(function(r){return C.resolve(r).then(t,n)})})},PSD:{get:function(){return I},set:function(e){return I=e}},totalEchoes:{get:function(){return Rt}},newPSD:xe,usePSD:ze,scheduler:{get:function(){return rt},set:function(e){rt=e}},rejectionMapper:{get:function(){return ln},set:function(e){ln=e}},follow:function(e,t){return new C(function(n,r){return xe(function(i,o){var u=I;u.unhandleds=[],u.onunhandled=o,u.finalize=Pe(function(){var a=this;mi(function(){a.unhandleds.length===0?i():o(a.unhandleds[0])})},u.finalize),e()},t,n,r)})}});wt&&(wt.allSettled&&be(C,"allSettled",function(){var e=ve.apply(null,arguments).map(It);return new C(function(t){e.length===0&&t([]);var n=e.length,r=new Array(n);e.forEach(function(i,o){return C.resolve(i).then(function(u){return r[o]={status:"fulfilled",value:u}},function(u){return r[o]={status:"rejected",reason:u}}).then(function(){return--n||t(r)})})})}),wt.any&&typeof AggregateError<"u"&&be(C,"any",function(){var e=ve.apply(null,arguments).map(It);return new C(function(t,n){e.length===0&&n(new AggregateError([]));var r=e.length,i=new Array(r);e.forEach(function(o,u){return C.resolve(o).then(function(a){return t(a)},function(a){i[u]=a,--r||n(new AggregateError(i))})})})}));function _r(e,t){try{t(function(n){if(e._state===null){if(n===e)throw new TypeError("A promise cannot be resolved with itself.");var r=e._lib&&ft();n&&typeof n.then=="function"?_r(e,function(i,o){n instanceof C?n._then(i,o):n.then(i,o)}):(e._state=!0,e._value=n,Er(e)),r&&ct()}},cn.bind(null,e))}catch(n){cn(e,n)}}function cn(e,t){if(_t.push(t),e._state===null){var n=e._lib&&ft();t=ln(t),e._state=!1,e._value=t,de&&t!==null&&typeof t=="object"&&!t._promise&&Xr(function(){var r=An(t,"stack");t._promise=e,be(t,"stack",{get:function(){return un?r&&(r.get?r.get.apply(t):r.value):e.stack}})}),bi(e),Er(e),n&&ct()}}function Er(e){var t=e._listeners;e._listeners=[];for(var n=0,r=t.length;n<r;++n)Pn(e,t[n]);var i=e._PSD;--i.ref||i.finalize(),Ie===0&&(++Ie,rt(function(){--Ie===0&&Dn()},[]))}function Pn(e,t){if(e._state===null){e._listeners.push(t);return}var n=e._state?t.onFulfilled:t.onRejected;if(n===null)return(e._state?t.resolve:t.reject)(e._value);++t.psd.ref,++Ie,rt(gi,[n,e,t])}function gi(e,t,n){try{sn=t;var r,i=t._value;t._state?r=e(i):(_t.length&&(_t=[]),r=e(i),_t.indexOf(i)===-1&&wi(t)),n.resolve(r)}catch(o){n.reject(o)}finally{sn=null,--Ie===0&&Dn(),--n.psd.ref||n.psd.finalize()}}function Sr(e,t,n){if(t.length===n)return t;var r="";if(e._state===!1){var i=e._value,o,u;i!=null?(o=i.name||"Error",u=i.message||i,r=nn(i,0)):(o=i,u=""),t.push(o+(u?": "+u:"")+r)}return de&&(r=nn(e._stackHolder,2),r&&t.indexOf(r)===-1&&t.push(r),e._prev&&Sr(e._prev,t,n)),t}function xr(e,t){var n=t?t._numPrev+1:0;n<pi&&(e._prev=t,e._numPrev=n)}function yt(){ft()&&ct()}function ft(){var e=an;return an=!1,Kt=!1,e}function ct(){var e,t,n;do for(;Qe.length>0;)for(e=Qe,Qe=[],n=e.length,t=0;t<n;++t){var r=e[t];r[0].apply(null,r[1])}while(Qe.length>0);an=!0,Kt=!0}function Dn(){var e=Re;Re=[],e.forEach(function(r){r._PSD.onunhandled.call(null,r._value,r)});for(var t=Et.slice(0),n=t.length;n;)t[--n]()}function mi(e){function t(){e(),Et.splice(Et.indexOf(t),1)}Et.push(t),++Ie,rt(function(){--Ie===0&&Dn()},[])}function bi(e){Re.some(function(t){return t._value===e._value})||Re.push(e)}function wi(e){for(var t=Re.length;t;)if(Re[--t]._value===e._value){Re.splice(t,1);return}}function St(e){return new C(nt,!1,e)}function J(e,t){var n=I;return function(){var r=ft(),i=I;try{return Ae(n,!0),e.apply(this,arguments)}catch(o){t&&t(o)}finally{Ae(i,!1),r&&ct()}}}var te={awaits:0,echoes:0,id:0},_i=0,xt=[],Vt=0,Rt=0,Ei=0;function xe(e,t,n,r){var i=I,o=Object.create(i);o.parent=i,o.ref=0,o.global=!1,o.id=++Ei;var u=$e.env;o.env=In?{Promise:C,PromiseProp:{value:C,configurable:!0,writable:!0},all:C.all,race:C.race,allSettled:C.allSettled,any:C.any,resolve:C.resolve,reject:C.reject,nthen:qn(u.nthen,o),gthen:qn(u.gthen,o)}:{},t&&ie(o,t),++i.ref,o.finalize=function(){--this.parent.ref||this.parent.finalize()};var a=ze(o,e,n,r);return o.ref===0&&o.finalize(),a}function We(){return te.id||(te.id=++_i),++te.awaits,te.echoes+=mr,te.id}function we(){return te.awaits?(--te.awaits===0&&(te.id=0),te.echoes=te.awaits*mr,!0):!1}(""+br).indexOf("[native code]")===-1&&(We=we=z);function It(e){return te.echoes&&e&&e.constructor===wt?(We(),e.then(function(t){return we(),t},function(t){return we(),X(t)})):e}function Si(e){++Rt,(!te.echoes||--te.echoes===0)&&(te.echoes=te.id=0),xt.push(I),Ae(e,!0)}function xi(){var e=xt[xt.length-1];xt.pop(),Ae(e,!1)}function Ae(e,t){var n=I;if((t?te.echoes&&(!Vt++||e!==I):Vt&&(!--Vt||e!==I))&&Tr(t?Si.bind(null,e):xi),e!==I&&(I=e,n===$e&&($e.env=Ar()),In)){var r=$e.env.Promise,i=e.env;Ct.then=i.nthen,r.prototype.then=i.gthen,(n.global||e.global)&&(Object.defineProperty(Y,"Promise",i.PromiseProp),r.all=i.all,r.race=i.race,r.resolve=i.resolve,r.reject=i.reject,i.allSettled&&(r.allSettled=i.allSettled),i.any&&(r.any=i.any))}}function Ar(){var e=Y.Promise;return In?{Promise:e,PromiseProp:Object.getOwnPropertyDescriptor(Y,"Promise"),all:e.all,race:e.race,allSettled:e.allSettled,any:e.any,resolve:e.resolve,reject:e.reject,nthen:Ct.then,gthen:e.prototype.then}:{}}function ze(e,t,n,r,i){var o=I;try{return Ae(e,!0),t(n,r,i)}finally{Ae(o,!1)}}function Tr(e){br.call(rn,e)}function Pt(e,t,n,r){return typeof e!="function"?e:function(){var i=I;n&&We(),Ae(t,!0);try{return e.apply(this,arguments)}finally{Ae(i,!1),r&&Tr(we)}}}function qn(e,t){return function(n,r){return e.call(this,Pt(n,t),Pt(r,t))}}var Hn="unhandledrejection";function Yn(e,t){var n;try{n=t.onuncatched(e)}catch{}if(n!==!1)try{var r,i={promise:t,reason:e};if(Y.document&&document.createEvent?(r=document.createEvent("Event"),r.initEvent(Hn,!0,!0),ie(r,i)):Y.CustomEvent&&(r=new CustomEvent(Hn,{detail:i}),ie(r,i)),r&&Y.dispatchEvent&&(dispatchEvent(r),!Y.PromiseRejectionEvent&&Y.onunhandledrejection))try{Y.onunhandledrejection(r)}catch{}de&&r&&!r.defaultPrevented&&console.warn("Unhandled rejection: "+(e.stack||e))}catch{}}var X=C.reject;function hn(e,t,n,r){if(!e.idbdb||!e._state.openComplete&&!I.letThrough&&!e._vip){if(e._state.openComplete)return X(new D.DatabaseClosed(e._state.dbOpenError));if(!e._state.isBeingOpened){if(!e._options.autoOpen)return X(new D.DatabaseClosed);e.open().catch(z)}return e._state.dbReadyPromise.then(function(){return hn(e,t,n,r)})}else{var i=e._createTransaction(t,n,e._dbSchema);try{i.create(),e._state.PR1398_maxLoop=3}catch(o){return o.name===Cn.InvalidState&&e.isOpen()&&--e._state.PR1398_maxLoop>0?(console.warn("Dexie: Need to reopen db"),e._close(),e.open().then(function(){return hn(e,t,n,r)})):X(o)}return i._promise(t,function(o,u){return xe(function(){return I.trans=i,r(o,u,i)})}).then(function(o){return i._completion.then(function(){return o})})}}var Jn="3.2.2",Ke=String.fromCharCode(65535),dn=-1/0,pe="Invalid key provided. Keys must be of type string, number, Date or Array<string | number | Date>.",Or="String expected.",Ze=[],jt=typeof navigator<"u"&&/(MSIE|Trident|Edge)/.test(navigator.userAgent),Ai=jt,Ti=jt,Cr=function(e){return!/(dexie\.js|dexie\.min\.js)/.test(e)},Nt="__dbnames",Ut="readonly",Wt="readwrite";function De(e,t){return e?t?function(){return e.apply(this,arguments)&&t.apply(this,arguments)}:e:t}var Kr={type:3,lower:-1/0,lowerOpen:!1,upper:[[]],upperOpen:!1};function vt(e){return typeof e=="string"&&!/\./.test(e)?function(t){return t[e]===void 0&&e in t&&(t=st(t),delete t[e]),t}:function(t){return t}}var Oi=function(){function e(){}return e.prototype._trans=function(t,n,r){var i=this._tx||I.trans,o=this.name;function u(s,c,y){if(!y.schema[o])throw new D.NotFound("Table "+o+" not part of transaction");return n(y.idbtrans,y)}var a=ft();try{return i&&i.db===this.db?i===I.trans?i._promise(t,u,r):xe(function(){return i._promise(t,u,r)},{trans:i,transless:I.transless||I}):hn(this.db,t,[this.name],u)}finally{a&&ct()}},e.prototype.get=function(t,n){var r=this;return t&&t.constructor===Object?this.where(t).first(n):this._trans("readonly",function(i){return r.core.get({trans:i,key:t}).then(function(o){return r.hook.reading.fire(o)})}).then(n)},e.prototype.where=function(t){if(typeof t=="string")return new this.db.WhereClause(this,t);if(ne(t))return new this.db.WhereClause(this,"["+t.join("+")+"]");var n=Q(t);if(n.length===1)return this.where(n[0]).equals(t[n[0]]);var r=this.schema.indexes.concat(this.schema.primKey).filter(function(y){return y.compound&&n.every(function(d){return y.keyPath.indexOf(d)>=0})&&y.keyPath.every(function(d){return n.indexOf(d)>=0})})[0];if(r&&this.db._maxKey!==Ke)return this.where(r.name).equals(r.keyPath.map(function(y){return t[y]}));!r&&de&&console.warn("The query "+JSON.stringify(t)+" on "+this.name+" would benefit of a "+("compound index ["+n.join("+")+"]"));var i=this.schema.idxByName,o=this.db._deps.indexedDB;function u(y,d){try{return o.cmp(y,d)===0}catch{return!1}}var a=n.reduce(function(y,d){var g=y[0],b=y[1],p=i[d],h=t[d];return[g||p,g||!p?De(b,p&&p.multi?function(v){var S=me(v,d);return ne(S)&&S.some(function(E){return u(h,E)})}:function(v){return u(h,me(v,d))}):b]},[null,null]),s=a[0],c=a[1];return s?this.where(s.name).equals(t[s.keyPath]).filter(c):r?this.filter(c):this.where(n).equals("")},e.prototype.filter=function(t){return this.toCollection().and(t)},e.prototype.count=function(t){return this.toCollection().count(t)},e.prototype.offset=function(t){return this.toCollection().offset(t)},e.prototype.limit=function(t){return this.toCollection().limit(t)},e.prototype.each=function(t){return this.toCollection().each(t)},e.prototype.toArray=function(t){return this.toCollection().toArray(t)},e.prototype.toCollection=function(){return new this.db.Collection(new this.db.WhereClause(this))},e.prototype.orderBy=function(t){return new this.db.Collection(new this.db.WhereClause(this,ne(t)?"["+t.join("+")+"]":t))},e.prototype.reverse=function(){return this.toCollection().reverse()},e.prototype.mapToClass=function(t){this.schema.mappedClass=t;var n=function(r){if(!r)return r;var i=Object.create(t.prototype);for(var o in r)if(ae(r,o))try{i[o]=r[o]}catch{}return i};return this.schema.readHook&&this.hook.reading.unsubscribe(this.schema.readHook),this.schema.readHook=n,this.hook("reading",n),t},e.prototype.defineClass=function(){function t(n){ie(this,n)}return this.mapToClass(t)},e.prototype.add=function(t,n){var r=this,i=this.schema.primKey,o=i.auto,u=i.keyPath,a=t;return u&&o&&(a=vt(u)(t)),this._trans("readwrite",function(s){return r.core.mutate({trans:s,type:"add",keys:n!=null?[n]:null,values:[a]})}).then(function(s){return s.numFailures?C.reject(s.failures[0]):s.lastResult}).then(function(s){if(u)try{le(t,u,s)}catch{}return s})},e.prototype.update=function(t,n){if(typeof t=="object"&&!ne(t)){var r=me(t,this.schema.primKey.keyPath);if(r===void 0)return X(new D.InvalidArgument("Given object does not contain its primary key"));try{typeof n!="function"?Q(n).forEach(function(i){le(t,i,n[i])}):n(t,{value:t,primKey:r})}catch{}return this.where(":id").equals(r).modify(n)}else return this.where(":id").equals(t).modify(n)},e.prototype.put=function(t,n){var r=this,i=this.schema.primKey,o=i.auto,u=i.keyPath,a=t;return u&&o&&(a=vt(u)(t)),this._trans("readwrite",function(s){return r.core.mutate({trans:s,type:"put",values:[a],keys:n!=null?[n]:null})}).then(function(s){return s.numFailures?C.reject(s.failures[0]):s.lastResult}).then(function(s){if(u)try{le(t,u,s)}catch{}return s})},e.prototype.delete=function(t){var n=this;return this._trans("readwrite",function(r){return n.core.mutate({trans:r,type:"delete",keys:[t]})}).then(function(r){return r.numFailures?C.reject(r.failures[0]):void 0})},e.prototype.clear=function(){var t=this;return this._trans("readwrite",function(n){return t.core.mutate({trans:n,type:"deleteRange",range:Kr})}).then(function(n){return n.numFailures?C.reject(n.failures[0]):void 0})},e.prototype.bulkGet=function(t){var n=this;return this._trans("readonly",function(r){return n.core.getMany({keys:t,trans:r}).then(function(i){return i.map(function(o){return n.hook.reading.fire(o)})})})},e.prototype.bulkAdd=function(t,n,r){var i=this,o=Array.isArray(n)?n:void 0;r=r||(o?void 0:n);var u=r?r.allKeys:void 0;return this._trans("readwrite",function(a){var s=i.schema.primKey,c=s.auto,y=s.keyPath;if(y&&o)throw new D.InvalidArgument("bulkAdd(): keys argument invalid on tables with inbound keys");if(o&&o.length!==t.length)throw new D.InvalidArgument("Arguments objects and keys must have the same length");var d=t.length,g=y&&c?t.map(vt(y)):t;return i.core.mutate({trans:a,type:"add",keys:o,values:g,wantResults:u}).then(function(b){var p=b.numFailures,h=b.results,v=b.lastResult,S=b.failures,E=u?h:v;if(p===0)return E;throw new Xe(i.name+".bulkAdd(): "+p+" of "+d+" operations failed",S)})})},e.prototype.bulkPut=function(t,n,r){var i=this,o=Array.isArray(n)?n:void 0;r=r||(o?void 0:n);var u=r?r.allKeys:void 0;return this._trans("readwrite",function(a){var s=i.schema.primKey,c=s.auto,y=s.keyPath;if(y&&o)throw new D.InvalidArgument("bulkPut(): keys argument invalid on tables with inbound keys");if(o&&o.length!==t.length)throw new D.InvalidArgument("Arguments objects and keys must have the same length");var d=t.length,g=y&&c?t.map(vt(y)):t;return i.core.mutate({trans:a,type:"put",keys:o,values:g,wantResults:u}).then(function(b){var p=b.numFailures,h=b.results,v=b.lastResult,S=b.failures,E=u?h:v;if(p===0)return E;throw new Xe(i.name+".bulkPut(): "+p+" of "+d+" operations failed",S)})})},e.prototype.bulkDelete=function(t){var n=this,r=t.length;return this._trans("readwrite",function(i){return n.core.mutate({trans:i,type:"delete",keys:t})}).then(function(i){var o=i.numFailures,u=i.lastResult,a=i.failures;if(o===0)return u;throw new Xe(n.name+".bulkDelete(): "+o+" of "+r+" operations failed",a)})},e}();function ht(e){var t={},n=function(a,s){if(s){for(var c=arguments.length,y=new Array(c-1);--c;)y[c-1]=arguments[c];return t[a].subscribe.apply(null,y),e}else if(typeof a=="string")return t[a]};n.addEventType=o;for(var r=1,i=arguments.length;r<i;++r)o(arguments[r]);return n;function o(a,s,c){if(typeof a=="object")return u(a);s||(s=di),c||(c=z);var y={subscribers:[],fire:c,subscribe:function(d){y.subscribers.indexOf(d)===-1&&(y.subscribers.push(d),y.fire=s(y.fire,d))},unsubscribe:function(d){y.subscribers=y.subscribers.filter(function(g){return g!==d}),y.fire=y.subscribers.reduce(s,c)}};return t[a]=n[a]=y,y}function u(a){Q(a).forEach(function(s){var c=a[s];if(ne(c))o(s,a[s][0],a[s][1]);else if(c==="asap")var y=o(s,lt,function(){for(var g=arguments.length,b=new Array(g);g--;)b[g]=arguments[g];y.subscribers.forEach(function(p){lr(function(){p.apply(null,b)})})});else throw new D.InvalidArgument("Invalid event config")})}}function dt(e,t){return Ve(t).from({prototype:e}),t}function Ci(e){return dt(Oi.prototype,function(n,r,i){this.db=e,this._tx=i,this.name=n,this.schema=r,this.hook=e._allTables[n]?e._allTables[n].hook:ht(null,{creating:[fi,z],reading:[li,lt],updating:[hi,z],deleting:[ci,z]})})}function ke(e,t){return!(e.filter||e.algorithm||e.or)&&(t?e.justLimit:!e.replayFilter)}function zt(e,t){e.filter=De(e.filter,t)}function qt(e,t,n){var r=e.replayFilter;e.replayFilter=r?function(){return De(r(),t())}:t,e.justLimit=n&&!r}function Ki(e,t){e.isMatch=De(e.isMatch,t)}function At(e,t){if(e.isPrimKey)return t.primaryKey;var n=t.getIndexByKeyPath(e.index);if(!n)throw new D.Schema("KeyPath "+e.index+" on object store "+t.name+" is not indexed");return n}function Gn(e,t,n){var r=At(e,t.schema);return t.openCursor({trans:n,values:!e.keysOnly,reverse:e.dir==="prev",unique:!!e.unique,query:{index:r,range:e.range}})}function gt(e,t,n,r){var i=e.replayFilter?De(e.filter,e.replayFilter()):e.filter;if(e.or){var o={},u=function(a,s,c){if(!i||i(s,c,function(g){return s.stop(g)},function(g){return s.fail(g)})){var y=s.primaryKey,d=""+y;d==="[object ArrayBuffer]"&&(d=""+new Uint8Array(y)),ae(o,d)||(o[d]=!0,t(a,s,c))}};return Promise.all([e.or._iterate(u,n),Qn(Gn(e,r,n),e.algorithm,u,!e.keysOnly&&e.valueMapper)])}else return Qn(Gn(e,r,n),De(e.algorithm,i),t,!e.keysOnly&&e.valueMapper)}function Qn(e,t,n,r){var i=r?function(u,a,s){return n(r(u),a,s)}:n,o=J(i);return e.then(function(u){if(u)return u.start(function(){var a=function(){return u.continue()};(!t||t(u,function(s){return a=s},function(s){u.stop(s),a=z},function(s){u.fail(s),a=z}))&&o(u.value,u,function(s){return a=s}),a()})})}function re(e,t){try{var n=Xn(e),r=Xn(t);if(n!==r)return n==="Array"?1:r==="Array"?-1:n==="binary"?1:r==="binary"?-1:n==="string"?1:r==="string"?-1:n==="Date"?1:r!=="Date"?NaN:-1;switch(n){case"number":case"Date":case"string":return e>t?1:e<t?-1:0;case"binary":return Ii(Zn(e),Zn(t));case"Array":return Ri(e,t)}}catch{}return NaN}function Ri(e,t){for(var n=e.length,r=t.length,i=n<r?n:r,o=0;o<i;++o){var u=re(e[o],t[o]);if(u!==0)return u}return n===r?0:n<r?-1:1}function Ii(e,t){for(var n=e.length,r=t.length,i=n<r?n:r,o=0;o<i;++o)if(e[o]!==t[o])return e[o]<t[o]?-1:1;return n===r?0:n<r?-1:1}function Xn(e){var t=typeof e;if(t!=="object")return t;if(ArrayBuffer.isView(e))return"binary";var n=en(e);return n==="ArrayBuffer"?"binary":n}function Zn(e){return e instanceof Uint8Array?e:ArrayBuffer.isView(e)?new Uint8Array(e.buffer,e.byteOffset,e.byteLength):new Uint8Array(e)}var Pi=function(){function e(){}return e.prototype._read=function(t,n){var r=this._ctx;return r.error?r.table._trans(null,X.bind(null,r.error)):r.table._trans("readonly",t).then(n)},e.prototype._write=function(t){var n=this._ctx;return n.error?n.table._trans(null,X.bind(null,n.error)):n.table._trans("readwrite",t,"locked")},e.prototype._addAlgorithm=function(t){var n=this._ctx;n.algorithm=De(n.algorithm,t)},e.prototype._iterate=function(t,n){return gt(this._ctx,t,n,this._ctx.table.core)},e.prototype.clone=function(t){var n=Object.create(this.constructor.prototype),r=Object.create(this._ctx);return t&&ie(r,t),n._ctx=r,n},e.prototype.raw=function(){return this._ctx.valueMapper=null,this},e.prototype.each=function(t){var n=this._ctx;return this._read(function(r){return gt(n,t,r,n.table.core)})},e.prototype.count=function(t){var n=this;return this._read(function(r){var i=n._ctx,o=i.table.core;if(ke(i,!0))return o.count({trans:r,query:{index:At(i,o.schema),range:i.range}}).then(function(a){return Math.min(a,i.limit)});var u=0;return gt(i,function(){return++u,!1},r,o).then(function(){return u})}).then(t)},e.prototype.sortBy=function(t,n){var r=t.split(".").reverse(),i=r[0],o=r.length-1;function u(c,y){return y?u(c[r[y]],y-1):c[i]}var a=this._ctx.dir==="next"?1:-1;function s(c,y){var d=u(c,o),g=u(y,o);return d<g?-a:d>g?a:0}return this.toArray(function(c){return c.sort(s)}).then(n)},e.prototype.toArray=function(t){var n=this;return this._read(function(r){var i=n._ctx;if(i.dir==="next"&&ke(i,!0)&&i.limit>0){var o=i.valueMapper,u=At(i,i.table.core.schema);return i.table.core.query({trans:r,limit:i.limit,values:!0,query:{index:u,range:i.range}}).then(function(s){var c=s.result;return o?c.map(o):c})}else{var a=[];return gt(i,function(s){return a.push(s)},r,i.table.core).then(function(){return a})}},t)},e.prototype.offset=function(t){var n=this._ctx;return t<=0?this:(n.offset+=t,ke(n)?qt(n,function(){var r=t;return function(i,o){return r===0?!0:r===1?(--r,!1):(o(function(){i.advance(r),r=0}),!1)}}):qt(n,function(){var r=t;return function(){return--r<0}}),this)},e.prototype.limit=function(t){return this._ctx.limit=Math.min(this._ctx.limit,t),qt(this._ctx,function(){var n=t;return function(r,i,o){return--n<=0&&i(o),n>=0}},!0),this},e.prototype.until=function(t,n){return zt(this._ctx,function(r,i,o){return t(r.value)?(i(o),n):!0}),this},e.prototype.first=function(t){return this.limit(1).toArray(function(n){return n[0]}).then(t)},e.prototype.last=function(t){return this.reverse().first(t)},e.prototype.filter=function(t){return zt(this._ctx,function(n){return t(n.value)}),Ki(this._ctx,t),this},e.prototype.and=function(t){return this.filter(t)},e.prototype.or=function(t){return new this.db.WhereClause(this._ctx.table,t,this)},e.prototype.reverse=function(){return this._ctx.dir=this._ctx.dir==="prev"?"next":"prev",this._ondirectionchange&&this._ondirectionchange(this._ctx.dir),this},e.prototype.desc=function(){return this.reverse()},e.prototype.eachKey=function(t){var n=this._ctx;return n.keysOnly=!n.isMatch,this.each(function(r,i){t(i.key,i)})},e.prototype.eachUniqueKey=function(t){return this._ctx.unique="unique",this.eachKey(t)},e.prototype.eachPrimaryKey=function(t){var n=this._ctx;return n.keysOnly=!n.isMatch,this.each(function(r,i){t(i.primaryKey,i)})},e.prototype.keys=function(t){var n=this._ctx;n.keysOnly=!n.isMatch;var r=[];return this.each(function(i,o){r.push(o.key)}).then(function(){return r}).then(t)},e.prototype.primaryKeys=function(t){var n=this._ctx;if(n.dir==="next"&&ke(n,!0)&&n.limit>0)return this._read(function(i){var o=At(n,n.table.core.schema);return n.table.core.query({trans:i,values:!1,limit:n.limit,query:{index:o,range:n.range}})}).then(function(i){var o=i.result;return o}).then(t);n.keysOnly=!n.isMatch;var r=[];return this.each(function(i,o){r.push(o.primaryKey)}).then(function(){return r}).then(t)},e.prototype.uniqueKeys=function(t){return this._ctx.unique="unique",this.keys(t)},e.prototype.firstKey=function(t){return this.limit(1).keys(function(n){return n[0]}).then(t)},e.prototype.lastKey=function(t){return this.reverse().firstKey(t)},e.prototype.distinct=function(){var t=this._ctx,n=t.index&&t.table.schema.idxByName[t.index];if(!n||!n.multi)return this;var r={};return zt(this._ctx,function(i){var o=i.primaryKey.toString(),u=ae(r,o);return r[o]=!0,!u}),this},e.prototype.modify=function(t){var n=this,r=this._ctx;return this._write(function(i){var o;if(typeof t=="function")o=t;else{var u=Q(t),a=u.length;o=function(S){for(var E=!1,_=0;_<a;++_){var f=u[_],l=t[f];me(S,f)!==l&&(le(S,f,l),E=!0)}return E}}var s=r.table.core,c=s.schema.primaryKey,y=c.outbound,d=c.extractKey,g=n.db._options.modifyChunkSize||200,b=[],p=0,h=[],v=function(S,E){var _=E.failures,f=E.numFailures;p+=S-f;for(var l=0,m=Q(_);l<m.length;l++){var A=m[l];b.push(_[A])}};return n.clone().primaryKeys().then(function(S){var E=function(_){var f=Math.min(g,S.length-_);return s.getMany({trans:i,keys:S.slice(_,_+f),cache:"immutable"}).then(function(l){for(var m=[],A=[],x=y?[]:null,O=[],T=0;T<f;++T){var j=l[T],V={value:st(j),primKey:S[_+T]};o.call(V,V.value,V)!==!1&&(V.value==null?O.push(S[_+T]):!y&&re(d(j),d(V.value))!==0?(O.push(S[_+T]),m.push(V.value)):(A.push(V.value),y&&x.push(S[_+T])))}var N=ke(r)&&r.limit===1/0&&(typeof t!="function"||t===Ht)&&{index:r.index,range:r.range};return Promise.resolve(m.length>0&&s.mutate({trans:i,type:"add",values:m}).then(function(G){for(var k in G.failures)O.splice(parseInt(k),1);v(m.length,G)})).then(function(){return(A.length>0||N&&typeof t=="object")&&s.mutate({trans:i,type:"put",keys:x,values:A,criteria:N,changeSpec:typeof t!="function"&&t}).then(function(G){return v(A.length,G)})}).then(function(){return(O.length>0||N&&t===Ht)&&s.mutate({trans:i,type:"delete",keys:O,criteria:N}).then(function(G){return v(O.length,G)})}).then(function(){return S.length>_+f&&E(_+g)})})};return E(0).then(function(){if(b.length>0)throw new Ot("Error modifying one or more objects",b,p,h);return S.length})})})},e.prototype.delete=function(){var t=this._ctx,n=t.range;return ke(t)&&(t.isPrimKey&&!Ti||n.type===3)?this._write(function(r){var i=t.table.core.schema.primaryKey,o=n;return t.table.core.count({trans:r,query:{index:i,range:o}}).then(function(u){return t.table.core.mutate({trans:r,type:"deleteRange",range:o}).then(function(a){var s=a.failures;a.lastResult,a.results;var c=a.numFailures;if(c)throw new Ot("Could not delete some values",Object.keys(s).map(function(y){return s[y]}),u-c);return u-c})})}):this.modify(Ht)},e}(),Ht=function(e,t){return t.value=null};function Di(e){return dt(Pi.prototype,function(n,r){this.db=e;var i=Kr,o=null;if(r)try{i=r()}catch(c){o=c}var u=n._ctx,a=u.table,s=a.hook.reading.fire;this._ctx={table:a,index:u.index,isPrimKey:!u.index||a.schema.primKey.keyPath&&u.index===a.schema.primKey.name,range:i,keysOnly:!1,dir:"next",unique:"",algorithm:null,filter:null,replayFilter:null,justLimit:!0,isMatch:null,offset:0,limit:1/0,error:o,or:u.or,valueMapper:s!==lt?s:null}})}function Bi(e,t){return e<t?-1:e===t?0:1}function ki(e,t){return e>t?-1:e===t?0:1}function ue(e,t,n){var r=e instanceof Ir?new e.Collection(e):e;return r._ctx.error=n?new n(t):new TypeError(t),r}function Me(e){return new e.Collection(e,function(){return Rr("")}).limit(0)}function Mi(e){return e==="next"?function(t){return t.toUpperCase()}:function(t){return t.toLowerCase()}}function Fi(e){return e==="next"?function(t){return t.toLowerCase()}:function(t){return t.toUpperCase()}}function $i(e,t,n,r,i,o){for(var u=Math.min(e.length,r.length),a=-1,s=0;s<u;++s){var c=t[s];if(c!==r[s])return i(e[s],n[s])<0?e.substr(0,s)+n[s]+n.substr(s+1):i(e[s],r[s])<0?e.substr(0,s)+r[s]+n.substr(s+1):a>=0?e.substr(0,a)+t[a]+n.substr(a+1):null;i(e[s],c)<0&&(a=s)}return u<r.length&&o==="next"?e+n.substr(e.length):u<e.length&&o==="prev"?e.substr(0,n.length):a<0?null:e.substr(0,a)+r[a]+n.substr(a+1)}function mt(e,t,n,r){var i,o,u,a,s,c,y,d=n.length;if(!n.every(function(h){return typeof h=="string"}))return ue(e,Or);function g(h){i=Mi(h),o=Fi(h),u=h==="next"?Bi:ki;var v=n.map(function(S){return{lower:o(S),upper:i(S)}}).sort(function(S,E){return u(S.lower,E.lower)});a=v.map(function(S){return S.upper}),s=v.map(function(S){return S.lower}),c=h,y=h==="next"?"":r}g("next");var b=new e.Collection(e,function(){return _e(a[0],s[d-1]+r)});b._ondirectionchange=function(h){g(h)};var p=0;return b._addAlgorithm(function(h,v,S){var E=h.key;if(typeof E!="string")return!1;var _=o(E);if(t(_,s,p))return!0;for(var f=null,l=p;l<d;++l){var m=$i(E,_,a[l],s[l],u,c);m===null&&f===null?p=l+1:(f===null||u(f,m)>0)&&(f=m)}return v(f!==null?function(){h.continue(f+y)}:S),!1}),b}function _e(e,t,n,r){return{type:2,lower:e,upper:t,lowerOpen:n,upperOpen:r}}function Rr(e){return{type:1,lower:e,upper:e}}var Ir=function(){function e(){}return Object.defineProperty(e.prototype,"Collection",{get:function(){return this._ctx.table.db.Collection},enumerable:!1,configurable:!0}),e.prototype.between=function(t,n,r,i){r=r!==!1,i=i===!0;try{return this._cmp(t,n)>0||this._cmp(t,n)===0&&(r||i)&&!(r&&i)?Me(this):new this.Collection(this,function(){return _e(t,n,!r,!i)})}catch{return ue(this,pe)}},e.prototype.equals=function(t){return t==null?ue(this,pe):new this.Collection(this,function(){return Rr(t)})},e.prototype.above=function(t){return t==null?ue(this,pe):new this.Collection(this,function(){return _e(t,void 0,!0)})},e.prototype.aboveOrEqual=function(t){return t==null?ue(this,pe):new this.Collection(this,function(){return _e(t,void 0,!1)})},e.prototype.below=function(t){return t==null?ue(this,pe):new this.Collection(this,function(){return _e(void 0,t,!1,!0)})},e.prototype.belowOrEqual=function(t){return t==null?ue(this,pe):new this.Collection(this,function(){return _e(void 0,t)})},e.prototype.startsWith=function(t){return typeof t!="string"?ue(this,Or):this.between(t,t+Ke,!0,!0)},e.prototype.startsWithIgnoreCase=function(t){return t===""?this.startsWith(t):mt(this,function(n,r){return n.indexOf(r[0])===0},[t],Ke)},e.prototype.equalsIgnoreCase=function(t){return mt(this,function(n,r){return n===r[0]},[t],"")},e.prototype.anyOfIgnoreCase=function(){var t=ve.apply(Fe,arguments);return t.length===0?Me(this):mt(this,function(n,r){return r.indexOf(n)!==-1},t,"")},e.prototype.startsWithAnyOfIgnoreCase=function(){var t=ve.apply(Fe,arguments);return t.length===0?Me(this):mt(this,function(n,r){return r.some(function(i){return n.indexOf(i)===0})},t,Ke)},e.prototype.anyOf=function(){var t=this,n=ve.apply(Fe,arguments),r=this._cmp;try{n.sort(r)}catch{return ue(this,pe)}if(n.length===0)return Me(this);var i=new this.Collection(this,function(){return _e(n[0],n[n.length-1])});i._ondirectionchange=function(u){r=u==="next"?t._ascending:t._descending,n.sort(r)};var o=0;return i._addAlgorithm(function(u,a,s){for(var c=u.key;r(c,n[o])>0;)if(++o,o===n.length)return a(s),!1;return r(c,n[o])===0?!0:(a(function(){u.continue(n[o])}),!1)}),i},e.prototype.notEqual=function(t){return this.inAnyRange([[dn,t],[t,this.db._maxKey]],{includeLowers:!1,includeUppers:!1})},e.prototype.noneOf=function(){var t=ve.apply(Fe,arguments);if(t.length===0)return new this.Collection(this);try{t.sort(this._ascending)}catch{return ue(this,pe)}var n=t.reduce(function(r,i){return r?r.concat([[r[r.length-1][1],i]]):[[dn,i]]},null);return n.push([t[t.length-1],this.db._maxKey]),this.inAnyRange(n,{includeLowers:!1,includeUppers:!1})},e.prototype.inAnyRange=function(t,n){var r=this,i=this._cmp,o=this._ascending,u=this._descending,a=this._min,s=this._max;if(t.length===0)return Me(this);if(!t.every(function(l){return l[0]!==void 0&&l[1]!==void 0&&o(l[0],l[1])<=0}))return ue(this,"First argument to inAnyRange() must be an Array of two-value Arrays [lower,upper] where upper must not be lower than lower",D.InvalidArgument);var c=!n||n.includeLowers!==!1,y=n&&n.includeUppers===!0;function d(l,m){for(var A=0,x=l.length;A<x;++A){var O=l[A];if(i(m[0],O[1])<0&&i(m[1],O[0])>0){O[0]=a(O[0],m[0]),O[1]=s(O[1],m[1]);break}}return A===x&&l.push(m),l}var g=o;function b(l,m){return g(l[0],m[0])}var p;try{p=t.reduce(d,[]),p.sort(b)}catch{return ue(this,pe)}var h=0,v=y?function(l){return o(l,p[h][1])>0}:function(l){return o(l,p[h][1])>=0},S=c?function(l){return u(l,p[h][0])>0}:function(l){return u(l,p[h][0])>=0};function E(l){return!v(l)&&!S(l)}var _=v,f=new this.Collection(this,function(){return _e(p[0][0],p[p.length-1][1],!c,!y)});return f._ondirectionchange=function(l){l==="next"?(_=v,g=o):(_=S,g=u),p.sort(b)},f._addAlgorithm(function(l,m,A){for(var x=l.key;_(x);)if(++h,h===p.length)return m(A),!1;return E(x)?!0:(r._cmp(x,p[h][1])===0||r._cmp(x,p[h][0])===0||m(function(){g===o?l.continue(p[h][0]):l.continue(p[h][1])}),!1)}),f},e.prototype.startsWithAnyOf=function(){var t=ve.apply(Fe,arguments);return t.every(function(n){return typeof n=="string"})?t.length===0?Me(this):this.inAnyRange(t.map(function(n){return[n,n+Ke]})):ue(this,"startsWithAnyOf() only works with strings")},e}();function ji(e){return dt(Ir.prototype,function(n,r,i){this.db=e,this._ctx={table:n,index:r===":id"?null:r,or:i};var o=e._deps.indexedDB;if(!o)throw new D.MissingAPI;this._cmp=this._ascending=o.cmp.bind(o),this._descending=function(u,a){return o.cmp(a,u)},this._max=function(u,a){return o.cmp(u,a)>0?u:a},this._min=function(u,a){return o.cmp(u,a)<0?u:a},this._IDBKeyRange=e._deps.IDBKeyRange})}function he(e){return J(function(t){return it(t),e(t.target.error),!1})}function it(e){e.stopPropagation&&e.stopPropagation(),e.preventDefault&&e.preventDefault()}var ot="storagemutated",Se="x-storagemutated-1",Te=ht(null,ot),Ni=function(){function e(){}return e.prototype._lock=function(){return Ge(!I.global),++this._reculock,this._reculock===1&&!I.global&&(I.lockOwnerFor=this),this},e.prototype._unlock=function(){if(Ge(!I.global),--this._reculock===0)for(I.global||(I.lockOwnerFor=null);this._blockedFuncs.length>0&&!this._locked();){var t=this._blockedFuncs.shift();try{ze(t[1],t[0])}catch{}}return this},e.prototype._locked=function(){return this._reculock&&I.lockOwnerFor!==this},e.prototype.create=function(t){var n=this;if(!this.mode)return this;var r=this.db.idbdb,i=this.db._state.dbOpenError;if(Ge(!this.idbtrans),!t&&!r)switch(i&&i.name){case"DatabaseClosedError":throw new D.DatabaseClosed(i);case"MissingAPIError":throw new D.MissingAPI(i.message,i);default:throw new D.OpenFailed(i)}if(!this.active)throw new D.TransactionInactive;return Ge(this._completion._state===null),t=this.idbtrans=t||(this.db.core?this.db.core.transaction(this.storeNames,this.mode,{durability:this.chromeTransactionDurability}):r.transaction(this.storeNames,this.mode,{durability:this.chromeTransactionDurability})),t.onerror=J(function(o){it(o),n._reject(t.error)}),t.onabort=J(function(o){it(o),n.active&&n._reject(new D.Abort(t.error)),n.active=!1,n.on("abort").fire(o)}),t.oncomplete=J(function(){n.active=!1,n._resolve(),"mutatedParts"in t&&Te.storagemutated.fire(t.mutatedParts)}),this},e.prototype._promise=function(t,n,r){var i=this;if(t==="readwrite"&&this.mode!=="readwrite")return X(new D.ReadOnly("Transaction is readonly"));if(!this.active)return X(new D.TransactionInactive);if(this._locked())return new C(function(u,a){i._blockedFuncs.push([function(){i._promise(t,n,r).then(u,a)},I])});if(r)return xe(function(){var u=new C(function(a,s){i._lock();var c=n(a,s,i);c&&c.then&&c.then(a,s)});return u.finally(function(){return i._unlock()}),u._lib=!0,u});var o=new C(function(u,a){var s=n(u,a,i);s&&s.then&&s.then(u,a)});return o._lib=!0,o},e.prototype._root=function(){return this.parent?this.parent._root():this},e.prototype.waitFor=function(t){var n=this._root(),r=C.resolve(t);if(n._waitingFor)n._waitingFor=n._waitingFor.then(function(){return r});else{n._waitingFor=r,n._waitingQueue=[];var i=n.idbtrans.objectStore(n.storeNames[0]);(function u(){for(++n._spinCount;n._waitingQueue.length;)n._waitingQueue.shift()();n._waitingFor&&(i.get(-1/0).onsuccess=u)})()}var o=n._waitingFor;return new C(function(u,a){r.then(function(s){return n._waitingQueue.push(J(u.bind(null,s)))},function(s){return n._waitingQueue.push(J(a.bind(null,s)))}).finally(function(){n._waitingFor===o&&(n._waitingFor=null)})})},e.prototype.abort=function(){this.active&&(this.active=!1,this.idbtrans&&this.idbtrans.abort(),this._reject(new D.Abort))},e.prototype.table=function(t){var n=this._memoizedTables||(this._memoizedTables={});if(ae(n,t))return n[t];var r=this.schema[t];if(!r)throw new D.NotFound("Table "+t+" not part of transaction");var i=new this.db.Table(t,r,this);return i.core=this.db.core.table(t),n[t]=i,i},e}();function Li(e){return dt(Ni.prototype,function(n,r,i,o,u){var a=this;this.db=e,this.mode=n,this.storeNames=r,this.schema=i,this.chromeTransactionDurability=o,this.idbtrans=null,this.on=ht(this,"complete","error","abort"),this.parent=u||null,this.active=!0,this._reculock=0,this._blockedFuncs=[],this._resolve=null,this._reject=null,this._waitingFor=null,this._waitingQueue=null,this._spinCount=0,this._completion=new C(function(s,c){a._resolve=s,a._reject=c}),this._completion.then(function(){a.active=!1,a.on.complete.fire()},function(s){var c=a.active;return a.active=!1,a.on.error.fire(s),a.parent?a.parent._reject(s):c&&a.idbtrans&&a.idbtrans.abort(),X(s)})})}function pn(e,t,n,r,i,o,u){return{name:e,keyPath:t,unique:n,multi:r,auto:i,compound:o,src:(n&&!u?"&":"")+(r?"*":"")+(i?"++":"")+Pr(t)}}function Pr(e){return typeof e=="string"?e:e?"["+[].join.call(e,"+")+"]":""}function Dr(e,t,n){return{name:e,primKey:t,indexes:n,mappedClass:null,idxByName:fr(n,function(r){return[r.name,r]})}}function Vi(e){return e.length===1?e[0]:e}var ut=function(e){try{return e.only([[]]),ut=function(){return[[]]},[[]]}catch{return ut=function(){return Ke},Ke}};function yn(e){return e==null?function(){}:typeof e=="string"?Ui(e):function(t){return me(t,e)}}function Ui(e){var t=e.split(".");return t.length===1?function(n){return n[e]}:function(n){return me(n,e)}}function er(e){return[].slice.call(e)}var Wi=0;function et(e){return e==null?":id":typeof e=="string"?e:"["+e.join("+")+"]"}function zi(e,t,n){function r(d,g){var b=er(d.objectStoreNames);return{schema:{name:d.name,tables:b.map(function(p){return g.objectStore(p)}).map(function(p){var h=p.keyPath,v=p.autoIncrement,S=ne(h),E=h==null,_={},f={name:p.name,primaryKey:{name:null,isPrimaryKey:!0,outbound:E,compound:S,keyPath:h,autoIncrement:v,unique:!0,extractKey:yn(h)},indexes:er(p.indexNames).map(function(l){return p.index(l)}).map(function(l){var m=l.name,A=l.unique,x=l.multiEntry,O=l.keyPath,T=ne(O),j={name:m,compound:T,keyPath:O,unique:A,multiEntry:x,extractKey:yn(O)};return _[et(O)]=j,j}),getIndexByKeyPath:function(l){return _[et(l)]}};return _[":id"]=f.primaryKey,h!=null&&(_[et(h)]=f.primaryKey),f})},hasGetAll:b.length>0&&"getAll"in g.objectStore(b[0])&&!(typeof navigator<"u"&&/Safari/.test(navigator.userAgent)&&!/(Chrome\/|Edge\/)/.test(navigator.userAgent)&&[].concat(navigator.userAgent.match(/Safari\/(\d*)/))[1]<604)}}function i(d){if(d.type===3)return null;if(d.type===4)throw new Error("Cannot convert never type to IDBKeyRange");var g=d.lower,b=d.upper,p=d.lowerOpen,h=d.upperOpen,v=g===void 0?b===void 0?null:t.upperBound(b,!!h):b===void 0?t.lowerBound(g,!!p):t.bound(g,b,!!p,!!h);return v}function o(d){var g=d.name;function b(v){var S=v.trans,E=v.type,_=v.keys,f=v.values,l=v.range;return new Promise(function(m,A){m=J(m);var x=S.objectStore(g),O=x.keyPath==null,T=E==="put"||E==="add";if(!T&&E!=="delete"&&E!=="deleteRange")throw new Error("Invalid operation type: "+E);var j=(_||f||{length:1}).length;if(_&&f&&_.length!==f.length)throw new Error("Given keys array must have same length as given values array.");if(j===0)return m({numFailures:0,failures:{},results:[],lastResult:void 0});var V,N=[],G=[],k=0,U=function(R){++k,it(R)};if(E==="deleteRange"){if(l.type===4)return m({numFailures:k,failures:G,results:[],lastResult:void 0});l.type===3?N.push(V=x.clear()):N.push(V=x.delete(i(l)))}else{var w=T?O?[f,_]:[f,null]:[_,null],K=w[0],B=w[1];if(T)for(var P=0;P<j;++P)N.push(V=B&&B[P]!==void 0?x[E](K[P],B[P]):x[E](K[P])),V.onerror=U;else for(var P=0;P<j;++P)N.push(V=x[E](K[P])),V.onerror=U}var $=function(R){var M=R.target.result;N.forEach(function(F,W){return F.error!=null&&(G[W]=F.error)}),m({numFailures:k,failures:G,results:E==="delete"?_:N.map(function(F){return F.result}),lastResult:M})};V.onerror=function(R){U(R),$(R)},V.onsuccess=$})}function p(v){var S=v.trans,E=v.values,_=v.query,f=v.reverse,l=v.unique;return new Promise(function(m,A){m=J(m);var x=_.index,O=_.range,T=S.objectStore(g),j=x.isPrimaryKey?T:T.index(x.name),V=f?l?"prevunique":"prev":l?"nextunique":"next",N=E||!("openKeyCursor"in j)?j.openCursor(i(O),V):j.openKeyCursor(i(O),V);N.onerror=he(A),N.onsuccess=J(function(G){var k=N.result;if(!k){m(null);return}k.___id=++Wi,k.done=!1;var U=k.continue.bind(k),w=k.continuePrimaryKey;w&&(w=w.bind(k));var K=k.advance.bind(k),B=function(){throw new Error("Cursor not started")},P=function(){throw new Error("Cursor not stopped")};k.trans=S,k.stop=k.continue=k.continuePrimaryKey=k.advance=B,k.fail=J(A),k.next=function(){var $=this,R=1;return this.start(function(){return R--?$.continue():$.stop()}).then(function(){return $})},k.start=function($){var R=new Promise(function(F,W){F=J(F),N.onerror=he(W),k.fail=W,k.stop=function(H){k.stop=k.continue=k.continuePrimaryKey=k.advance=P,F(H)}}),M=function(){if(N.result)try{$()}catch(F){k.fail(F)}else k.done=!0,k.start=function(){throw new Error("Cursor behind last entry")},k.stop()};return N.onsuccess=J(function(F){N.onsuccess=M,M()}),k.continue=U,k.continuePrimaryKey=w,k.advance=K,M(),R},m(k)},A)})}function h(v){return function(S){return new Promise(function(E,_){E=J(E);var f=S.trans,l=S.values,m=S.limit,A=S.query,x=m===1/0?void 0:m,O=A.index,T=A.range,j=f.objectStore(g),V=O.isPrimaryKey?j:j.index(O.name),N=i(T);if(m===0)return E({result:[]});if(v){var G=l?V.getAll(N,x):V.getAllKeys(N,x);G.onsuccess=function(K){return E({result:K.target.result})},G.onerror=he(_)}else{var k=0,U=l||!("openKeyCursor"in V)?V.openCursor(N):V.openKeyCursor(N),w=[];U.onsuccess=function(K){var B=U.result;if(!B)return E({result:w});if(w.push(l?B.value:B.primaryKey),++k===m)return E({result:w});B.continue()},U.onerror=he(_)}})}}return{name:g,schema:d,mutate:b,getMany:function(v){var S=v.trans,E=v.keys;return new Promise(function(_,f){_=J(_);for(var l=S.objectStore(g),m=E.length,A=new Array(m),x=0,O=0,T,j=function(k){var U=k.target;(A[U._pos]=U.result)!=null,++O===x&&_(A)},V=he(f),N=0;N<m;++N){var G=E[N];G!=null&&(T=l.get(E[N]),T._pos=N,T.onsuccess=j,T.onerror=V,++x)}x===0&&_(A)})},get:function(v){var S=v.trans,E=v.key;return new Promise(function(_,f){_=J(_);var l=S.objectStore(g),m=l.get(E);m.onsuccess=function(A){return _(A.target.result)},m.onerror=he(f)})},query:h(s),openCursor:p,count:function(v){var S=v.query,E=v.trans,_=S.index,f=S.range;return new Promise(function(l,m){var A=E.objectStore(g),x=_.isPrimaryKey?A:A.index(_.name),O=i(f),T=O?x.count(O):x.count();T.onsuccess=J(function(j){return l(j.target.result)}),T.onerror=he(m)})}}}var u=r(e,n),a=u.schema,s=u.hasGetAll,c=a.tables.map(function(d){return o(d)}),y={};return c.forEach(function(d){return y[d.name]=d}),{stack:"dbcore",transaction:e.transaction.bind(e),table:function(d){var g=y[d];if(!g)throw new Error("Table '"+d+"' not found");return y[d]},MIN_KEY:-1/0,MAX_KEY:ut(t),schema:a}}function qi(e,t){return t.reduce(function(n,r){var i=r.create;return L(L({},n),i(n))},e)}function Hi(e,t,n,r){var i=n.IDBKeyRange;n.indexedDB;var o=qi(zi(t,i,r),e.dbcore);return{dbcore:o}}function Bn(e,t){var n=e._novip,r=t.db,i=Hi(n._middlewares,r,n._deps,t);n.core=i.dbcore,n.tables.forEach(function(o){var u=o.name;n.core.schema.tables.some(function(a){return a.name===u})&&(o.core=n.core.table(u),n[u]instanceof n.Table&&(n[u].core=o.core))})}function Dt(e,t,n,r){var i=e._novip;n.forEach(function(o){var u=r[o];t.forEach(function(a){var s=An(a,o);(!s||"value"in s&&s.value===void 0)&&(a===i.Transaction.prototype||a instanceof i.Transaction?be(a,o,{get:function(){return this.table(o)},set:function(c){ar(this,o,{value:c,writable:!0,configurable:!0,enumerable:!0})}}):a[o]=new i.Table(o,u))})})}function vn(e,t){var n=e._novip;t.forEach(function(r){for(var i in r)r[i]instanceof n.Table&&delete r[i]})}function Yi(e,t){return e._cfg.version-t._cfg.version}function Ji(e,t,n,r){var i=e._dbSchema,o=e._createTransaction("readwrite",e._storeNames,i);o.create(n),o._completion.catch(r);var u=o._reject.bind(o),a=I.transless||I;xe(function(){I.trans=o,I.transless=a,t===0?(Q(i).forEach(function(s){kn(n,s,i[s].primKey,i[s].indexes)}),Bn(e,n),C.follow(function(){return e.on.populate.fire(o)}).catch(u)):Gi(e,t,o,n).catch(u)})}function Gi(e,t,n,r){var i=e._novip,o=[],u=i._versions,a=i._dbSchema=Mn(i,i.idbdb,r),s=!1,c=u.filter(function(d){return d._cfg.version>=t});c.forEach(function(d){o.push(function(){var g=a,b=d._cfg.dbschema;mn(i,g,r),mn(i,b,r),a=i._dbSchema=b;var p=Br(g,b);p.add.forEach(function(f){kn(r,f[0],f[1].primKey,f[1].indexes)}),p.change.forEach(function(f){if(f.recreate)throw new D.Upgrade("Not yet support for changing primary key");var l=r.objectStore(f.name);f.add.forEach(function(m){return gn(l,m)}),f.change.forEach(function(m){l.deleteIndex(m.name),gn(l,m)}),f.del.forEach(function(m){return l.deleteIndex(m)})});var h=d._cfg.contentUpgrade;if(h&&d._cfg.version>t){Bn(i,r),n._memoizedTables={},s=!0;var v=cr(b);p.del.forEach(function(f){v[f]=g[f]}),vn(i,[i.Transaction.prototype]),Dt(i,[i.Transaction.prototype],Q(v),v),n.schema=v;var S=Tn(h);S&&We();var E,_=C.follow(function(){if(E=h(n),E&&S){var f=we.bind(null,null);E.then(f,f)}});return E&&typeof E.then=="function"?C.resolve(E):_.then(function(){return E})}}),o.push(function(g){if(!s||!Ai){var b=d._cfg.dbschema;Xi(b,g)}vn(i,[i.Transaction.prototype]),Dt(i,[i.Transaction.prototype],i._storeNames,i._dbSchema),n.schema=i._dbSchema})});function y(){return o.length?C.resolve(o.shift()(n.idbtrans)).then(y):C.resolve()}return y().then(function(){Qi(a,r)})}function Br(e,t){var n={del:[],add:[],change:[]},r;for(r in e)t[r]||n.del.push(r);for(r in t){var i=e[r],o=t[r];if(!i)n.add.push([r,o]);else{var u={name:r,def:o,recreate:!1,del:[],add:[],change:[]};if(""+(i.primKey.keyPath||"")!=""+(o.primKey.keyPath||"")||i.primKey.auto!==o.primKey.auto&&!jt)u.recreate=!0,n.change.push(u);else{var a=i.idxByName,s=o.idxByName,c=void 0;for(c in a)s[c]||u.del.push(c);for(c in s){var y=a[c],d=s[c];y?y.src!==d.src&&u.change.push(d):u.add.push(d)}(u.del.length>0||u.add.length>0||u.change.length>0)&&n.change.push(u)}}}return n}function kn(e,t,n,r){var i=e.db.createObjectStore(t,n.keyPath?{keyPath:n.keyPath,autoIncrement:n.auto}:{autoIncrement:n.auto});return r.forEach(function(o){return gn(i,o)}),i}function Qi(e,t){Q(e).forEach(function(n){t.db.objectStoreNames.contains(n)||kn(t,n,e[n].primKey,e[n].indexes)})}function Xi(e,t){[].slice.call(t.db.objectStoreNames).forEach(function(n){return e[n]==null&&t.db.deleteObjectStore(n)})}function gn(e,t){e.createIndex(t.name,t.keyPath,{unique:t.unique,multiEntry:t.multi})}function Mn(e,t,n){var r={},i=Ft(t.objectStoreNames,0);return i.forEach(function(o){for(var u=n.objectStore(o),a=u.keyPath,s=pn(Pr(a),a||"",!1,!1,!!u.autoIncrement,a&&typeof a!="string",!0),c=[],y=0;y<u.indexNames.length;++y){var d=u.index(u.indexNames[y]);a=d.keyPath;var g=pn(d.name,a,!!d.unique,!!d.multiEntry,!1,a&&typeof a!="string",!1);c.push(g)}r[o]=Dr(o,s,c)}),r}function Zi(e,t,n){var r=e._novip;r.verno=t.version/10;var i=r._dbSchema=Mn(r,t,n);r._storeNames=Ft(t.objectStoreNames,0),Dt(r,[r._allTables],Q(i),i)}function eo(e,t){var n=Mn(e,e.idbdb,t),r=Br(n,e._dbSchema);return!(r.add.length||r.change.some(function(i){return i.add.length||i.change.length}))}function mn(e,t,n){for(var r=e._novip,i=n.db.objectStoreNames,o=0;o<i.length;++o){var u=i[o],a=n.objectStore(u);r._hasGetAll="getAll"in a;for(var s=0;s<a.indexNames.length;++s){var c=a.indexNames[s],y=a.index(c).keyPath,d=typeof y=="string"?y:"["+Ft(y).join("+")+"]";if(t[u]){var g=t[u].idxByName[d];g&&(g.name=c,delete t[u].idxByName[d],t[u].idxByName[c]=g)}}}typeof navigator<"u"&&/Safari/.test(navigator.userAgent)&&!/(Chrome\/|Edge\/)/.test(navigator.userAgent)&&Y.WorkerGlobalScope&&Y instanceof Y.WorkerGlobalScope&&[].concat(navigator.userAgent.match(/Safari\/(\d*)/))[1]<604&&(r._hasGetAll=!1)}function to(e){return e.split(",").map(function(t,n){t=t.trim();var r=t.replace(/([&*]|\+\+)/g,""),i=/^\[/.test(r)?r.match(/^\[(.*)\]$/)[1].split("+"):r;return pn(r,i||null,/\&/.test(t),/\*/.test(t),/\+\+/.test(t),ne(i),n===0)})}var no=function(){function e(){}return e.prototype._parseStoresSpec=function(t,n){Q(t).forEach(function(r){if(t[r]!==null){var i=to(t[r]),o=i.shift();if(o.multi)throw new D.Schema("Primary key cannot be multi-valued");i.forEach(function(u){if(u.auto)throw new D.Schema("Only primary key can be marked as autoIncrement (++)");if(!u.keyPath)throw new D.Schema("Index must have a name and cannot be an empty string")}),n[r]=Dr(r,o,i)}})},e.prototype.stores=function(t){var n=this.db;this._cfg.storesSource=this._cfg.storesSource?ie(this._cfg.storesSource,t):t;var r=n._versions,i={},o={};return r.forEach(function(u){ie(i,u._cfg.storesSource),o=u._cfg.dbschema={},u._parseStoresSpec(i,o)}),n._dbSchema=o,vn(n,[n._allTables,n,n.Transaction.prototype]),Dt(n,[n._allTables,n,n.Transaction.prototype,this._cfg.tables],Q(o),o),n._storeNames=Q(o),this},e.prototype.upgrade=function(t){return this._cfg.contentUpgrade=Kn(this._cfg.contentUpgrade||z,t),this},e}();function ro(e){return dt(no.prototype,function(n){this.db=e,this._cfg={version:n,storesSource:null,dbschema:{},tables:{},contentUpgrade:null}})}function Fn(e,t){var n=e._dbNamesDB;return n||(n=e._dbNamesDB=new Ln(Nt,{addons:[],indexedDB:e,IDBKeyRange:t}),n.version(1).stores({dbnames:"name"})),n.table("dbnames")}function $n(e){return e&&typeof e.databases=="function"}function io(e){var t=e.indexedDB,n=e.IDBKeyRange;return $n(t)?Promise.resolve(t.databases()).then(function(r){return r.map(function(i){return i.name}).filter(function(i){return i!==Nt})}):Fn(t,n).toCollection().primaryKeys()}function oo(e,t){var n=e.indexedDB,r=e.IDBKeyRange;!$n(n)&&t!==Nt&&Fn(n,r).put({name:t}).catch(z)}function uo(e,t){var n=e.indexedDB,r=e.IDBKeyRange;!$n(n)&&t!==Nt&&Fn(n,r).delete(t).catch(z)}function bn(e){return xe(function(){return I.letThrough=!0,e()})}function ao(){var e=!navigator.userAgentData&&/Safari\//.test(navigator.userAgent)&&!/Chrom(e|ium)\//.test(navigator.userAgent);if(!e||!indexedDB.databases)return Promise.resolve();var t;return new Promise(function(n){var r=function(){return indexedDB.databases().finally(n)};t=setInterval(r,100),r()}).finally(function(){return clearInterval(t)})}function so(e){var t=e._state,n=e._deps.indexedDB;if(t.isBeingOpened||e.idbdb)return t.dbReadyPromise.then(function(){return t.dbOpenError?X(t.dbOpenError):e});de&&(t.openCanceller._stackHolder=Be()),t.isBeingOpened=!0,t.dbOpenError=null,t.openComplete=!1;var r=t.openCanceller;function i(){if(t.openCanceller!==r)throw new D.DatabaseClosed("db.open() was cancelled")}var o=t.dbReadyResolve,u=null,a=!1;return C.race([r,(typeof navigator>"u"?C.resolve():ao()).then(function(){return new C(function(s,c){if(i(),!n)throw new D.MissingAPI;var y=e.name,d=t.autoSchema?n.open(y):n.open(y,Math.round(e.verno*10));if(!d)throw new D.MissingAPI;d.onerror=he(c),d.onblocked=J(e._fireOnBlocked),d.onupgradeneeded=J(function(g){if(u=d.transaction,t.autoSchema&&!e._options.allowEmptyDB){d.onerror=it,u.abort(),d.result.close();var b=n.deleteDatabase(y);b.onsuccess=b.onerror=J(function(){c(new D.NoSuchDatabase("Database "+y+" doesnt exist"))})}else{u.onerror=he(c);var p=g.oldVersion>Math.pow(2,62)?0:g.oldVersion;a=p<1,e._novip.idbdb=d.result,Ji(e,p/10,u,c)}},c),d.onsuccess=J(function(){u=null;var g=e._novip.idbdb=d.result,b=Ft(g.objectStoreNames);if(b.length>0)try{var p=g.transaction(Vi(b),"readonly");t.autoSchema?Zi(e,g,p):(mn(e,e._dbSchema,p),eo(e,p)||console.warn("Dexie SchemaDiff: Schema was extended without increasing the number passed to db.version(). Some queries may fail.")),Bn(e,p)}catch{}Ze.push(e),g.onversionchange=J(function(h){t.vcFired=!0,e.on("versionchange").fire(h)}),g.onclose=J(function(h){e.on("close").fire(h)}),a&&oo(e._deps,y),s()},c)})})]).then(function(){return i(),t.onReadyBeingFired=[],C.resolve(bn(function(){return e.on.ready.fire(e.vip)})).then(function s(){if(t.onReadyBeingFired.length>0){var c=t.onReadyBeingFired.reduce(Kn,z);return t.onReadyBeingFired=[],C.resolve(bn(function(){return c(e.vip)})).then(s)}})}).finally(function(){t.onReadyBeingFired=null,t.isBeingOpened=!1}).then(function(){return e}).catch(function(s){t.dbOpenError=s;try{u&&u.abort()}catch{}return r===t.openCanceller&&e._close(),X(s)}).finally(function(){t.openComplete=!0,o()})}function wn(e){var t=function(u){return e.next(u)},n=function(u){return e.throw(u)},r=o(t),i=o(n);function o(u){return function(a){var s=u(a),c=s.value;return s.done?c:!c||typeof c.then!="function"?ne(c)?Promise.all(c).then(r,i):r(c):c.then(r,i)}}return o(t)()}function lo(e,t,n){var r=arguments.length;if(r<2)throw new D.InvalidArgument("Too few arguments");for(var i=new Array(r-1);--r;)i[r-1]=arguments[r];n=i.pop();var o=hr(i);return[e,o,n]}function kr(e,t,n,r,i){return C.resolve().then(function(){var o=I.transless||I,u=e._createTransaction(t,n,e._dbSchema,r),a={trans:u,transless:o};if(r)u.idbtrans=r.idbtrans;else try{u.create(),e._state.PR1398_maxLoop=3}catch(d){return d.name===Cn.InvalidState&&e.isOpen()&&--e._state.PR1398_maxLoop>0?(console.warn("Dexie: Need to reopen db"),e._close(),e.open().then(function(){return kr(e,t,n,null,i)})):X(d)}var s=Tn(i);s&&We();var c,y=C.follow(function(){if(c=i.call(u,u),c)if(s){var d=we.bind(null,null);c.then(d,d)}else typeof c.next=="function"&&typeof c.throw=="function"&&(c=wn(c))},a);return(c&&typeof c.then=="function"?C.resolve(c).then(function(d){return u.active?d:X(new D.PrematureCommit("Transaction committed too early. See http://bit.ly/2kdckMn"))}):y.then(function(){return c})).then(function(d){return r&&u._resolve(),u._completion.then(function(){return d})}).catch(function(d){return u._reject(d),X(d)})})}function bt(e,t,n){for(var r=ne(e)?e.slice():[e],i=0;i<n;++i)r.push(t);return r}function fo(e){return L(L({},e),{table:function(t){var n=e.table(t),r=n.schema,i={},o=[];function u(h,v,S){var E=et(h),_=i[E]=i[E]||[],f=h==null?0:typeof h=="string"?1:h.length,l=v>0,m=L(L({},S),{isVirtual:l,keyTail:v,keyLength:f,extractKey:yn(h),unique:!l&&S.unique});if(_.push(m),m.isPrimaryKey||o.push(m),f>1){var A=f===2?h[0]:h.slice(0,f-1);u(A,v+1,S)}return _.sort(function(x,O){return x.keyTail-O.keyTail}),m}var a=u(r.primaryKey.keyPath,0,r.primaryKey);i[":id"]=[a];for(var s=0,c=r.indexes;s<c.length;s++){var y=c[s];u(y.keyPath,0,y)}function d(h){var v=i[et(h)];return v&&v[0]}function g(h,v){return{type:h.type===1?2:h.type,lower:bt(h.lower,h.lowerOpen?e.MAX_KEY:e.MIN_KEY,v),lowerOpen:!0,upper:bt(h.upper,h.upperOpen?e.MIN_KEY:e.MAX_KEY,v),upperOpen:!0}}function b(h){var v=h.query.index;return v.isVirtual?L(L({},h),{query:{index:v,range:g(h.query.range,v.keyTail)}}):h}var p=L(L({},n),{schema:L(L({},r),{primaryKey:a,indexes:o,getIndexByKeyPath:d}),count:function(h){return n.count(b(h))},query:function(h){return n.query(b(h))},openCursor:function(h){var v=h.query.index,S=v.keyTail,E=v.isVirtual,_=v.keyLength;if(!E)return n.openCursor(h);function f(l){function m(x){x!=null?l.continue(bt(x,h.reverse?e.MAX_KEY:e.MIN_KEY,S)):h.unique?l.continue(l.key.slice(0,_).concat(h.reverse?e.MIN_KEY:e.MAX_KEY,S)):l.continue()}var A=Object.create(l,{continue:{value:m},continuePrimaryKey:{value:function(x,O){l.continuePrimaryKey(bt(x,e.MAX_KEY,S),O)}},primaryKey:{get:function(){return l.primaryKey}},key:{get:function(){var x=l.key;return _===1?x[0]:x.slice(0,_)}},value:{get:function(){return l.value}}});return A}return n.openCursor(b(h)).then(function(l){return l&&f(l)})}});return p}})}var co={stack:"dbcore",name:"VirtualIndexMiddleware",level:1,create:fo};function jn(e,t,n,r){return n=n||{},r=r||"",Q(e).forEach(function(i){if(!ae(t,i))n[r+i]=void 0;else{var o=e[i],u=t[i];if(typeof o=="object"&&typeof u=="object"&&o&&u){var a=en(o),s=en(u);a!==s?n[r+i]=t[i]:a==="Object"?jn(o,u,n,r+i+"."):o!==u&&(n[r+i]=t[i])}else o!==u&&(n[r+i]=t[i])}}),Q(t).forEach(function(i){ae(e,i)||(n[r+i]=t[i])}),n}function ho(e,t){return t.type==="delete"?t.keys:t.keys||t.values.map(e.extractKey)}var po={stack:"dbcore",name:"HooksMiddleware",level:2,create:function(e){return L(L({},e),{table:function(t){var n=e.table(t),r=n.schema.primaryKey,i=L(L({},n),{mutate:function(o){var u=I.trans,a=u.table(t).hook,s=a.deleting,c=a.creating,y=a.updating;switch(o.type){case"add":if(c.fire===z)break;return u._promise("readwrite",function(){return d(o)},!0);case"put":if(c.fire===z&&y.fire===z)break;return u._promise("readwrite",function(){return d(o)},!0);case"delete":if(s.fire===z)break;return u._promise("readwrite",function(){return d(o)},!0);case"deleteRange":if(s.fire===z)break;return u._promise("readwrite",function(){return g(o)},!0)}return n.mutate(o);function d(p){var h=I.trans,v=p.keys||ho(r,p);if(!v)throw new Error("Keys missing");return p=p.type==="add"||p.type==="put"?L(L({},p),{keys:v}):L({},p),p.type!=="delete"&&(p.values=Xt([],p.values,!0)),p.keys&&(p.keys=Xt([],p.keys,!0)),yo(n,p,v).then(function(S){var E=v.map(function(_,f){var l=S[f],m={onerror:null,onsuccess:null};if(p.type==="delete")s.fire.call(m,_,l,h);else if(p.type==="add"||l===void 0){var A=c.fire.call(m,_,p.values[f],h);_==null&&A!=null&&(_=A,p.keys[f]=_,r.outbound||le(p.values[f],r.keyPath,_))}else{var x=jn(l,p.values[f]),O=y.fire.call(m,x,_,l,h);if(O){var T=p.values[f];Object.keys(O).forEach(function(j){ae(T,j)?T[j]=O[j]:le(T,j,O[j])})}}return m});return n.mutate(p).then(function(_){for(var f=_.failures,l=_.results,m=_.numFailures,A=_.lastResult,x=0;x<v.length;++x){var O=l?l[x]:v[x],T=E[x];O==null?T.onerror&&T.onerror(f[x]):T.onsuccess&&T.onsuccess(p.type==="put"&&S[x]?p.values[x]:O)}return{failures:f,results:l,numFailures:m,lastResult:A}}).catch(function(_){return E.forEach(function(f){return f.onerror&&f.onerror(_)}),Promise.reject(_)})})}function g(p){return b(p.trans,p.range,1e4)}function b(p,h,v){return n.query({trans:p,values:!1,query:{index:r,range:h},limit:v}).then(function(S){var E=S.result;return d({type:"delete",keys:E,trans:p}).then(function(_){return _.numFailures>0?Promise.reject(_.failures[0]):E.length<v?{failures:[],numFailures:0,lastResult:void 0}:b(p,L(L({},h),{lower:E[E.length-1],lowerOpen:!0}),v)})})}}});return i}})}};function yo(e,t,n){return t.type==="add"?Promise.resolve([]):e.getMany({trans:t.trans,keys:n,cache:"immutable"})}function Mr(e,t,n){try{if(!t||t.keys.length<e.length)return null;for(var r=[],i=0,o=0;i<t.keys.length&&o<e.length;++i)re(t.keys[i],e[o])===0&&(r.push(n?st(t.values[i]):t.values[i]),++o);return r.length===e.length?r:null}catch{return null}}var vo={stack:"dbcore",level:-1,create:function(e){return{table:function(t){var n=e.table(t);return L(L({},n),{getMany:function(r){if(!r.cache)return n.getMany(r);var i=Mr(r.keys,r.trans._cache,r.cache==="clone");return i?C.resolve(i):n.getMany(r).then(function(o){return r.trans._cache={keys:r.keys,values:r.cache==="clone"?st(o):o},o})},mutate:function(r){return r.type!=="add"&&(r.trans._cache=null),n.mutate(r)}})}}}},Yt;function Nn(e){return!("from"in e)}var ye=function(e,t){if(this)ie(this,arguments.length?{d:1,from:e,to:arguments.length>1?t:e}:{d:0});else{var n=new ye;return e&&"d"in e&&ie(n,e),n}};Ne(ye.prototype,(Yt={add:function(e){return Bt(this,e),this},addKey:function(e){return at(this,e,e),this},addKeys:function(e){var t=this;return e.forEach(function(n){return at(t,n,n)}),this}},Yt[tn]=function(){return _n(this)},Yt));function at(e,t,n){var r=re(t,n);if(!isNaN(r)){if(r>0)throw RangeError();if(Nn(e))return ie(e,{from:t,to:n,d:1});var i=e.l,o=e.r;if(re(n,e.from)<0)return i?at(i,t,n):e.l={from:t,to:n,d:1,l:null,r:null},tr(e);if(re(t,e.to)>0)return o?at(o,t,n):e.r={from:t,to:n,d:1,l:null,r:null},tr(e);re(t,e.from)<0&&(e.from=t,e.l=null,e.d=o?o.d+1:1),re(n,e.to)>0&&(e.to=n,e.r=null,e.d=e.l?e.l.d+1:1);var u=!e.r;i&&!e.l&&Bt(e,i),o&&u&&Bt(e,o)}}function Bt(e,t){function n(r,i){var o=i.from,u=i.to,a=i.l,s=i.r;at(r,o,u),a&&n(r,a),s&&n(r,s)}Nn(t)||n(e,t)}function go(e,t){var n=_n(t),r=n.next();if(r.done)return!1;for(var i=r.value,o=_n(e),u=o.next(i.from),a=u.value;!r.done&&!u.done;){if(re(a.from,i.to)<=0&&re(a.to,i.from)>=0)return!0;re(i.from,a.from)<0?i=(r=n.next(a.from)).value:a=(u=o.next(i.from)).value}return!1}function _n(e){var t=Nn(e)?null:{s:0,n:e};return{next:function(n){for(var r=arguments.length>0;t;)switch(t.s){case 0:if(t.s=1,r)for(;t.n.l&&re(n,t.n.from)<0;)t={up:t,n:t.n.l,s:1};else for(;t.n.l;)t={up:t,n:t.n.l,s:1};case 1:if(t.s=2,!r||re(n,t.n.to)<=0)return{value:t.n,done:!1};case 2:if(t.n.r){t.s=3,t={up:t,n:t.n.r,s:0};continue}case 3:t=t.up}return{done:!0}}}}function tr(e){var t,n,r=(((t=e.r)===null||t===void 0?void 0:t.d)||0)-(((n=e.l)===null||n===void 0?void 0:n.d)||0),i=r>1?"r":r<-1?"l":"";if(i){var o=i==="r"?"l":"r",u=L({},e),a=e[i];e.from=a.from,e.to=a.to,e[i]=a[i],u[i]=a[o],e[o]=u,u.d=nr(u)}e.d=nr(e)}function nr(e){var t=e.r,n=e.l;return(t?n?Math.max(t.d,n.d):t.d:n?n.d:0)+1}var mo={stack:"dbcore",level:0,create:function(e){var t=e.schema.name,n=new ye(e.MIN_KEY,e.MAX_KEY);return L(L({},e),{table:function(r){var i=e.table(r),o=i.schema,u=o.primaryKey,a=u.extractKey,s=u.outbound,c=L(L({},i),{mutate:function(g){var b=g.trans,p=b.mutatedParts||(b.mutatedParts={}),h=function(A){var x="idb://"+t+"/"+r+"/"+A;return p[x]||(p[x]=new ye)},v=h(""),S=h(":dels"),E=g.type,_=g.type==="deleteRange"?[g.range]:g.type==="delete"?[g.keys]:g.values.length<50?[[],g.values]:[],f=_[0],l=_[1],m=g.trans._cache;return i.mutate(g).then(function(A){if(ne(f)){E!=="delete"&&(f=A.results),v.addKeys(f);var x=Mr(f,m);!x&&E!=="add"&&S.addKeys(f),(x||l)&&bo(h,o,x,l)}else if(f){var O={from:f.lower,to:f.upper};S.add(O),v.add(O)}else v.add(n),S.add(n),o.indexes.forEach(function(T){return h(T.name).add(n)});return A})}}),y=function(g){var b,p,h=g.query,v=h.index,S=h.range;return[v,new ye((b=S.lower)!==null&&b!==void 0?b:e.MIN_KEY,(p=S.upper)!==null&&p!==void 0?p:e.MAX_KEY)]},d={get:function(g){return[u,new ye(g.key)]},getMany:function(g){return[u,new ye().addKeys(g.keys)]},count:y,query:y,openCursor:y};return Q(d).forEach(function(g){c[g]=function(b){var p=I.subscr;if(p){var h=function(m){var A="idb://"+t+"/"+r+"/"+m;return p[A]||(p[A]=new ye)},v=h(""),S=h(":dels"),E=d[g](b),_=E[0],f=E[1];if(h(_.name||"").add(f),!_.isPrimaryKey)if(g==="count")S.add(n);else{var l=g==="query"&&s&&b.values&&i.query(L(L({},b),{values:!1}));return i[g].apply(this,arguments).then(function(m){if(g==="query"){if(s&&b.values)return l.then(function(T){var j=T.result;return v.addKeys(j),m});var A=b.values?m.result.map(a):m.result;b.values?v.addKeys(A):S.addKeys(A)}else if(g==="openCursor"){var x=m,O=b.values;return x&&Object.create(x,{key:{get:function(){return S.addKey(x.primaryKey),x.key}},primaryKey:{get:function(){var T=x.primaryKey;return S.addKey(T),T}},value:{get:function(){return O&&v.addKey(x.primaryKey),x.value}}})}return m})}}return i[g].apply(this,arguments)}}),c}})}};function bo(e,t,n,r){function i(o){var u=e(o.name||"");function a(c){return c!=null?o.extractKey(c):null}var s=function(c){return o.multiEntry&&ne(c)?c.forEach(function(y){return u.addKey(y)}):u.addKey(c)};(n||r).forEach(function(c,y){var d=n&&a(n[y]),g=r&&a(r[y]);re(d,g)!==0&&(d!=null&&s(d),g!=null&&s(g))})}t.indexes.forEach(i)}var Ln=function(){function e(t,n){var r=this;this._middlewares={},this.verno=0;var i=e.dependencies;this._options=n=L({addons:e.addons,autoOpen:!0,indexedDB:i.indexedDB,IDBKeyRange:i.IDBKeyRange},n),this._deps={indexedDB:n.indexedDB,IDBKeyRange:n.IDBKeyRange};var o=n.addons;this._dbSchema={},this._versions=[],this._storeNames=[],this._allTables={},this.idbdb=null,this._novip=this;var u={dbOpenError:null,isBeingOpened:!1,onReadyBeingFired:null,openComplete:!1,dbReadyResolve:z,dbReadyPromise:null,cancelOpen:z,openCanceller:null,autoSchema:!0,PR1398_maxLoop:3};u.dbReadyPromise=new C(function(a){u.dbReadyResolve=a}),u.openCanceller=new C(function(a,s){u.cancelOpen=s}),this._state=u,this.name=t,this.on=ht(this,"populate","blocked","versionchange","close",{ready:[Kn,z]}),this.on.ready.subscribe=sr(this.on.ready.subscribe,function(a){return function(s,c){e.vip(function(){var y=r._state;if(y.openComplete)y.dbOpenError||C.resolve().then(s),c&&a(s);else if(y.onReadyBeingFired)y.onReadyBeingFired.push(s),c&&a(s);else{a(s);var d=r;c||a(function g(){d.on.ready.unsubscribe(s),d.on.ready.unsubscribe(g)})}})}}),this.Collection=Di(this),this.Table=Ci(this),this.Transaction=Li(this),this.Version=ro(this),this.WhereClause=ji(this),this.on("versionchange",function(a){a.newVersion>0?console.warn("Another connection wants to upgrade database '"+r.name+"'. Closing db now to resume the upgrade."):console.warn("Another connection wants to delete database '"+r.name+"'. Closing db now to resume the delete request."),r.close()}),this.on("blocked",function(a){!a.newVersion||a.newVersion<a.oldVersion?console.warn("Dexie.delete('"+r.name+"') was blocked"):console.warn("Upgrade '"+r.name+"' blocked by other connection holding version "+a.oldVersion/10)}),this._maxKey=ut(n.IDBKeyRange),this._createTransaction=function(a,s,c,y){return new r.Transaction(a,s,c,r._options.chromeTransactionDurability,y)},this._fireOnBlocked=function(a){r.on("blocked").fire(a),Ze.filter(function(s){return s.name===r.name&&s!==r&&!s._state.vcFired}).map(function(s){return s.on("versionchange").fire(a)})},this.use(co),this.use(po),this.use(mo),this.use(vo),this.vip=Object.create(this,{_vip:{value:!0}}),o.forEach(function(a){return a(r)})}return e.prototype.version=function(t){if(isNaN(t)||t<.1)throw new D.Type("Given version is not a positive number");if(t=Math.round(t*10)/10,this.idbdb||this._state.isBeingOpened)throw new D.Schema("Cannot add version when database is open");this.verno=Math.max(this.verno,t);var n=this._versions,r=n.filter(function(i){return i._cfg.version===t})[0];return r||(r=new this.Version(t),n.push(r),n.sort(Yi),r.stores({}),this._state.autoSchema=!1,r)},e.prototype._whenReady=function(t){var n=this;return this.idbdb&&(this._state.openComplete||I.letThrough||this._vip)?t():new C(function(r,i){if(n._state.openComplete)return i(new D.DatabaseClosed(n._state.dbOpenError));if(!n._state.isBeingOpened){if(!n._options.autoOpen){i(new D.DatabaseClosed);return}n.open().catch(z)}n._state.dbReadyPromise.then(r,i)}).then(t)},e.prototype.use=function(t){var n=t.stack,r=t.create,i=t.level,o=t.name;o&&this.unuse({stack:n,name:o});var u=this._middlewares[n]||(this._middlewares[n]=[]);return u.push({stack:n,create:r,level:i??10,name:o}),u.sort(function(a,s){return a.level-s.level}),this},e.prototype.unuse=function(t){var n=t.stack,r=t.name,i=t.create;return n&&this._middlewares[n]&&(this._middlewares[n]=this._middlewares[n].filter(function(o){return i?o.create!==i:r?o.name!==r:!1})),this},e.prototype.open=function(){return so(this)},e.prototype._close=function(){var t=this._state,n=Ze.indexOf(this);if(n>=0&&Ze.splice(n,1),this.idbdb){try{this.idbdb.close()}catch{}this._novip.idbdb=null}t.dbReadyPromise=new C(function(r){t.dbReadyResolve=r}),t.openCanceller=new C(function(r,i){t.cancelOpen=i})},e.prototype.close=function(){this._close();var t=this._state;this._options.autoOpen=!1,t.dbOpenError=new D.DatabaseClosed,t.isBeingOpened&&t.cancelOpen(t.dbOpenError)},e.prototype.delete=function(){var t=this,n=arguments.length>0,r=this._state;return new C(function(i,o){var u=function(){t.close();var a=t._deps.indexedDB.deleteDatabase(t.name);a.onsuccess=J(function(){uo(t._deps,t.name),i()}),a.onerror=he(o),a.onblocked=t._fireOnBlocked};if(n)throw new D.InvalidArgument("Arguments not allowed in db.delete()");r.isBeingOpened?r.dbReadyPromise.then(u):u()})},e.prototype.backendDB=function(){return this.idbdb},e.prototype.isOpen=function(){return this.idbdb!==null},e.prototype.hasBeenClosed=function(){var t=this._state.dbOpenError;return t&&t.name==="DatabaseClosed"},e.prototype.hasFailed=function(){return this._state.dbOpenError!==null},e.prototype.dynamicallyOpened=function(){return this._state.autoSchema},Object.defineProperty(e.prototype,"tables",{get:function(){var t=this;return Q(this._allTables).map(function(n){return t._allTables[n]})},enumerable:!1,configurable:!0}),e.prototype.transaction=function(){var t=lo.apply(this,arguments);return this._transaction.apply(this,t)},e.prototype._transaction=function(t,n,r){var i=this,o=I.trans;(!o||o.db!==this||t.indexOf("!")!==-1)&&(o=null);var u=t.indexOf("?")!==-1;t=t.replace("!","").replace("?","");var a,s;try{if(s=n.map(function(y){var d=y instanceof i.Table?y.name:y;if(typeof d!="string")throw new TypeError("Invalid table argument to Dexie.transaction(). Only Table or String are allowed");return d}),t=="r"||t===Ut)a=Ut;else if(t=="rw"||t==Wt)a=Wt;else throw new D.InvalidArgument("Invalid transaction mode: "+t);if(o){if(o.mode===Ut&&a===Wt)if(u)o=null;else throw new D.SubTransaction("Cannot enter a sub-transaction with READWRITE mode when parent transaction is READONLY");o&&s.forEach(function(y){if(o&&o.storeNames.indexOf(y)===-1)if(u)o=null;else throw new D.SubTransaction("Table "+y+" not included in parent transaction.")}),u&&o&&!o.active&&(o=null)}}catch(y){return o?o._promise(null,function(d,g){g(y)}):X(y)}var c=kr.bind(null,this,a,s,o,r);return o?o._promise(a,c,"lock"):I.trans?ze(I.transless,function(){return i._whenReady(c)}):this._whenReady(c)},e.prototype.table=function(t){if(!ae(this._allTables,t))throw new D.InvalidTable("Table "+t+" does not exist");return this._allTables[t]},e}(),wo=typeof Symbol<"u"&&"observable"in Symbol?Symbol.observable:"@@observable",_o=function(){function e(t){this._subscribe=t}return e.prototype.subscribe=function(t,n,r){return this._subscribe(!t||typeof t=="function"?{next:t,error:n,complete:r}:t)},e.prototype[wo]=function(){return this},e}();function Fr(e,t){return Q(t).forEach(function(n){var r=e[n]||(e[n]=new ye);Bt(r,t[n])}),e}function Eo(e){return new _o(function(t){var n=Tn(e);function r(b){n&&We();var p=function(){return xe(e,{subscr:b,trans:null})},h=I.trans?ze(I.transless,p):p();return n&&h.then(we,we),h}var i=!1,o={},u={},a={get closed(){return i},unsubscribe:function(){i=!0,Te.storagemutated.unsubscribe(d)}};t.start&&t.start(a);var s=!1,c=!1;function y(){return Q(u).some(function(b){return o[b]&&go(o[b],u[b])})}var d=function(b){Fr(o,b),y()&&g()},g=function(){if(!(s||i)){o={};var b={},p=r(b);c||(Te(ot,d),c=!0),s=!0,Promise.resolve(p).then(function(h){s=!1,!i&&(y()?g():(o={},u=b,t.next&&t.next(h)))},function(h){s=!1,t.error&&t.error(h),a.unsubscribe()})}};return g(),a})}var En;try{En={indexedDB:Y.indexedDB||Y.mozIndexedDB||Y.webkitIndexedDB||Y.msIndexedDB,IDBKeyRange:Y.IDBKeyRange||Y.webkitIDBKeyRange}}catch{En={indexedDB:null,IDBKeyRange:null}}var Oe=Ln;Ne(Oe,L(L({},$t),{delete:function(e){var t=new Oe(e,{addons:[]});return t.delete()},exists:function(e){return new Oe(e,{addons:[]}).open().then(function(t){return t.close(),!0}).catch("NoSuchDatabaseError",function(){return!1})},getDatabaseNames:function(e){try{return io(Oe.dependencies).then(e)}catch{return X(new D.MissingAPI)}},defineClass:function(){function e(t){ie(this,t)}return e},ignoreTransaction:function(e){return I.trans?ze(I.transless,e):e()},vip:bn,async:function(e){return function(){try{var t=wn(e.apply(this,arguments));return!t||typeof t.then!="function"?C.resolve(t):t}catch(n){return X(n)}}},spawn:function(e,t,n){try{var r=wn(e.apply(n,t||[]));return!r||typeof r.then!="function"?C.resolve(r):r}catch(i){return X(i)}},currentTransaction:{get:function(){return I.trans||null}},waitFor:function(e,t){var n=C.resolve(typeof e=="function"?Oe.ignoreTransaction(e):e).timeout(t||6e4);return I.trans?I.trans.waitFor(n):n},Promise:C,debug:{get:function(){return de},set:function(e){pr(e,e==="dexie"?function(){return!0}:Cr)}},derive:Ve,extend:ie,props:Ne,override:sr,Events:ht,on:Te,liveQuery:Eo,extendObservabilitySet:Fr,getByKeyPath:me,setByKeyPath:le,delByKeyPath:Zr,shallowClone:cr,deepClone:st,getObjectDiff:jn,cmp:re,asap:lr,minKey:dn,addons:[],connections:Ze,errnames:Cn,dependencies:En,semVer:Jn,version:Jn.split(".").map(function(e){return parseInt(e)}).reduce(function(e,t,n){return e+t/Math.pow(10,n*2)})}));Oe.maxKey=ut(Oe.dependencies.IDBKeyRange);typeof dispatchEvent<"u"&&typeof addEventListener<"u"&&(Te(ot,function(e){if(!ge){var t;jt?(t=document.createEvent("CustomEvent"),t.initCustomEvent(Se,!0,!0,e)):t=new CustomEvent(Se,{detail:e}),ge=!0,dispatchEvent(t),ge=!1}}),addEventListener(Se,function(e){var t=e.detail;ge||kt(t)}));function kt(e){var t=ge;try{ge=!0,Te.storagemutated.fire(e)}finally{ge=t}}var ge=!1;if(typeof BroadcastChannel<"u"){var rr=new BroadcastChannel(Se);Te(ot,function(e){ge||rr.postMessage(e)}),rr.onmessage=function(e){e.data&&kt(e.data)}}else if(typeof self<"u"&&typeof navigator<"u"){Te(ot,function(e){try{ge||(typeof localStorage<"u"&&localStorage.setItem(Se,JSON.stringify({trig:Math.random(),changedParts:e})),typeof self.clients=="object"&&Xt([],self.clients.matchAll({includeUncontrolled:!0}),!0).forEach(function(t){return t.postMessage({type:Se,changedParts:e})}))}catch{}}),typeof addEventListener<"u"&&addEventListener("storage",function(e){if(e.key===Se){var t=JSON.parse(e.newValue);t&&kt(t.changedParts)}});var ir=self.document&&navigator.serviceWorker;ir&&ir.addEventListener("message",So)}function So(e){var t=e.data;t&&t.type===Se&&kt(t.changedParts)}C.rejectionMapper=si;pr(de,Cr);var Mt={},xo={get exports(){return Mt},set exports(e){Mt=e}};(function(e,t){const{hasOwnProperty:n}=Object.prototype,r=_();r.configure=_,r.stringify=r,r.default=r,t.stringify=r,t.configure=_,e.exports=r;const i=/[\u0000-\u001f\u0022\u005c\ud800-\udfff]|[\ud800-\udbff](?![\udc00-\udfff])|(?:[^\ud800-\udbff]|^)[\udc00-\udfff]/,o=new RegExp(i,"g"),u=["\\u0000","\\u0001","\\u0002","\\u0003","\\u0004","\\u0005","\\u0006","\\u0007","\\b","\\t","\\n","\\u000b","\\f","\\r","\\u000e","\\u000f","\\u0010","\\u0011","\\u0012","\\u0013","\\u0014","\\u0015","\\u0016","\\u0017","\\u0018","\\u0019","\\u001a","\\u001b","\\u001c","\\u001d","\\u001e","\\u001f","","",'\\"',"","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","\\\\"];function a(f){if(f.length===2){const m=f.charCodeAt(1);return`${f[0]}\\u${m.toString(16)}`}const l=f.charCodeAt(0);return u.length>l?u[l]:`\\u${l.toString(16)}`}function s(f){if(f.length<5e3&&!i.test(f))return f;if(f.length>100)return f.replace(o,a);let l="",m=0;for(let A=0;A<f.length;A++){const x=f.charCodeAt(A);if(x===34||x===92||x<32)l+=`${f.slice(m,A)}${u[x]}`,m=A+1;else if(x>=55296&&x<=57343){if(x<=56319&&A+1<f.length){const O=f.charCodeAt(A+1);if(O>=56320&&O<=57343){A++;continue}}l+=`${f.slice(m,A)}\\u${x.toString(16)}`,m=A+1}}return l+=f.slice(m),l}function c(f){if(f.length>200)return f.sort();for(let l=1;l<f.length;l++){const m=f[l];let A=l;for(;A!==0&&f[A-1]>m;)f[A]=f[A-1],A--;f[A]=m}return f}const y=Object.getOwnPropertyDescriptor(Object.getPrototypeOf(Object.getPrototypeOf(new Int8Array)),Symbol.toStringTag).get;function d(f){return y.call(f)!==void 0&&f.length!==0}function g(f,l,m){f.length<m&&(m=f.length);const A=l===","?"":" ";let x=`"0":${A}${f[0]}`;for(let O=1;O<m;O++)x+=`${l}"${O}":${A}${f[O]}`;return x}function b(f){if(n.call(f,"circularValue")){const l=f.circularValue;if(typeof l=="string")return`"${l}"`;if(l==null)return l;if(l===Error||l===TypeError)return{toString(){throw new TypeError("Converting circular structure to JSON")}};throw new TypeError('The "circularValue" argument must be of type string or the value null or undefined')}return'"[Circular]"'}function p(f,l){let m;if(n.call(f,l)&&(m=f[l],typeof m!="boolean"))throw new TypeError(`The "${l}" argument must be of type boolean`);return m===void 0?!0:m}function h(f,l){let m;if(n.call(f,l)){if(m=f[l],typeof m!="number")throw new TypeError(`The "${l}" argument must be of type number`);if(!Number.isInteger(m))throw new TypeError(`The "${l}" argument must be an integer`);if(m<1)throw new RangeError(`The "${l}" argument must be >= 1`)}return m===void 0?1/0:m}function v(f){return f===1?"1 item":`${f} items`}function S(f){const l=new Set;for(const m of f)(typeof m=="string"||typeof m=="number")&&l.add(String(m));return l}function E(f){if(n.call(f,"strict")){const l=f.strict;if(typeof l!="boolean")throw new TypeError('The "strict" argument must be of type boolean');if(l)return m=>{let A=`Object can not safely be stringified. Received type ${typeof m}`;throw typeof m!="function"&&(A+=` (${m.toString()})`),new Error(A)}}}function _(f){f={...f};const l=E(f);l&&(f.bigint===void 0&&(f.bigint=!1),"circularValue"in f||(f.circularValue=Error));const m=b(f),A=p(f,"bigint"),x=p(f,"deterministic"),O=h(f,"maximumDepth"),T=h(f,"maximumBreadth");function j(U,w,K,B,P,$){let R=w[U];switch(typeof R=="object"&&R!==null&&typeof R.toJSON=="function"&&(R=R.toJSON(U)),R=B.call(w,U,R),typeof R){case"string":return`"${s(R)}"`;case"object":{if(R===null)return"null";if(K.indexOf(R)!==-1)return m;let M="",F=",";const W=$;if(Array.isArray(R)){if(R.length===0)return"[]";if(O<K.length+1)return'"[Array]"';K.push(R),P!==""&&($+=P,M+=`
${$}`,F=`,
${$}`);const oe=Math.min(R.length,T);let fe=0;for(;fe<oe-1;fe++){const pt=j(fe,R,K,B,P,$);M+=pt!==void 0?pt:"null",M+=F}const ce=j(fe,R,K,B,P,$);if(M+=ce!==void 0?ce:"null",R.length-1>T){const pt=R.length-T-1;M+=`${F}"... ${v(pt)} not stringified"`}return P!==""&&(M+=`
${W}`),K.pop(),`[${M}]`}let H=Object.keys(R);const Z=H.length;if(Z===0)return"{}";if(O<K.length+1)return'"[Object]"';let q="",ee="";P!==""&&($+=P,F=`,
${$}`,q=" ");let se=Math.min(Z,T);d(R)&&(M+=g(R,F,T),H=H.slice(R.length),se-=R.length,ee=F),x&&(H=c(H)),K.push(R);for(let oe=0;oe<se;oe++){const fe=H[oe],ce=j(fe,R,K,B,P,$);ce!==void 0&&(M+=`${ee}"${s(fe)}":${q}${ce}`,ee=F)}if(Z>T){const oe=Z-T;M+=`${ee}"...":${q}"${v(oe)} not stringified"`,ee=F}return P!==""&&ee.length>1&&(M=`
${$}${M}
${W}`),K.pop(),`{${M}}`}case"number":return isFinite(R)?String(R):l?l(R):"null";case"boolean":return R===!0?"true":"false";case"undefined":return;case"bigint":if(A)return String(R);default:return l?l(R):void 0}}function V(U,w,K,B,P,$){switch(typeof w=="object"&&w!==null&&typeof w.toJSON=="function"&&(w=w.toJSON(U)),typeof w){case"string":return`"${s(w)}"`;case"object":{if(w===null)return"null";if(K.indexOf(w)!==-1)return m;const R=$;let M="",F=",";if(Array.isArray(w)){if(w.length===0)return"[]";if(O<K.length+1)return'"[Array]"';K.push(w),P!==""&&($+=P,M+=`
${$}`,F=`,
${$}`);const Z=Math.min(w.length,T);let q=0;for(;q<Z-1;q++){const se=V(q,w[q],K,B,P,$);M+=se!==void 0?se:"null",M+=F}const ee=V(q,w[q],K,B,P,$);if(M+=ee!==void 0?ee:"null",w.length-1>T){const se=w.length-T-1;M+=`${F}"... ${v(se)} not stringified"`}return P!==""&&(M+=`
${R}`),K.pop(),`[${M}]`}K.push(w);let W="";P!==""&&($+=P,F=`,
${$}`,W=" ");let H="";for(const Z of B){const q=V(Z,w[Z],K,B,P,$);q!==void 0&&(M+=`${H}"${s(Z)}":${W}${q}`,H=F)}return P!==""&&H.length>1&&(M=`
${$}${M}
${R}`),K.pop(),`{${M}}`}case"number":return isFinite(w)?String(w):l?l(w):"null";case"boolean":return w===!0?"true":"false";case"undefined":return;case"bigint":if(A)return String(w);default:return l?l(w):void 0}}function N(U,w,K,B,P){switch(typeof w){case"string":return`"${s(w)}"`;case"object":{if(w===null)return"null";if(typeof w.toJSON=="function"){if(w=w.toJSON(U),typeof w!="object")return N(U,w,K,B,P);if(w===null)return"null"}if(K.indexOf(w)!==-1)return m;const $=P;if(Array.isArray(w)){if(w.length===0)return"[]";if(O<K.length+1)return'"[Array]"';K.push(w),P+=B;let q=`
${P}`;const ee=`,
${P}`,se=Math.min(w.length,T);let oe=0;for(;oe<se-1;oe++){const ce=N(oe,w[oe],K,B,P);q+=ce!==void 0?ce:"null",q+=ee}const fe=N(oe,w[oe],K,B,P);if(q+=fe!==void 0?fe:"null",w.length-1>T){const ce=w.length-T-1;q+=`${ee}"... ${v(ce)} not stringified"`}return q+=`
${$}`,K.pop(),`[${q}]`}let R=Object.keys(w);const M=R.length;if(M===0)return"{}";if(O<K.length+1)return'"[Object]"';P+=B;const F=`,
${P}`;let W="",H="",Z=Math.min(M,T);d(w)&&(W+=g(w,F,T),R=R.slice(w.length),Z-=w.length,H=F),x&&(R=c(R)),K.push(w);for(let q=0;q<Z;q++){const ee=R[q],se=N(ee,w[ee],K,B,P);se!==void 0&&(W+=`${H}"${s(ee)}": ${se}`,H=F)}if(M>T){const q=M-T;W+=`${H}"...": "${v(q)} not stringified"`,H=F}return H!==""&&(W=`
${P}${W}
${$}`),K.pop(),`{${W}}`}case"number":return isFinite(w)?String(w):l?l(w):"null";case"boolean":return w===!0?"true":"false";case"undefined":return;case"bigint":if(A)return String(w);default:return l?l(w):void 0}}function G(U,w,K){switch(typeof w){case"string":return`"${s(w)}"`;case"object":{if(w===null)return"null";if(typeof w.toJSON=="function"){if(w=w.toJSON(U),typeof w!="object")return G(U,w,K);if(w===null)return"null"}if(K.indexOf(w)!==-1)return m;let B="";if(Array.isArray(w)){if(w.length===0)return"[]";if(O<K.length+1)return'"[Array]"';K.push(w);const F=Math.min(w.length,T);let W=0;for(;W<F-1;W++){const Z=G(W,w[W],K);B+=Z!==void 0?Z:"null",B+=","}const H=G(W,w[W],K);if(B+=H!==void 0?H:"null",w.length-1>T){const Z=w.length-T-1;B+=`,"... ${v(Z)} not stringified"`}return K.pop(),`[${B}]`}let P=Object.keys(w);const $=P.length;if($===0)return"{}";if(O<K.length+1)return'"[Object]"';let R="",M=Math.min($,T);d(w)&&(B+=g(w,",",T),P=P.slice(w.length),M-=w.length,R=","),x&&(P=c(P)),K.push(w);for(let F=0;F<M;F++){const W=P[F],H=G(W,w[W],K);H!==void 0&&(B+=`${R}"${s(W)}":${H}`,R=",")}if($>T){const F=$-T;B+=`${R}"...":"${v(F)} not stringified"`}return K.pop(),`{${B}}`}case"number":return isFinite(w)?String(w):l?l(w):"null";case"boolean":return w===!0?"true":"false";case"undefined":return;case"bigint":if(A)return String(w);default:return l?l(w):void 0}}function k(U,w,K){if(arguments.length>1){let B="";if(typeof K=="number"?B=" ".repeat(Math.min(K,10)):typeof K=="string"&&(B=K.slice(0,10)),w!=null){if(typeof w=="function")return j("",{"":U},[],w,B,"");if(Array.isArray(w))return V("",U,[],S(w),B,"")}if(B.length!==0)return N("",U,[],B,"")}return G("",U,[])}return k}})(xo,Mt);const $r=Mt;$r.configure;const Le=$r;function Ao(e,t,n=30,r=null){let i=[];for(let o of e){o={...o},delete o.limit,delete o.since,delete o.until;let u=new Map;for(let a of Co(o))u.set(Le(a),[]);for(let a of t)To(u,o,a);for(let[a,s]of u)Oo(i,a,s,n,r)}return i}function Ye(e,t,n,r,i=null,o=!1){if(n){if(t[n]&&t[n].length>1){for(let u of t[n])if(o){for(let a of r.tags)if(a[0]==i&&a[1]===u){Jt(e,{...t,[n]:[u]},r);break}}else if(i!=null&&r[i]===u){Jt(e,{...t,[n]:[u]},r);break}return!0}return!1}else Jt(e,t,r)}function Jt(e,t,n){let r=Le(t),i=e.get(r);i?i.push(n):e.set(r,[n])}function To(e,t,n){Ye(e,t,"authors",n,"pubkey",!1)||Ye(e,t,"ids",n,"ids",!1)||Ye(e,t,"#p",n,"p",!0)||Ye(e,t,"#e",n,"e",!0)||Ye(e,t,null,n)}function Oo(e,t,n,r,i){n=n.sort((o,u)=>o.created_at-u.created_at);for(let o=0;o<n.length;o+=r)r>1||n.length==1?e.push({filter:t,events:n.slice(o,o+r)}):e.push({filter:t,event:n[o]});i&&e.push({filter:t,query_info:i})}function Co(e){let t=[];if(e.authors&&e.authors.length>1)for(let n of e.authors)t.push({...e,authors:[n]});else if(e.ids&&e.ids.length>1)for(let n of e.ids)t.push({...e,ids:[n]});else if(e["#p"]&&e["#p"].length>1)for(let n of e["#p"])t.push({...e,"#p":[n]});else if(e["#e"]&&e["#e"].length>1)for(let n of e["#e"])t.push({...e,"#e":[n]});else t.push(e);return t}class Ko extends Ln{constructor(){super("nostr_events",{chromeTransactionDurability:"relaxed"}),this.version(1).stores({events:"++,filter"})}}const jr=new Ko;function Je(e,t,n){return t?e[t]&&e[t].length>1?n.anyOf(e[t].map(r=>Le({...e,[t]:[r]}))):null:n.equals(Le(e))}function Ro(e,t){let n=Je(e,"authors",t)||Je(e,"ids",t)||Je(e,"#p",t)||Je(e,"#e",t)||Je(e,null,t);if(!n)throw new Error("splitWhereClause bug");return n}function Nr(e,t,n=30,r=null){console.log("putEvents called with ",t.length," events");let i=Ao(e,t,n,r);return jr.events.bulkPut(i)}function Io(e){let t;for(let n of e){let r=t?t.or("filter"):jr.events.where("filter");n={...n},delete n.limit,t=Ro(n,r)}return t?t.toArray().then(n=>{let r=n.map(o=>o.events||o.event||[]).flat(),i=n.filter(o=>o.query_info);return{events:r,query_infos:i}}):new Promise(n=>({events:[],query_infos:[]}))}function Po(e,t){return e.reduce((n,r)=>(n[t(r)]=r,n),new Map)}function Vn(e,t){return e.reduce((n,r)=>{const i=t(r);return n.get(i)||n.set(i,[]),n.get(i).push(r),n},new Map)}function Do(e){return[...new Set(e)]}function Bo(e,t){return new Map(Array.from(e.entries()).map(([n,r])=>[n,t(r)]))}function ko(e,t){if(t={...t},t.ids){if(t.ids=t.ids.filter(n=>!e.find(r=>r.id==je(n))),!t.ids.length)return null}else if(t.authors){if(t.authors=t.authors.filter(n=>!e.find(r=>r.pubkey==je(n))),!t.authors.length)return null}else throw new Error("onlyOne option not supported for this filter"+Le(t));return t}function Mo(e,t,n,r,i){let o=[];for(let u of t){u={...u};let a=n.onlyOne;if(u.ids&&u.ids.length==0||u.authors&&u.authors.length==0||u.kinds&&u.kinds.length==0){console.timeLog(e,"no need to send subscription because filter is empty");continue}if(u.ids&&(a=!0),a){let c=ko(r,u);if(!c){console.timeLog(e,"no need to send subscription because all events are already in the database");continue}u=c}if(u.authors&&!u.retrieve_old){console.log("splitting by authors",u.authors),console.log("events",r);let c=Vn(r,g=>g.pubkey),y=Bo(c,g=>Math.max(...g.map(b=>b.created_at)));console.log("last_created_at_by_author",y);let d=[];for(let g of u.authors){let b=y.get(je(g));if(b==null)d.push(g);else{let p={...u};p.authors=[g],p.since=b+1,o.push(Tt(p))}}if(d.length==0)continue;u.authors=d}let s=!1;for(let c of Object.keys(u)){if(!c.startsWith("#"))continue;let y=u[c];console.log("Splitting by tag",c,y);let d=[];for(let g of y){let b=c.slice(1),p=Math.max(...r.filter(h=>h.tags.find(v=>v[0]==b&&v[1]==g)).map(h=>h.created_at));if(console.log("last_created_at",p,b,g),p==null)d.push(g);else{let h={...u};h[c]=[g],h.since=p+1,o.push(Tt(h))}}if(d.length==0){s=!0;break}u[c]=d}s||o.push(Tt(u))}if(o.length!=0)return o}let je=e=>typeof e=="string"?e:e[0];function Tt(e){let t={};e.ids&&(t.ids=e.ids.map(je)),e.kinds&&(t.kinds=e.kinds),e.authors&&(t.authors=e.authors.map(je)),e.since&&(t.since=e.since),e.until&&(t.until=e.until),e.limit&&(t.limit=e.limit);for(let n of Object.keys(e))n.startsWith("#")&&(t[n]=e[n].map(je));return t}function Fo(e){var t,n;let r=!1,i=[];var o={},u={connect:[],disconnect:[],error:[],notice:[]},a={},s={};async function c(){return new Promise((b,p)=>{t=new WebSocket(e),t.onopen=()=>{r=!0;for(let h in o)d(["REQ",h,...o[h].filters]);for(let h of i)t.send(h);i=[],u.connect.forEach(h=>h()),b()},t.onerror=()=>{u.error.forEach(h=>h()),p()},t.onclose=async()=>{r=!1,u.disconnect.forEach(h=>h()),n&&n()},t.onmessage=async h=>{var S,E,_,f;var v;try{v=JSON.parse(h.data)}catch{v=h.data}if(v.length>=1)switch(v[0]){case"EVENT":if(v.length!==3)return;let l=v[1],m=v[2];qr(m)&&o[l]&&(o[l].skipVerification||Hr(m))&&Yr(o[l].filters,m)&&(o[l],(((S=a[l])==null?void 0:S.event)||[]).forEach(x=>x(m)));return;case"EOSE":{if(v.length!==2)return;let x=v[1];(((E=a[x])==null?void 0:E.eose)||[]).forEach(O=>O());return}case"OK":{if(v.length<3)return;let x=v[1],O=v[2],T=v[3]||"";O?(_=s[x])==null||_.ok.forEach(j=>j()):(f=s[x])==null||f.failed.forEach(j=>j(T));return}case"NOTICE":if(v.length!==2)return;let A=v[1];u.notice.forEach(x=>x(A));return}}})}async function y(){t!=null&&t.readyState&&t.readyState===1||await c()}async function d(b){let p=JSON.stringify(b);r?t.send(p):i.push(p)}const g=(b,{skipVerification:p=!1,id:h=Math.random().toString().slice(2)}={})=>{let v=h;return o[v]={id:v,filters:b,skipVerification:p},r&&d(["REQ",v,...b]),{sub:(S,E={})=>g(S||b,{skipVerification:E.skipVerification||p,id:v}),unsub:()=>{delete o[v],delete a[v],r&&d(["CLOSE",v])},on:(S,E)=>{a[v]=a[v]||{event:[],eose:[]},a[v][S].push(E)},off:(S,E)=>{let _=a[v],f=_[S].indexOf(E);f>=0&&_[S].splice(f,1)}}};return{url:e,sub:g,on:(b,p)=>{u[b].push(p),b==="connect"&&(t==null?void 0:t.readyState)===1&&p()},off:(b,p)=>{let h=u[b].indexOf(p);h!==-1&&u[b].splice(h,1)},publish(b){if(!b.id)throw new Error(`event ${b} has no id`);let p=b.id;var h=!1,v=!1;d(["EVENT",b]).then(()=>{h=!0,v&&(S(),v=!1)}).catch(()=>{});const S=()=>{let E=g([{ids:[p]}],{id:`monitor-${p.slice(0,5)}`}),_=setTimeout(()=>{var f;(((f=s[p])==null?void 0:f.failed)||[]).forEach(l=>l("event not seen after 5 seconds")),E.unsub()},5e3);E.on("event",()=>{var f;clearTimeout(_),(((f=s[p])==null?void 0:f.seen)||[]).forEach(l=>l())})};return{on:(E,_)=>{s[p]=s[p]||{ok:[],seen:[],failed:[]},s[p][E].push(_),E==="seen"&&(h?S():v=!0)},off:(E,_)=>{let f=s[p];if(!f)return;let l=f[E].indexOf(_);l>=0&&f[E].splice(l,1)}}},connect:y,close(){return t.close(),new Promise(b=>{n=b})},get status(){return(t==null?void 0:t.readyState)??3}}}var Gt=e=>[...new Set(e)],$o=class{constructor(e){He(this,"relayByUrl");if(this.relayByUrl=new Map,e)for(let t of Gt(e))this.addOrGetRelay(t)}addOrGetRelay(e){let t=this.relayByUrl.get(e);return t||(t=Fo(e),this.relayByUrl.set(e,t),t.connect().then(n=>{},n=>{console.warn("failed to connect to relay "+e)}),t)}close(){for(let e of this.relayByUrl.values())e.close();this.relayByUrl.clear()}sub(e,t){t=Gt(t);let n=[];for(let r of t){let i=this.addOrGetRelay(r);n.push(i.sub(e))}return new jo(n,t)}publish(e,t){for(let n of Gt(t))this.addOrGetRelay(n).publish(e)}onnotice(e){this.relayByUrl.forEach((t,n)=>t.on("notice",r=>e(n+": "+r)))}onerror(e){this.relayByUrl.forEach((t,n)=>t.on("error",r=>e(n+": "+r)))}ondisconnect(e){this.relayByUrl.forEach((t,n)=>t.on("disconnect",r=>e(n+": "+r)))}},jo=class{constructor(e,t){He(this,"subscriptions");He(this,"eventsBySub");He(this,"urlsBySub");this.subscriptions=e,this.eventsBySub=new Map,this.urlsBySub=new Map;for(let n=0;n<e.length;n++)this.urlsBySub.set(e[n],t[n])}onevent(e){return this.subscriptions.forEach(t=>{this.eventsBySub.set(t,[]),t.on("event",n=>{let r=this.eventsBySub.get(t);r&&r.push(n),e(n,r===void 0,this.urlsBySub.get(t))})}),()=>{this.subscriptions.forEach(t=>t.off("event",e))}}oneose(e){return this.subscriptions.forEach(t=>t.on("eose",()=>{let n=this.eventsBySub.get(t);this.eventsBySub.delete(t),e(n,this.urlsBySub.get(t))})),()=>{this.subscriptions.forEach(t=>t.off("eose",e))}}unsub(){this.subscriptions.forEach(e=>e.unsub())}};let Qt=0,No=["wss://relay.damus.io","wss://nostr.fmt.wiz.biz","wss://nostr.bongbong.com","wss://nostr-2.zebedee.cloud","wss://nostr.zaprite.io","wss://relay.nostr.ch","wss://nostr.delo.software","wss://nostr.nodeofsven.com","wss://nostr.oxtr.dev","wss://nostr-relay.wlvs.space","wss://nostr-pub.wellorder.net","wss://nostr-relay.wlvs.space"];const Lt=new $o([]);Lt.onerror=e=>{console.log("RelayPool error",e)};Lt.onnotice(e=>{console.log("RelayPool notice",e)});function Un(e,t){for(let n of e)if(n.id==t)return!0;return!1}let Lo=e=>{var t;(t=e.sub)==null||t.unsub(),e.sub=void 0};function Vo(e,t){e.query_info.eose_received_at=Sn(),e.query_info.total_events=e.events.length,e.query_info.new_events=t.length;let n=t.filter(r=>!Un(e.storedEvents,r.id));console.timeLog(e.label,"EOSE with "+t.length+" events, from that "+n.length+" not stored yet, total events seen: ",e.events.length,", total events stored: ",e.storedEvents.length,", query_info: ",e.query_info),console.log("Writing query info",e.query_info),Nr(e.filters,n,void 0,e.query_info),e.storedEvents=e.storedEvents.concat(n),e.changed&&e.callback&&e.callback(e.events)}function Uo(e,t,n){e.changed=!0,e.events.push(t);let r=!1;n?(r=!0,console.time("callback"),e.callback(e.events),console.timeEnd("callback")):e.newEvents.push(t),r&&(Un(e.storedEvents,t.id)||(Nr(e.filters,[t]),e.storedEvents.push(t)))}function Wo(e,t,n){e.query_info.received_events++,Un(e.events,t.id)||Uo(e,t,n)}Lt.ondisconnect(e=>{console.log("relay disconnected",e)});function zo(e){console.log("relay.sub",e.subText,...e.filters);let t=Lt.sub(e.filters,No);e.sub=t,t.onevent((n,r)=>{console.log("event",e.subText,n),Wo(e,n,r)}),t.oneose((n,r)=>{console.log("eose received at",r),n?Vo(e,n):console.warn("eose received without events (server sent eose twice")})}const Sn=()=>Math.floor(Date.now()/1e3);function Lr(e,t,n={}){let r=Le(e);console.time(r);let i="sub"+Qt;Qt=Qt+1;let o=Sn(),u;return Io(e.map(Tt)).then(({events:a,query_infos:s})=>{let c=a.length;if(a.length&&t(a),n.offline){console.timeLog(r,"offline mode, no subscription",a,s),console.timeEnd();return}let y=Mo(r,e,n,a);console.timeLog(r,`got ${c} indexedDB events for filter, query_infos`,s,"filter_result",y),y&&(u={events:a,callback:t,filters:y,changed:!1,options:n,label:r,subText:i,newEvents:[],storedEvents:a,query_info:{db_queried_at:o,req_sent_at:Sn(),received_events:0}},console.log("sending subscription REQ",i,...u.filters,", original label",u.label,", req_sent_at",u.query_info.req_sent_at),zo(u))}),()=>{u&&(console.timeEnd(u.label),Lo(u),u.callback=null)}}function qe(e,t){return console.log("subscribeAndCacheResultsStore",t),or([],function(r){return Lr(e,r,t)})}function Wn(e,t,n){let r=null;return or([],function(o){return e.subscribe(u=>{r&&r(),r=Lr(t(u),o,n)}),()=>{r&&r()}})}let qo=(e,t=500)=>qe([{authors:[e],limit:t}]),Ho=(e,t=500)=>qe([{"#p":[e],limit:t}]),Yo=(e,t)=>Wn(e,n=>{let r={kinds:[0],authors:[t]};console.log("filtering profiles",n);for(let i=0;i<n.length;i++){let o=n[i];r.authors=Do(r.authors.concat(o.tags.filter(u=>u[0]=="p"&&u[1]&&u[1].length>8).map(u=>u[1])))}return[r]},{onlyOne:!0}),Jo=e=>xn(e,t=>Po(t,n=>n.pubkey)),Go=e=>xn(e,t=>{var r;return((r=t.findLast(i=>i.kind===Ce.Contacts))==null?void 0:r.tags.map(i=>i[1]))||[]}),Qo=e=>t=>t.filter(n=>n.kind===e),Xo=(e,t=500)=>Wn(e,n=>[{authors:n,limit:t}]),Vr=e=>{let t=e.filter(i=>i.kind==Ce.Text).map(i=>i.tags).flat().filter(i=>i[0]=="e").map(i=>i.slice(1)),n=Vn(t,i=>i[0]),r=[];for(let[i,o]of n){let u=o.map(a=>a.slice(1)).flat();r.push([i,...new Set(u)])}return{ids:r}},Zo=e=>xn(qe([Vr(e)],{onlyOne:!0}),t=>Vn(t,n=>n.id));function eu(e,t=null){const{subscribe:n,set:r}=ur(JSON.parse(localStorage.getItem(e))||t);return{subscribe:n,set:i=>{localStorage.setItem(e,JSON.stringify(i)),r(i)}}}function Ur(e,t=null){const{subscribe:n,set:r}=ur(localStorage.getItem(e)||t);return{subscribe:n,set:i=>{localStorage.setItem(e,i),r(i)}}}let tu=()=>Ur("nostr_profile_state");async function nu(e,t={}){let n=qe([{kinds:[Ce.Contacts],authors:[e]}],{onlyOne:!0,...t});return new Promise((r,i)=>{n.subscribe(o=>{o.length>0&&r(o[0].tags.filter(u=>u[0]=="p").map(u=>u[1]))})})}let ru=(e,t,n)=>qe([{authors:[e],limit:200},{"#p":[e],limit:200},{authors:[e],kinds:[Ce.Contacts]},{authors:[e],kinds:[Ce.Metadata]},{authors:t,limit:50},{"#p":t,limit:50},{authors:t,kinds:[Ce.Contacts]},{authors:t,kinds:[Ce.Metadata]}],n);const au=Object.freeze(Object.defineProperty({__proto__:null,subscribeAndCacheResultsStore:qe,derivedSubscribeStore:Wn,publishedStore:qo,receivedStore:Ho,publishedProfilesStore:Yo,publishedProfilesByPubKeyStore:Jo,contactsStore:Go,filterByKind:Qo,eventsFromFollowedStore:Xo,repliesFilter:Vr,repliesStore:Zo,localStorageJSONStore:eu,localStorageStore:Ur,profileStateLocalStore:tu,getFollowed:nu,getEvents:ru},Symbol.toStringTag,{value:"Module"}));export{ru as a,Io as b,qe as c,au as d,Vn as g,Po as m,Vr as r,Tt as s};
