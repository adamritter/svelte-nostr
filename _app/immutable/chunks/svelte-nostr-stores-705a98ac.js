import{n as Rn,v as Ir,b as Pr,m as Br,K as ge}from"./nostr.esm-d2518f25.js";import{r as Yn,d as hn,w as Qn}from"./index-fd964354.js";/*! *****************************************************************************
Copyright (c) Microsoft Corporation.
Permission to use, copy, modify, and/or distribute this software for any
purpose with or without fee is hereby granted.
THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH
REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY
AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT,
INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM
LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR
OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
PERFORMANCE OF THIS SOFTWARE.
***************************************************************************** */var D=function(){return D=Object.assign||function(t){for(var n,r=1,i=arguments.length;r<i;r++){n=arguments[r];for(var a in n)Object.prototype.hasOwnProperty.call(n,a)&&(t[a]=n[a])}return t},D.apply(this,arguments)};function Lt(e,t,n){if(n||arguments.length===2)for(var r=0,i=t.length,a;r<i;r++)(a||!(r in t))&&(a||(a=Array.prototype.slice.call(t,0,r)),a[r]=t[r]);return e.concat(a||Array.prototype.slice.call(t))}var M=typeof globalThis<"u"?globalThis:typeof self<"u"?self:typeof window<"u"?window:global,N=Object.keys,W=Array.isArray;typeof Promise<"u"&&!M.Promise&&(M.Promise=Promise);function U(e,t){return typeof t!="object"||N(t).forEach(function(n){e[n]=t[n]}),e}var qe=Object.getPrototypeOf,Mr={}.hasOwnProperty;function H(e,t){return Mr.call(e,t)}function De(e,t){typeof t=="function"&&(t=t(qe(e))),(typeof Reflect>"u"?N:Reflect.ownKeys)(t).forEach(function(n){oe(e,n,t[n])})}var Jn=Object.defineProperty;function oe(e,t,n,r){Jn(e,t,U(n&&H(n,"get")&&typeof n.get=="function"?{get:n.get,set:n.set,configurable:!0}:{value:n,configurable:!0,writable:!0},r))}function Re(e){return{from:function(t){return e.prototype=Object.create(t.prototype),oe(e.prototype,"constructor",e),{extend:De.bind(null,e.prototype)}}}}var Fr=Object.getOwnPropertyDescriptor;function dn(e,t){var n=Fr(e,t),r;return n||(r=qe(e))&&dn(r,t)}var Nr=[].slice;function Kt(e,t,n){return Nr.call(e,t,n)}function Xn(e,t){return t(e)}function Le(e){if(!e)throw new Error("Assertion Failed")}function Gn(e){M.setImmediate?setImmediate(e):setTimeout(e,0)}function $n(e,t){return e.reduce(function(n,r,i){var a=t(r,i);return a&&(n[a[0]]=a[1]),n},{})}function jr(e,t,n){try{e.apply(null,n)}catch(r){t&&t(r)}}function ue(e,t){if(H(e,t))return e[t];if(!t)return e;if(typeof t!="string"){for(var n=[],r=0,i=t.length;r<i;++r){var a=ue(e,t[r]);n.push(a)}return n}var u=t.indexOf(".");if(u!==-1){var o=e[t.substr(0,u)];return o===void 0?void 0:ue(o,t.substr(u+1))}}function G(e,t,n){if(!(!e||t===void 0)&&!("isFrozen"in Object&&Object.isFrozen(e)))if(typeof t!="string"&&"length"in t){Le(typeof n!="string"&&"length"in n);for(var r=0,i=t.length;r<i;++r)G(e,t[r],n[r])}else{var a=t.indexOf(".");if(a!==-1){var u=t.substr(0,a),o=t.substr(a+1);if(o==="")n===void 0?W(e)&&!isNaN(parseInt(u))?e.splice(u,1):delete e[u]:e[u]=n;else{var s=e[u];(!s||!H(e,u))&&(s=e[u]={}),G(s,o,n)}}else n===void 0?W(e)&&!isNaN(parseInt(t))?e.splice(t,1):delete e[t]:e[t]=n}}function Lr(e,t){typeof t=="string"?G(e,t,void 0):"length"in t&&[].map.call(t,function(n){G(e,n,void 0)})}function Zn(e){var t={};for(var n in e)H(e,n)&&(t[n]=e[n]);return t}var Vr=[].concat;function er(e){return Vr.apply([],e)}var tr="Boolean,String,Date,RegExp,Blob,File,FileList,FileSystemFileHandle,ArrayBuffer,DataView,Uint8ClampedArray,ImageBitmap,ImageData,Map,Set,CryptoKey".split(",").concat(er([8,16,32,64].map(function(e){return["Int","Uint","Float"].map(function(t){return t+e+"Array"})}))).filter(function(e){return M[e]}),Wr=tr.map(function(e){return M[e]});$n(tr,function(e){return[e,!0]});var he=null;function $e(e){he=typeof WeakMap<"u"&&new WeakMap;var t=Vt(e);return he=null,t}function Vt(e){if(!e||typeof e!="object")return e;var t=he&&he.get(e);if(t)return t;if(W(e)){t=[],he&&he.set(e,t);for(var n=0,r=e.length;n<r;++n)t.push(Vt(e[n]))}else if(Wr.indexOf(e.constructor)>=0)t=e;else{var i=qe(e);t=i===Object.prototype?{}:Object.create(i),he&&he.set(e,t);for(var a in e)H(e,a)&&(t[a]=Vt(e[a]))}return t}var zr={}.toString;function Wt(e){return zr.call(e).slice(8,-1)}var zt=typeof Symbol<"u"?Symbol.iterator:"@@iterator",Ur=typeof zt=="symbol"?function(e){var t;return e!=null&&(t=e[zt])&&t.apply(e)}:function(){return null},Ce={};function ie(e){var t,n,r,i;if(arguments.length===1){if(W(e))return e.slice();if(this===Ce&&typeof e=="string")return[e];if(i=Ur(e)){for(n=[];r=i.next(),!r.done;)n.push(r.value);return n}if(e==null)return[e];if(t=e.length,typeof t=="number"){for(n=new Array(t);t--;)n[t]=e[t];return n}return[e]}for(t=arguments.length,n=new Array(t);t--;)n[t]=arguments[t];return n}var pn=typeof Symbol<"u"?function(e){return e[Symbol.toStringTag]==="AsyncFunction"}:function(){return!1},te=typeof location<"u"&&/^(http|https):\/\/(localhost|127\.0\.0\.1)/.test(location.href);function nr(e,t){te=e,rr=t}var rr=function(){return!0},qr=!new Error("").stack;function Ae(){if(qr)try{throw Ae.arguments,new Error}catch(e){return e}return new Error}function Ut(e,t){var n=e.stack;return n?(t=t||0,n.indexOf(e.name)===0&&(t+=(e.name+e.message).split(`
`).length),n.split(`
`).slice(t).filter(rr).map(function(r){return`
`+r}).join("")):""}var Hr=["Modify","Bulk","OpenFailed","VersionChange","Schema","Upgrade","InvalidTable","MissingAPI","NoSuchDatabase","InvalidArgument","SubTransaction","Unsupported","Internal","DatabaseClosed","PrematureCommit","ForeignAwait"],ir=["Unknown","Constraint","Data","TransactionInactive","ReadOnly","Version","NotFound","InvalidState","InvalidAccess","Abort","Timeout","QuotaExceeded","Syntax","DataClone"],vn=Hr.concat(ir),Yr={VersionChanged:"Database version changed by other database connection",DatabaseClosed:"Database has been closed",Abort:"Transaction aborted",TransactionInactive:"Transaction has already completed or failed",MissingAPI:"IndexedDB API missing. Please visit https://tinyurl.com/y2uuvskb"};function Ie(e,t){this._e=Ae(),this.name=e,this.message=t}Re(Ie).from(Error).extend({stack:{get:function(){return this._stack||(this._stack=this.name+": "+this.message+Ut(this._e,2))}},toString:function(){return this.name+": "+this.message}});function ar(e,t){return e+". Errors: "+Object.keys(t).map(function(n){return t[n].toString()}).filter(function(n,r,i){return i.indexOf(n)===r}).join(`
`)}function gt(e,t,n,r){this._e=Ae(),this.failures=t,this.failedKeys=r,this.successCount=n,this.message=ar(e,t)}Re(gt).from(Ie);function We(e,t){this._e=Ae(),this.name="BulkError",this.failures=Object.keys(t).map(function(n){return t[n]}),this.failuresByPos=t,this.message=ar(e,t)}Re(We).from(Ie);var yn=vn.reduce(function(e,t){return e[t]=t+"Error",e},{}),Qr=Ie,C=vn.reduce(function(e,t){var n=t+"Error";function r(i,a){this._e=Ae(),this.name=n,i?typeof i=="string"?(this.message=""+i+(a?`
 `+a:""),this.inner=a||null):typeof i=="object"&&(this.message=i.name+" "+i.message,this.inner=i):(this.message=Yr[t]||n,this.inner=null)}return Re(r).from(Qr),e[t]=r,e},{});C.Syntax=SyntaxError;C.Type=TypeError;C.Range=RangeError;var In=ir.reduce(function(e,t){return e[t+"Error"]=C[t],e},{});function Jr(e,t){if(!e||e instanceof Ie||e instanceof TypeError||e instanceof SyntaxError||!e.name||!In[e.name])return e;var n=new In[e.name](t||e.message,e);return"stack"in e&&oe(n,"stack",{get:function(){return this.inner.stack}}),n}var Ct=vn.reduce(function(e,t){return["Syntax","Type","Range"].indexOf(t)===-1&&(e[t+"Error"]=C[t]),e},{});Ct.ModifyError=gt;Ct.DexieError=Ie;Ct.BulkError=We;function B(){}function Ze(e){return e}function Xr(e,t){return e==null||e===Ze?t:function(n){return t(e(n))}}function Ee(e,t){return function(){e.apply(this,arguments),t.apply(this,arguments)}}function Gr(e,t){return e===B?t:function(){var n=e.apply(this,arguments);n!==void 0&&(arguments[0]=n);var r=this.onsuccess,i=this.onerror;this.onsuccess=null,this.onerror=null;var a=t.apply(this,arguments);return r&&(this.onsuccess=this.onsuccess?Ee(r,this.onsuccess):r),i&&(this.onerror=this.onerror?Ee(i,this.onerror):i),a!==void 0?a:n}}function $r(e,t){return e===B?t:function(){e.apply(this,arguments);var n=this.onsuccess,r=this.onerror;this.onsuccess=this.onerror=null,t.apply(this,arguments),n&&(this.onsuccess=this.onsuccess?Ee(n,this.onsuccess):n),r&&(this.onerror=this.onerror?Ee(r,this.onerror):r)}}function Zr(e,t){return e===B?t:function(n){var r=e.apply(this,arguments);U(n,r);var i=this.onsuccess,a=this.onerror;this.onsuccess=null,this.onerror=null;var u=t.apply(this,arguments);return i&&(this.onsuccess=this.onsuccess?Ee(i,this.onsuccess):i),a&&(this.onerror=this.onerror?Ee(a,this.onerror):a),r===void 0?u===void 0?void 0:u:U(r,u)}}function ei(e,t){return e===B?t:function(){return t.apply(this,arguments)===!1?!1:e.apply(this,arguments)}}function mn(e,t){return e===B?t:function(){var n=e.apply(this,arguments);if(n&&typeof n.then=="function"){for(var r=this,i=arguments.length,a=new Array(i);i--;)a[i]=arguments[i];return n.then(function(){return t.apply(r,a)})}return t.apply(this,arguments)}}var He={},ti=100,ni=20,ur=100,gn=typeof Promise>"u"?[]:function(){var e=Promise.resolve();if(typeof crypto>"u"||!crypto.subtle)return[e,qe(e),e];var t=crypto.subtle.digest("SHA-512",new Uint8Array([0]));return[t,qe(t),e]}(),qt=gn[0],bt=gn[1],Ht=gn[2],or=bt&&bt.then,ft=qt&&qt.constructor,bn=!!Ht,Yt=!1,ri=Ht?function(){Ht.then(ut)}:M.setImmediate?setImmediate.bind(null,ut):M.MutationObserver?function(){var e=document.createElement("div");new MutationObserver(function(){ut(),e=null}).observe(e,{attributes:!0}),e.setAttribute("i","1")}:function(){setTimeout(ut,0)},Ye=function(e,t){Ve.push([e,t]),_t&&(ri(),_t=!1)},Qt=!0,_t=!0,_e=[],ht=[],Jt=null,Xt=Ze,Te={id:"global",global:!0,ref:0,unhandleds:[],onunhandled:Mn,pgp:!1,env:{},finalize:function(){this.unhandleds.forEach(function(e){try{Mn(e[0],e[1])}catch{}})}},k=Te,Ve=[],we=0,dt=[];function S(e){if(typeof this!="object")throw new TypeError("Promises must be constructed via new");this._listeners=[],this.onuncatched=B,this._lib=!1;var t=this._PSD=k;if(te&&(this._stackHolder=Ae(),this._prev=null,this._numPrev=0),typeof e!="function"){if(e!==He)throw new TypeError("Not a function");this._state=arguments[1],this._value=arguments[2],this._state===!1&&$t(this,this._value);return}this._state=null,this._value=null,++t.ref,lr(this,e)}var Gt={get:function(){var e=k,t=wt;function n(r,i){var a=this,u=!e.global&&(e!==k||t!==wt),o=u&&!se(),s=new S(function(l,d){_n(a,new sr(xt(r,e,u,o),xt(i,e,u,o),l,d,e))});return te&&hr(s,this),s}return n.prototype=He,n},set:function(e){oe(this,"then",e&&e.prototype===He?Gt:{get:function(){return e},set:Gt.set})}};De(S.prototype,{then:Gt,_then:function(e,t){_n(this,new sr(null,null,e,t,k))},catch:function(e){if(arguments.length===1)return this.then(null,e);var t=arguments[0],n=arguments[1];return typeof t=="function"?this.then(null,function(r){return r instanceof t?n(r):pt(r)}):this.then(null,function(r){return r&&r.name===t?n(r):pt(r)})},finally:function(e){return this.then(function(t){return e(),t},function(t){return e(),pt(t)})},stack:{get:function(){if(this._stack)return this._stack;try{Yt=!0;var e=fr(this,[],ni),t=e.join(`
From previous: `);return this._state!==null&&(this._stack=t),t}finally{Yt=!1}}},timeout:function(e,t){var n=this;return e<1/0?new S(function(r,i){var a=setTimeout(function(){return i(new C.Timeout(t))},e);n.then(r,i).finally(clearTimeout.bind(null,a))}):this}});typeof Symbol<"u"&&Symbol.toStringTag&&oe(S.prototype,Symbol.toStringTag,"Dexie.Promise");Te.env=dr();function sr(e,t,n,r,i){this.onFulfilled=typeof e=="function"?e:null,this.onRejected=typeof t=="function"?t:null,this.resolve=n,this.reject=r,this.psd=i}De(S,{all:function(){var e=ie.apply(null,arguments).map(Et);return new S(function(t,n){e.length===0&&t([]);var r=e.length;e.forEach(function(i,a){return S.resolve(i).then(function(u){e[a]=u,--r||t(e)},n)})})},resolve:function(e){if(e instanceof S)return e;if(e&&typeof e.then=="function")return new S(function(n,r){e.then(n,r)});var t=new S(He,!0,e);return hr(t,Jt),t},reject:pt,race:function(){var e=ie.apply(null,arguments).map(Et);return new S(function(t,n){e.map(function(r){return S.resolve(r).then(t,n)})})},PSD:{get:function(){return k},set:function(e){return k=e}},totalEchoes:{get:function(){return wt}},newPSD:pe,usePSD:Be,scheduler:{get:function(){return Ye},set:function(e){Ye=e}},rejectionMapper:{get:function(){return Xt},set:function(e){Xt=e}},follow:function(e,t){return new S(function(n,r){return pe(function(i,a){var u=k;u.unhandleds=[],u.onunhandled=a,u.finalize=Ee(function(){var o=this;ai(function(){o.unhandleds.length===0?i():a(o.unhandleds[0])})},u.finalize),e()},t,n,r)})}});ft&&(ft.allSettled&&oe(S,"allSettled",function(){var e=ie.apply(null,arguments).map(Et);return new S(function(t){e.length===0&&t([]);var n=e.length,r=new Array(n);e.forEach(function(i,a){return S.resolve(i).then(function(u){return r[a]={status:"fulfilled",value:u}},function(u){return r[a]={status:"rejected",reason:u}}).then(function(){return--n||t(r)})})})}),ft.any&&typeof AggregateError<"u"&&oe(S,"any",function(){var e=ie.apply(null,arguments).map(Et);return new S(function(t,n){e.length===0&&n(new AggregateError([]));var r=e.length,i=new Array(r);e.forEach(function(a,u){return S.resolve(a).then(function(o){return t(o)},function(o){i[u]=o,--r||n(new AggregateError(i))})})})}));function lr(e,t){try{t(function(n){if(e._state===null){if(n===e)throw new TypeError("A promise cannot be resolved with itself.");var r=e._lib&&et();n&&typeof n.then=="function"?lr(e,function(i,a){n instanceof S?n._then(i,a):n.then(i,a)}):(e._state=!0,e._value=n,cr(e)),r&&tt()}},$t.bind(null,e))}catch(n){$t(e,n)}}function $t(e,t){if(ht.push(t),e._state===null){var n=e._lib&&et();t=Xt(t),e._state=!1,e._value=t,te&&t!==null&&typeof t=="object"&&!t._promise&&jr(function(){var r=dn(t,"stack");t._promise=e,oe(t,"stack",{get:function(){return Yt?r&&(r.get?r.get.apply(t):r.value):e.stack}})}),ui(e),cr(e),n&&tt()}}function cr(e){var t=e._listeners;e._listeners=[];for(var n=0,r=t.length;n<r;++n)_n(e,t[n]);var i=e._PSD;--i.ref||i.finalize(),we===0&&(++we,Ye(function(){--we===0&&wn()},[]))}function _n(e,t){if(e._state===null){e._listeners.push(t);return}var n=e._state?t.onFulfilled:t.onRejected;if(n===null)return(e._state?t.resolve:t.reject)(e._value);++t.psd.ref,++we,Ye(ii,[n,e,t])}function ii(e,t,n){try{Jt=t;var r,i=t._value;t._state?r=e(i):(ht.length&&(ht=[]),r=e(i),ht.indexOf(i)===-1&&oi(t)),n.resolve(r)}catch(a){n.reject(a)}finally{Jt=null,--we===0&&wn(),--n.psd.ref||n.psd.finalize()}}function fr(e,t,n){if(t.length===n)return t;var r="";if(e._state===!1){var i=e._value,a,u;i!=null?(a=i.name||"Error",u=i.message||i,r=Ut(i,0)):(a=i,u=""),t.push(a+(u?": "+u:"")+r)}return te&&(r=Ut(e._stackHolder,2),r&&t.indexOf(r)===-1&&t.push(r),e._prev&&fr(e._prev,t,n)),t}function hr(e,t){var n=t?t._numPrev+1:0;n<ti&&(e._prev=t,e._numPrev=n)}function ut(){et()&&tt()}function et(){var e=Qt;return Qt=!1,_t=!1,e}function tt(){var e,t,n;do for(;Ve.length>0;)for(e=Ve,Ve=[],n=e.length,t=0;t<n;++t){var r=e[t];r[0].apply(null,r[1])}while(Ve.length>0);Qt=!0,_t=!0}function wn(){var e=_e;_e=[],e.forEach(function(r){r._PSD.onunhandled.call(null,r._value,r)});for(var t=dt.slice(0),n=t.length;n;)t[--n]()}function ai(e){function t(){e(),dt.splice(dt.indexOf(t),1)}dt.push(t),++we,Ye(function(){--we===0&&wn()},[])}function ui(e){_e.some(function(t){return t._value===e._value})||_e.push(e)}function oi(e){for(var t=_e.length;t;)if(_e[--t]._value===e._value){_e.splice(t,1);return}}function pt(e){return new S(He,!1,e)}function F(e,t){var n=k;return function(){var r=et(),i=k;try{return ve(n,!0),e.apply(this,arguments)}catch(a){t&&t(a)}finally{ve(i,!1),r&&tt()}}}var V={awaits:0,echoes:0,id:0},si=0,vt=[],Dt=0,wt=0,li=0;function pe(e,t,n,r){var i=k,a=Object.create(i);a.parent=i,a.ref=0,a.global=!1,a.id=++li;var u=Te.env;a.env=bn?{Promise:S,PromiseProp:{value:S,configurable:!0,writable:!0},all:S.all,race:S.race,allSettled:S.allSettled,any:S.any,resolve:S.resolve,reject:S.reject,nthen:Pn(u.nthen,a),gthen:Pn(u.gthen,a)}:{},t&&U(a,t),++i.ref,a.finalize=function(){--this.parent.ref||this.parent.finalize()};var o=Be(a,e,n,r);return a.ref===0&&a.finalize(),o}function Pe(){return V.id||(V.id=++si),++V.awaits,V.echoes+=ur,V.id}function se(){return V.awaits?(--V.awaits===0&&(V.id=0),V.echoes=V.awaits*ur,!0):!1}(""+or).indexOf("[native code]")===-1&&(Pe=se=B);function Et(e){return V.echoes&&e&&e.constructor===ft?(Pe(),e.then(function(t){return se(),t},function(t){return se(),j(t)})):e}function ci(e){++wt,(!V.echoes||--V.echoes===0)&&(V.echoes=V.id=0),vt.push(k),ve(e,!0)}function fi(){var e=vt[vt.length-1];vt.pop(),ve(e,!1)}function ve(e,t){var n=k;if((t?V.echoes&&(!Dt++||e!==k):Dt&&(!--Dt||e!==k))&&pr(t?ci.bind(null,e):fi),e!==k&&(k=e,n===Te&&(Te.env=dr()),bn)){var r=Te.env.Promise,i=e.env;bt.then=i.nthen,r.prototype.then=i.gthen,(n.global||e.global)&&(Object.defineProperty(M,"Promise",i.PromiseProp),r.all=i.all,r.race=i.race,r.resolve=i.resolve,r.reject=i.reject,i.allSettled&&(r.allSettled=i.allSettled),i.any&&(r.any=i.any))}}function dr(){var e=M.Promise;return bn?{Promise:e,PromiseProp:Object.getOwnPropertyDescriptor(M,"Promise"),all:e.all,race:e.race,allSettled:e.allSettled,any:e.any,resolve:e.resolve,reject:e.reject,nthen:bt.then,gthen:e.prototype.then}:{}}function Be(e,t,n,r,i){var a=k;try{return ve(e,!0),t(n,r,i)}finally{ve(a,!1)}}function pr(e){or.call(qt,e)}function xt(e,t,n,r){return typeof e!="function"?e:function(){var i=k;n&&Pe(),ve(t,!0);try{return e.apply(this,arguments)}finally{ve(i,!1),r&&pr(se)}}}function Pn(e,t){return function(n,r){return e.call(this,xt(n,t),xt(r,t))}}var Bn="unhandledrejection";function Mn(e,t){var n;try{n=t.onuncatched(e)}catch{}if(n!==!1)try{var r,i={promise:t,reason:e};if(M.document&&document.createEvent?(r=document.createEvent("Event"),r.initEvent(Bn,!0,!0),U(r,i)):M.CustomEvent&&(r=new CustomEvent(Bn,{detail:i}),U(r,i)),r&&M.dispatchEvent&&(dispatchEvent(r),!M.PromiseRejectionEvent&&M.onunhandledrejection))try{M.onunhandledrejection(r)}catch{}te&&r&&!r.defaultPrevented&&console.warn("Unhandled rejection: "+(e.stack||e))}catch{}}var j=S.reject;function Zt(e,t,n,r){if(!e.idbdb||!e._state.openComplete&&!k.letThrough&&!e._vip){if(e._state.openComplete)return j(new C.DatabaseClosed(e._state.dbOpenError));if(!e._state.isBeingOpened){if(!e._options.autoOpen)return j(new C.DatabaseClosed);e.open().catch(B)}return e._state.dbReadyPromise.then(function(){return Zt(e,t,n,r)})}else{var i=e._createTransaction(t,n,e._dbSchema);try{i.create(),e._state.PR1398_maxLoop=3}catch(a){return a.name===yn.InvalidState&&e.isOpen()&&--e._state.PR1398_maxLoop>0?(console.warn("Dexie: Need to reopen db"),e._close(),e.open().then(function(){return Zt(e,t,n,r)})):j(a)}return i._promise(t,function(a,u){return pe(function(){return k.trans=i,r(a,u,i)})}).then(function(a){return i._completion.then(function(){return a})})}}var Fn="3.2.2",be=String.fromCharCode(65535),en=-1/0,ne="Invalid key provided. Keys must be of type string, number, Date or Array<string | number | Date>.",vr="String expected.",ze=[],Tt=typeof navigator<"u"&&/(MSIE|Trident|Edge)/.test(navigator.userAgent),hi=Tt,di=Tt,yr=function(e){return!/(dexie\.js|dexie\.min\.js)/.test(e)},Ot="__dbnames",Rt="readonly",It="readwrite";function xe(e,t){return e?t?function(){return e.apply(this,arguments)&&t.apply(this,arguments)}:e:t}var mr={type:3,lower:-1/0,lowerOpen:!1,upper:[[]],upperOpen:!1};function ot(e){return typeof e=="string"&&!/\./.test(e)?function(t){return t[e]===void 0&&e in t&&(t=$e(t),delete t[e]),t}:function(t){return t}}var pi=function(){function e(){}return e.prototype._trans=function(t,n,r){var i=this._tx||k.trans,a=this.name;function u(s,l,d){if(!d.schema[a])throw new C.NotFound("Table "+a+" not part of transaction");return n(d.idbtrans,d)}var o=et();try{return i&&i.db===this.db?i===k.trans?i._promise(t,u,r):pe(function(){return i._promise(t,u,r)},{trans:i,transless:k.transless||k}):Zt(this.db,t,[this.name],u)}finally{o&&tt()}},e.prototype.get=function(t,n){var r=this;return t&&t.constructor===Object?this.where(t).first(n):this._trans("readonly",function(i){return r.core.get({trans:i,key:t}).then(function(a){return r.hook.reading.fire(a)})}).then(n)},e.prototype.where=function(t){if(typeof t=="string")return new this.db.WhereClause(this,t);if(W(t))return new this.db.WhereClause(this,"["+t.join("+")+"]");var n=N(t);if(n.length===1)return this.where(n[0]).equals(t[n[0]]);var r=this.schema.indexes.concat(this.schema.primKey).filter(function(d){return d.compound&&n.every(function(f){return d.keyPath.indexOf(f)>=0})&&d.keyPath.every(function(f){return n.indexOf(f)>=0})})[0];if(r&&this.db._maxKey!==be)return this.where(r.name).equals(r.keyPath.map(function(d){return t[d]}));!r&&te&&console.warn("The query "+JSON.stringify(t)+" on "+this.name+" would benefit of a "+("compound index ["+n.join("+")+"]"));var i=this.schema.idxByName,a=this.db._deps.indexedDB;function u(d,f){try{return a.cmp(d,f)===0}catch{return!1}}var o=n.reduce(function(d,f){var p=d[0],m=d[1],c=i[f],h=t[f];return[p||c,p||!c?xe(m,c&&c.multi?function(v){var w=ue(v,f);return W(w)&&w.some(function(_){return u(h,_)})}:function(v){return u(h,ue(v,f))}):m]},[null,null]),s=o[0],l=o[1];return s?this.where(s.name).equals(t[s.keyPath]).filter(l):r?this.filter(l):this.where(n).equals("")},e.prototype.filter=function(t){return this.toCollection().and(t)},e.prototype.count=function(t){return this.toCollection().count(t)},e.prototype.offset=function(t){return this.toCollection().offset(t)},e.prototype.limit=function(t){return this.toCollection().limit(t)},e.prototype.each=function(t){return this.toCollection().each(t)},e.prototype.toArray=function(t){return this.toCollection().toArray(t)},e.prototype.toCollection=function(){return new this.db.Collection(new this.db.WhereClause(this))},e.prototype.orderBy=function(t){return new this.db.Collection(new this.db.WhereClause(this,W(t)?"["+t.join("+")+"]":t))},e.prototype.reverse=function(){return this.toCollection().reverse()},e.prototype.mapToClass=function(t){this.schema.mappedClass=t;var n=function(r){if(!r)return r;var i=Object.create(t.prototype);for(var a in r)if(H(r,a))try{i[a]=r[a]}catch{}return i};return this.schema.readHook&&this.hook.reading.unsubscribe(this.schema.readHook),this.schema.readHook=n,this.hook("reading",n),t},e.prototype.defineClass=function(){function t(n){U(this,n)}return this.mapToClass(t)},e.prototype.add=function(t,n){var r=this,i=this.schema.primKey,a=i.auto,u=i.keyPath,o=t;return u&&a&&(o=ot(u)(t)),this._trans("readwrite",function(s){return r.core.mutate({trans:s,type:"add",keys:n!=null?[n]:null,values:[o]})}).then(function(s){return s.numFailures?S.reject(s.failures[0]):s.lastResult}).then(function(s){if(u)try{G(t,u,s)}catch{}return s})},e.prototype.update=function(t,n){if(typeof t=="object"&&!W(t)){var r=ue(t,this.schema.primKey.keyPath);if(r===void 0)return j(new C.InvalidArgument("Given object does not contain its primary key"));try{typeof n!="function"?N(n).forEach(function(i){G(t,i,n[i])}):n(t,{value:t,primKey:r})}catch{}return this.where(":id").equals(r).modify(n)}else return this.where(":id").equals(t).modify(n)},e.prototype.put=function(t,n){var r=this,i=this.schema.primKey,a=i.auto,u=i.keyPath,o=t;return u&&a&&(o=ot(u)(t)),this._trans("readwrite",function(s){return r.core.mutate({trans:s,type:"put",values:[o],keys:n!=null?[n]:null})}).then(function(s){return s.numFailures?S.reject(s.failures[0]):s.lastResult}).then(function(s){if(u)try{G(t,u,s)}catch{}return s})},e.prototype.delete=function(t){var n=this;return this._trans("readwrite",function(r){return n.core.mutate({trans:r,type:"delete",keys:[t]})}).then(function(r){return r.numFailures?S.reject(r.failures[0]):void 0})},e.prototype.clear=function(){var t=this;return this._trans("readwrite",function(n){return t.core.mutate({trans:n,type:"deleteRange",range:mr})}).then(function(n){return n.numFailures?S.reject(n.failures[0]):void 0})},e.prototype.bulkGet=function(t){var n=this;return this._trans("readonly",function(r){return n.core.getMany({keys:t,trans:r}).then(function(i){return i.map(function(a){return n.hook.reading.fire(a)})})})},e.prototype.bulkAdd=function(t,n,r){var i=this,a=Array.isArray(n)?n:void 0;r=r||(a?void 0:n);var u=r?r.allKeys:void 0;return this._trans("readwrite",function(o){var s=i.schema.primKey,l=s.auto,d=s.keyPath;if(d&&a)throw new C.InvalidArgument("bulkAdd(): keys argument invalid on tables with inbound keys");if(a&&a.length!==t.length)throw new C.InvalidArgument("Arguments objects and keys must have the same length");var f=t.length,p=d&&l?t.map(ot(d)):t;return i.core.mutate({trans:o,type:"add",keys:a,values:p,wantResults:u}).then(function(m){var c=m.numFailures,h=m.results,v=m.lastResult,w=m.failures,_=u?h:v;if(c===0)return _;throw new We(i.name+".bulkAdd(): "+c+" of "+f+" operations failed",w)})})},e.prototype.bulkPut=function(t,n,r){var i=this,a=Array.isArray(n)?n:void 0;r=r||(a?void 0:n);var u=r?r.allKeys:void 0;return this._trans("readwrite",function(o){var s=i.schema.primKey,l=s.auto,d=s.keyPath;if(d&&a)throw new C.InvalidArgument("bulkPut(): keys argument invalid on tables with inbound keys");if(a&&a.length!==t.length)throw new C.InvalidArgument("Arguments objects and keys must have the same length");var f=t.length,p=d&&l?t.map(ot(d)):t;return i.core.mutate({trans:o,type:"put",keys:a,values:p,wantResults:u}).then(function(m){var c=m.numFailures,h=m.results,v=m.lastResult,w=m.failures,_=u?h:v;if(c===0)return _;throw new We(i.name+".bulkPut(): "+c+" of "+f+" operations failed",w)})})},e.prototype.bulkDelete=function(t){var n=this,r=t.length;return this._trans("readwrite",function(i){return n.core.mutate({trans:i,type:"delete",keys:t})}).then(function(i){var a=i.numFailures,u=i.lastResult,o=i.failures;if(a===0)return u;throw new We(n.name+".bulkDelete(): "+a+" of "+r+" operations failed",o)})},e}();function nt(e){var t={},n=function(o,s){if(s){for(var l=arguments.length,d=new Array(l-1);--l;)d[l-1]=arguments[l];return t[o].subscribe.apply(null,d),e}else if(typeof o=="string")return t[o]};n.addEventType=a;for(var r=1,i=arguments.length;r<i;++r)a(arguments[r]);return n;function a(o,s,l){if(typeof o=="object")return u(o);s||(s=ei),l||(l=B);var d={subscribers:[],fire:l,subscribe:function(f){d.subscribers.indexOf(f)===-1&&(d.subscribers.push(f),d.fire=s(d.fire,f))},unsubscribe:function(f){d.subscribers=d.subscribers.filter(function(p){return p!==f}),d.fire=d.subscribers.reduce(s,l)}};return t[o]=n[o]=d,d}function u(o){N(o).forEach(function(s){var l=o[s];if(W(l))a(s,o[s][0],o[s][1]);else if(l==="asap")var d=a(s,Ze,function(){for(var p=arguments.length,m=new Array(p);p--;)m[p]=arguments[p];d.subscribers.forEach(function(c){Gn(function(){c.apply(null,m)})})});else throw new C.InvalidArgument("Invalid event config")})}}function rt(e,t){return Re(t).from({prototype:e}),t}function vi(e){return rt(pi.prototype,function(n,r,i){this.db=e,this._tx=i,this.name=n,this.schema=r,this.hook=e._allTables[n]?e._allTables[n].hook:nt(null,{creating:[Gr,B],reading:[Xr,Ze],updating:[Zr,B],deleting:[$r,B]})})}function ke(e,t){return!(e.filter||e.algorithm||e.or)&&(t?e.justLimit:!e.replayFilter)}function Pt(e,t){e.filter=xe(e.filter,t)}function Bt(e,t,n){var r=e.replayFilter;e.replayFilter=r?function(){return xe(r(),t())}:t,e.justLimit=n&&!r}function yi(e,t){e.isMatch=xe(e.isMatch,t)}function yt(e,t){if(e.isPrimKey)return t.primaryKey;var n=t.getIndexByKeyPath(e.index);if(!n)throw new C.Schema("KeyPath "+e.index+" on object store "+t.name+" is not indexed");return n}function Nn(e,t,n){var r=yt(e,t.schema);return t.openCursor({trans:n,values:!e.keysOnly,reverse:e.dir==="prev",unique:!!e.unique,query:{index:r,range:e.range}})}function st(e,t,n,r){var i=e.replayFilter?xe(e.filter,e.replayFilter()):e.filter;if(e.or){var a={},u=function(o,s,l){if(!i||i(s,l,function(p){return s.stop(p)},function(p){return s.fail(p)})){var d=s.primaryKey,f=""+d;f==="[object ArrayBuffer]"&&(f=""+new Uint8Array(d)),H(a,f)||(a[f]=!0,t(o,s,l))}};return Promise.all([e.or._iterate(u,n),jn(Nn(e,r,n),e.algorithm,u,!e.keysOnly&&e.valueMapper)])}else return jn(Nn(e,r,n),xe(e.algorithm,i),t,!e.keysOnly&&e.valueMapper)}function jn(e,t,n,r){var i=r?function(u,o,s){return n(r(u),o,s)}:n,a=F(i);return e.then(function(u){if(u)return u.start(function(){var o=function(){return u.continue()};(!t||t(u,function(s){return o=s},function(s){u.stop(s),o=B},function(s){u.fail(s),o=B}))&&a(u.value,u,function(s){return o=s}),o()})})}function z(e,t){try{var n=Ln(e),r=Ln(t);if(n!==r)return n==="Array"?1:r==="Array"?-1:n==="binary"?1:r==="binary"?-1:n==="string"?1:r==="string"?-1:n==="Date"?1:r!=="Date"?NaN:-1;switch(n){case"number":case"Date":case"string":return e>t?1:e<t?-1:0;case"binary":return gi(Vn(e),Vn(t));case"Array":return mi(e,t)}}catch{}return NaN}function mi(e,t){for(var n=e.length,r=t.length,i=n<r?n:r,a=0;a<i;++a){var u=z(e[a],t[a]);if(u!==0)return u}return n===r?0:n<r?-1:1}function gi(e,t){for(var n=e.length,r=t.length,i=n<r?n:r,a=0;a<i;++a)if(e[a]!==t[a])return e[a]<t[a]?-1:1;return n===r?0:n<r?-1:1}function Ln(e){var t=typeof e;if(t!=="object")return t;if(ArrayBuffer.isView(e))return"binary";var n=Wt(e);return n==="ArrayBuffer"?"binary":n}function Vn(e){return e instanceof Uint8Array?e:ArrayBuffer.isView(e)?new Uint8Array(e.buffer,e.byteOffset,e.byteLength):new Uint8Array(e)}var bi=function(){function e(){}return e.prototype._read=function(t,n){var r=this._ctx;return r.error?r.table._trans(null,j.bind(null,r.error)):r.table._trans("readonly",t).then(n)},e.prototype._write=function(t){var n=this._ctx;return n.error?n.table._trans(null,j.bind(null,n.error)):n.table._trans("readwrite",t,"locked")},e.prototype._addAlgorithm=function(t){var n=this._ctx;n.algorithm=xe(n.algorithm,t)},e.prototype._iterate=function(t,n){return st(this._ctx,t,n,this._ctx.table.core)},e.prototype.clone=function(t){var n=Object.create(this.constructor.prototype),r=Object.create(this._ctx);return t&&U(r,t),n._ctx=r,n},e.prototype.raw=function(){return this._ctx.valueMapper=null,this},e.prototype.each=function(t){var n=this._ctx;return this._read(function(r){return st(n,t,r,n.table.core)})},e.prototype.count=function(t){var n=this;return this._read(function(r){var i=n._ctx,a=i.table.core;if(ke(i,!0))return a.count({trans:r,query:{index:yt(i,a.schema),range:i.range}}).then(function(o){return Math.min(o,i.limit)});var u=0;return st(i,function(){return++u,!1},r,a).then(function(){return u})}).then(t)},e.prototype.sortBy=function(t,n){var r=t.split(".").reverse(),i=r[0],a=r.length-1;function u(l,d){return d?u(l[r[d]],d-1):l[i]}var o=this._ctx.dir==="next"?1:-1;function s(l,d){var f=u(l,a),p=u(d,a);return f<p?-o:f>p?o:0}return this.toArray(function(l){return l.sort(s)}).then(n)},e.prototype.toArray=function(t){var n=this;return this._read(function(r){var i=n._ctx;if(i.dir==="next"&&ke(i,!0)&&i.limit>0){var a=i.valueMapper,u=yt(i,i.table.core.schema);return i.table.core.query({trans:r,limit:i.limit,values:!0,query:{index:u,range:i.range}}).then(function(s){var l=s.result;return a?l.map(a):l})}else{var o=[];return st(i,function(s){return o.push(s)},r,i.table.core).then(function(){return o})}},t)},e.prototype.offset=function(t){var n=this._ctx;return t<=0?this:(n.offset+=t,ke(n)?Bt(n,function(){var r=t;return function(i,a){return r===0?!0:r===1?(--r,!1):(a(function(){i.advance(r),r=0}),!1)}}):Bt(n,function(){var r=t;return function(){return--r<0}}),this)},e.prototype.limit=function(t){return this._ctx.limit=Math.min(this._ctx.limit,t),Bt(this._ctx,function(){var n=t;return function(r,i,a){return--n<=0&&i(a),n>=0}},!0),this},e.prototype.until=function(t,n){return Pt(this._ctx,function(r,i,a){return t(r.value)?(i(a),n):!0}),this},e.prototype.first=function(t){return this.limit(1).toArray(function(n){return n[0]}).then(t)},e.prototype.last=function(t){return this.reverse().first(t)},e.prototype.filter=function(t){return Pt(this._ctx,function(n){return t(n.value)}),yi(this._ctx,t),this},e.prototype.and=function(t){return this.filter(t)},e.prototype.or=function(t){return new this.db.WhereClause(this._ctx.table,t,this)},e.prototype.reverse=function(){return this._ctx.dir=this._ctx.dir==="prev"?"next":"prev",this._ondirectionchange&&this._ondirectionchange(this._ctx.dir),this},e.prototype.desc=function(){return this.reverse()},e.prototype.eachKey=function(t){var n=this._ctx;return n.keysOnly=!n.isMatch,this.each(function(r,i){t(i.key,i)})},e.prototype.eachUniqueKey=function(t){return this._ctx.unique="unique",this.eachKey(t)},e.prototype.eachPrimaryKey=function(t){var n=this._ctx;return n.keysOnly=!n.isMatch,this.each(function(r,i){t(i.primaryKey,i)})},e.prototype.keys=function(t){var n=this._ctx;n.keysOnly=!n.isMatch;var r=[];return this.each(function(i,a){r.push(a.key)}).then(function(){return r}).then(t)},e.prototype.primaryKeys=function(t){var n=this._ctx;if(n.dir==="next"&&ke(n,!0)&&n.limit>0)return this._read(function(i){var a=yt(n,n.table.core.schema);return n.table.core.query({trans:i,values:!1,limit:n.limit,query:{index:a,range:n.range}})}).then(function(i){var a=i.result;return a}).then(t);n.keysOnly=!n.isMatch;var r=[];return this.each(function(i,a){r.push(a.primaryKey)}).then(function(){return r}).then(t)},e.prototype.uniqueKeys=function(t){return this._ctx.unique="unique",this.keys(t)},e.prototype.firstKey=function(t){return this.limit(1).keys(function(n){return n[0]}).then(t)},e.prototype.lastKey=function(t){return this.reverse().firstKey(t)},e.prototype.distinct=function(){var t=this._ctx,n=t.index&&t.table.schema.idxByName[t.index];if(!n||!n.multi)return this;var r={};return Pt(this._ctx,function(i){var a=i.primaryKey.toString(),u=H(r,a);return r[a]=!0,!u}),this},e.prototype.modify=function(t){var n=this,r=this._ctx;return this._write(function(i){var a;if(typeof t=="function")a=t;else{var u=N(t),o=u.length;a=function(w){for(var _=!1,b=0;b<o;++b){var g=u[b],y=t[g];ue(w,g)!==y&&(G(w,g,y),_=!0)}return _}}var s=r.table.core,l=s.schema.primaryKey,d=l.outbound,f=l.extractKey,p=n.db._options.modifyChunkSize||200,m=[],c=0,h=[],v=function(w,_){var b=_.failures,g=_.numFailures;c+=w-g;for(var y=0,E=N(b);y<E.length;y++){var A=E[y];m.push(b[A])}};return n.clone().primaryKeys().then(function(w){var _=function(b){var g=Math.min(p,w.length-b);return s.getMany({trans:i,keys:w.slice(b,b+g),cache:"immutable"}).then(function(y){for(var E=[],A=[],x=d?[]:null,K=[],T=0;T<g;++T){var R=y[T],P={value:$e(R),primKey:w[b+T]};a.call(P,P.value,P)!==!1&&(P.value==null?K.push(w[b+T]):!d&&z(f(R),f(P.value))!==0?(K.push(w[b+T]),E.push(P.value)):(A.push(P.value),d&&x.push(w[b+T])))}var I=ke(r)&&r.limit===1/0&&(typeof t!="function"||t===Mt)&&{index:r.index,range:r.range};return Promise.resolve(E.length>0&&s.mutate({trans:i,type:"add",values:E}).then(function(L){for(var O in L.failures)K.splice(parseInt(O),1);v(E.length,L)})).then(function(){return(A.length>0||I&&typeof t=="object")&&s.mutate({trans:i,type:"put",keys:x,values:A,criteria:I,changeSpec:typeof t!="function"&&t}).then(function(L){return v(A.length,L)})}).then(function(){return(K.length>0||I&&t===Mt)&&s.mutate({trans:i,type:"delete",keys:K,criteria:I}).then(function(L){return v(K.length,L)})}).then(function(){return w.length>b+g&&_(b+p)})})};return _(0).then(function(){if(m.length>0)throw new gt("Error modifying one or more objects",m,c,h);return w.length})})})},e.prototype.delete=function(){var t=this._ctx,n=t.range;return ke(t)&&(t.isPrimKey&&!di||n.type===3)?this._write(function(r){var i=t.table.core.schema.primaryKey,a=n;return t.table.core.count({trans:r,query:{index:i,range:a}}).then(function(u){return t.table.core.mutate({trans:r,type:"deleteRange",range:a}).then(function(o){var s=o.failures;o.lastResult,o.results;var l=o.numFailures;if(l)throw new gt("Could not delete some values",Object.keys(s).map(function(d){return s[d]}),u-l);return u-l})})}):this.modify(Mt)},e}(),Mt=function(e,t){return t.value=null};function _i(e){return rt(bi.prototype,function(n,r){this.db=e;var i=mr,a=null;if(r)try{i=r()}catch(l){a=l}var u=n._ctx,o=u.table,s=o.hook.reading.fire;this._ctx={table:o,index:u.index,isPrimKey:!u.index||o.schema.primKey.keyPath&&u.index===o.schema.primKey.name,range:i,keysOnly:!1,dir:"next",unique:"",algorithm:null,filter:null,replayFilter:null,justLimit:!0,isMatch:null,offset:0,limit:1/0,error:a,or:u.or,valueMapper:s!==Ze?s:null}})}function wi(e,t){return e<t?-1:e===t?0:1}function Ei(e,t){return e>t?-1:e===t?0:1}function q(e,t,n){var r=e instanceof br?new e.Collection(e):e;return r._ctx.error=n?new n(t):new TypeError(t),r}function Ke(e){return new e.Collection(e,function(){return gr("")}).limit(0)}function xi(e){return e==="next"?function(t){return t.toUpperCase()}:function(t){return t.toLowerCase()}}function Si(e){return e==="next"?function(t){return t.toLowerCase()}:function(t){return t.toUpperCase()}}function Ai(e,t,n,r,i,a){for(var u=Math.min(e.length,r.length),o=-1,s=0;s<u;++s){var l=t[s];if(l!==r[s])return i(e[s],n[s])<0?e.substr(0,s)+n[s]+n.substr(s+1):i(e[s],r[s])<0?e.substr(0,s)+r[s]+n.substr(s+1):o>=0?e.substr(0,o)+t[o]+n.substr(o+1):null;i(e[s],l)<0&&(o=s)}return u<r.length&&a==="next"?e+n.substr(e.length):u<e.length&&a==="prev"?e.substr(0,n.length):o<0?null:e.substr(0,o)+r[o]+n.substr(o+1)}function lt(e,t,n,r){var i,a,u,o,s,l,d,f=n.length;if(!n.every(function(h){return typeof h=="string"}))return q(e,vr);function p(h){i=xi(h),a=Si(h),u=h==="next"?wi:Ei;var v=n.map(function(w){return{lower:a(w),upper:i(w)}}).sort(function(w,_){return u(w.lower,_.lower)});o=v.map(function(w){return w.upper}),s=v.map(function(w){return w.lower}),l=h,d=h==="next"?"":r}p("next");var m=new e.Collection(e,function(){return fe(o[0],s[f-1]+r)});m._ondirectionchange=function(h){p(h)};var c=0;return m._addAlgorithm(function(h,v,w){var _=h.key;if(typeof _!="string")return!1;var b=a(_);if(t(b,s,c))return!0;for(var g=null,y=c;y<f;++y){var E=Ai(_,b,o[y],s[y],u,l);E===null&&g===null?c=y+1:(g===null||u(g,E)>0)&&(g=E)}return v(g!==null?function(){h.continue(g+d)}:w),!1}),m}function fe(e,t,n,r){return{type:2,lower:e,upper:t,lowerOpen:n,upperOpen:r}}function gr(e){return{type:1,lower:e,upper:e}}var br=function(){function e(){}return Object.defineProperty(e.prototype,"Collection",{get:function(){return this._ctx.table.db.Collection},enumerable:!1,configurable:!0}),e.prototype.between=function(t,n,r,i){r=r!==!1,i=i===!0;try{return this._cmp(t,n)>0||this._cmp(t,n)===0&&(r||i)&&!(r&&i)?Ke(this):new this.Collection(this,function(){return fe(t,n,!r,!i)})}catch{return q(this,ne)}},e.prototype.equals=function(t){return t==null?q(this,ne):new this.Collection(this,function(){return gr(t)})},e.prototype.above=function(t){return t==null?q(this,ne):new this.Collection(this,function(){return fe(t,void 0,!0)})},e.prototype.aboveOrEqual=function(t){return t==null?q(this,ne):new this.Collection(this,function(){return fe(t,void 0,!1)})},e.prototype.below=function(t){return t==null?q(this,ne):new this.Collection(this,function(){return fe(void 0,t,!1,!0)})},e.prototype.belowOrEqual=function(t){return t==null?q(this,ne):new this.Collection(this,function(){return fe(void 0,t)})},e.prototype.startsWith=function(t){return typeof t!="string"?q(this,vr):this.between(t,t+be,!0,!0)},e.prototype.startsWithIgnoreCase=function(t){return t===""?this.startsWith(t):lt(this,function(n,r){return n.indexOf(r[0])===0},[t],be)},e.prototype.equalsIgnoreCase=function(t){return lt(this,function(n,r){return n===r[0]},[t],"")},e.prototype.anyOfIgnoreCase=function(){var t=ie.apply(Ce,arguments);return t.length===0?Ke(this):lt(this,function(n,r){return r.indexOf(n)!==-1},t,"")},e.prototype.startsWithAnyOfIgnoreCase=function(){var t=ie.apply(Ce,arguments);return t.length===0?Ke(this):lt(this,function(n,r){return r.some(function(i){return n.indexOf(i)===0})},t,be)},e.prototype.anyOf=function(){var t=this,n=ie.apply(Ce,arguments),r=this._cmp;try{n.sort(r)}catch{return q(this,ne)}if(n.length===0)return Ke(this);var i=new this.Collection(this,function(){return fe(n[0],n[n.length-1])});i._ondirectionchange=function(u){r=u==="next"?t._ascending:t._descending,n.sort(r)};var a=0;return i._addAlgorithm(function(u,o,s){for(var l=u.key;r(l,n[a])>0;)if(++a,a===n.length)return o(s),!1;return r(l,n[a])===0?!0:(o(function(){u.continue(n[a])}),!1)}),i},e.prototype.notEqual=function(t){return this.inAnyRange([[en,t],[t,this.db._maxKey]],{includeLowers:!1,includeUppers:!1})},e.prototype.noneOf=function(){var t=ie.apply(Ce,arguments);if(t.length===0)return new this.Collection(this);try{t.sort(this._ascending)}catch{return q(this,ne)}var n=t.reduce(function(r,i){return r?r.concat([[r[r.length-1][1],i]]):[[en,i]]},null);return n.push([t[t.length-1],this.db._maxKey]),this.inAnyRange(n,{includeLowers:!1,includeUppers:!1})},e.prototype.inAnyRange=function(t,n){var r=this,i=this._cmp,a=this._ascending,u=this._descending,o=this._min,s=this._max;if(t.length===0)return Ke(this);if(!t.every(function(y){return y[0]!==void 0&&y[1]!==void 0&&a(y[0],y[1])<=0}))return q(this,"First argument to inAnyRange() must be an Array of two-value Arrays [lower,upper] where upper must not be lower than lower",C.InvalidArgument);var l=!n||n.includeLowers!==!1,d=n&&n.includeUppers===!0;function f(y,E){for(var A=0,x=y.length;A<x;++A){var K=y[A];if(i(E[0],K[1])<0&&i(E[1],K[0])>0){K[0]=o(K[0],E[0]),K[1]=s(K[1],E[1]);break}}return A===x&&y.push(E),y}var p=a;function m(y,E){return p(y[0],E[0])}var c;try{c=t.reduce(f,[]),c.sort(m)}catch{return q(this,ne)}var h=0,v=d?function(y){return a(y,c[h][1])>0}:function(y){return a(y,c[h][1])>=0},w=l?function(y){return u(y,c[h][0])>0}:function(y){return u(y,c[h][0])>=0};function _(y){return!v(y)&&!w(y)}var b=v,g=new this.Collection(this,function(){return fe(c[0][0],c[c.length-1][1],!l,!d)});return g._ondirectionchange=function(y){y==="next"?(b=v,p=a):(b=w,p=u),c.sort(m)},g._addAlgorithm(function(y,E,A){for(var x=y.key;b(x);)if(++h,h===c.length)return E(A),!1;return _(x)?!0:(r._cmp(x,c[h][1])===0||r._cmp(x,c[h][0])===0||E(function(){p===a?y.continue(c[h][0]):y.continue(c[h][1])}),!1)}),g},e.prototype.startsWithAnyOf=function(){var t=ie.apply(Ce,arguments);return t.every(function(n){return typeof n=="string"})?t.length===0?Ke(this):this.inAnyRange(t.map(function(n){return[n,n+be]})):q(this,"startsWithAnyOf() only works with strings")},e}();function ki(e){return rt(br.prototype,function(n,r,i){this.db=e,this._ctx={table:n,index:r===":id"?null:r,or:i};var a=e._deps.indexedDB;if(!a)throw new C.MissingAPI;this._cmp=this._ascending=a.cmp.bind(a),this._descending=function(u,o){return a.cmp(o,u)},this._max=function(u,o){return a.cmp(u,o)>0?u:o},this._min=function(u,o){return a.cmp(u,o)<0?u:o},this._IDBKeyRange=e._deps.IDBKeyRange})}function ee(e){return F(function(t){return Qe(t),e(t.target.error),!1})}function Qe(e){e.stopPropagation&&e.stopPropagation(),e.preventDefault&&e.preventDefault()}var Je="storagemutated",de="x-storagemutated-1",ye=nt(null,Je),Ki=function(){function e(){}return e.prototype._lock=function(){return Le(!k.global),++this._reculock,this._reculock===1&&!k.global&&(k.lockOwnerFor=this),this},e.prototype._unlock=function(){if(Le(!k.global),--this._reculock===0)for(k.global||(k.lockOwnerFor=null);this._blockedFuncs.length>0&&!this._locked();){var t=this._blockedFuncs.shift();try{Be(t[1],t[0])}catch{}}return this},e.prototype._locked=function(){return this._reculock&&k.lockOwnerFor!==this},e.prototype.create=function(t){var n=this;if(!this.mode)return this;var r=this.db.idbdb,i=this.db._state.dbOpenError;if(Le(!this.idbtrans),!t&&!r)switch(i&&i.name){case"DatabaseClosedError":throw new C.DatabaseClosed(i);case"MissingAPIError":throw new C.MissingAPI(i.message,i);default:throw new C.OpenFailed(i)}if(!this.active)throw new C.TransactionInactive;return Le(this._completion._state===null),t=this.idbtrans=t||(this.db.core?this.db.core.transaction(this.storeNames,this.mode,{durability:this.chromeTransactionDurability}):r.transaction(this.storeNames,this.mode,{durability:this.chromeTransactionDurability})),t.onerror=F(function(a){Qe(a),n._reject(t.error)}),t.onabort=F(function(a){Qe(a),n.active&&n._reject(new C.Abort(t.error)),n.active=!1,n.on("abort").fire(a)}),t.oncomplete=F(function(){n.active=!1,n._resolve(),"mutatedParts"in t&&ye.storagemutated.fire(t.mutatedParts)}),this},e.prototype._promise=function(t,n,r){var i=this;if(t==="readwrite"&&this.mode!=="readwrite")return j(new C.ReadOnly("Transaction is readonly"));if(!this.active)return j(new C.TransactionInactive);if(this._locked())return new S(function(u,o){i._blockedFuncs.push([function(){i._promise(t,n,r).then(u,o)},k])});if(r)return pe(function(){var u=new S(function(o,s){i._lock();var l=n(o,s,i);l&&l.then&&l.then(o,s)});return u.finally(function(){return i._unlock()}),u._lib=!0,u});var a=new S(function(u,o){var s=n(u,o,i);s&&s.then&&s.then(u,o)});return a._lib=!0,a},e.prototype._root=function(){return this.parent?this.parent._root():this},e.prototype.waitFor=function(t){var n=this._root(),r=S.resolve(t);if(n._waitingFor)n._waitingFor=n._waitingFor.then(function(){return r});else{n._waitingFor=r,n._waitingQueue=[];var i=n.idbtrans.objectStore(n.storeNames[0]);(function u(){for(++n._spinCount;n._waitingQueue.length;)n._waitingQueue.shift()();n._waitingFor&&(i.get(-1/0).onsuccess=u)})()}var a=n._waitingFor;return new S(function(u,o){r.then(function(s){return n._waitingQueue.push(F(u.bind(null,s)))},function(s){return n._waitingQueue.push(F(o.bind(null,s)))}).finally(function(){n._waitingFor===a&&(n._waitingFor=null)})})},e.prototype.abort=function(){this.active&&(this.active=!1,this.idbtrans&&this.idbtrans.abort(),this._reject(new C.Abort))},e.prototype.table=function(t){var n=this._memoizedTables||(this._memoizedTables={});if(H(n,t))return n[t];var r=this.schema[t];if(!r)throw new C.NotFound("Table "+t+" not part of transaction");var i=new this.db.Table(t,r,this);return i.core=this.db.core.table(t),n[t]=i,i},e}();function Ci(e){return rt(Ki.prototype,function(n,r,i,a,u){var o=this;this.db=e,this.mode=n,this.storeNames=r,this.schema=i,this.chromeTransactionDurability=a,this.idbtrans=null,this.on=nt(this,"complete","error","abort"),this.parent=u||null,this.active=!0,this._reculock=0,this._blockedFuncs=[],this._resolve=null,this._reject=null,this._waitingFor=null,this._waitingQueue=null,this._spinCount=0,this._completion=new S(function(s,l){o._resolve=s,o._reject=l}),this._completion.then(function(){o.active=!1,o.on.complete.fire()},function(s){var l=o.active;return o.active=!1,o.on.error.fire(s),o.parent?o.parent._reject(s):l&&o.idbtrans&&o.idbtrans.abort(),j(s)})})}function tn(e,t,n,r,i,a,u){return{name:e,keyPath:t,unique:n,multi:r,auto:i,compound:a,src:(n&&!u?"&":"")+(r?"*":"")+(i?"++":"")+_r(t)}}function _r(e){return typeof e=="string"?e:e?"["+[].join.call(e,"+")+"]":""}function wr(e,t,n){return{name:e,primKey:t,indexes:n,mappedClass:null,idxByName:$n(n,function(r){return[r.name,r]})}}function Ti(e){return e.length===1?e[0]:e}var Xe=function(e){try{return e.only([[]]),Xe=function(){return[[]]},[[]]}catch{return Xe=function(){return be},be}};function nn(e){return e==null?function(){}:typeof e=="string"?Oi(e):function(t){return ue(t,e)}}function Oi(e){var t=e.split(".");return t.length===1?function(n){return n[e]}:function(n){return ue(n,e)}}function Wn(e){return[].slice.call(e)}var Di=0;function Ue(e){return e==null?":id":typeof e=="string"?e:"["+e.join("+")+"]"}function Ri(e,t,n){function r(f,p){var m=Wn(f.objectStoreNames);return{schema:{name:f.name,tables:m.map(function(c){return p.objectStore(c)}).map(function(c){var h=c.keyPath,v=c.autoIncrement,w=W(h),_=h==null,b={},g={name:c.name,primaryKey:{name:null,isPrimaryKey:!0,outbound:_,compound:w,keyPath:h,autoIncrement:v,unique:!0,extractKey:nn(h)},indexes:Wn(c.indexNames).map(function(y){return c.index(y)}).map(function(y){var E=y.name,A=y.unique,x=y.multiEntry,K=y.keyPath,T=W(K),R={name:E,compound:T,keyPath:K,unique:A,multiEntry:x,extractKey:nn(K)};return b[Ue(K)]=R,R}),getIndexByKeyPath:function(y){return b[Ue(y)]}};return b[":id"]=g.primaryKey,h!=null&&(b[Ue(h)]=g.primaryKey),g})},hasGetAll:m.length>0&&"getAll"in p.objectStore(m[0])&&!(typeof navigator<"u"&&/Safari/.test(navigator.userAgent)&&!/(Chrome\/|Edge\/)/.test(navigator.userAgent)&&[].concat(navigator.userAgent.match(/Safari\/(\d*)/))[1]<604)}}function i(f){if(f.type===3)return null;if(f.type===4)throw new Error("Cannot convert never type to IDBKeyRange");var p=f.lower,m=f.upper,c=f.lowerOpen,h=f.upperOpen,v=p===void 0?m===void 0?null:t.upperBound(m,!!h):m===void 0?t.lowerBound(p,!!c):t.bound(p,m,!!c,!!h);return v}function a(f){var p=f.name;function m(v){var w=v.trans,_=v.type,b=v.keys,g=v.values,y=v.range;return new Promise(function(E,A){E=F(E);var x=w.objectStore(p),K=x.keyPath==null,T=_==="put"||_==="add";if(!T&&_!=="delete"&&_!=="deleteRange")throw new Error("Invalid operation type: "+_);var R=(b||g||{length:1}).length;if(b&&g&&b.length!==g.length)throw new Error("Given keys array must have same length as given values array.");if(R===0)return E({numFailures:0,failures:{},results:[],lastResult:void 0});var P,I=[],L=[],O=0,Y=function(Z){++O,Qe(Z)};if(_==="deleteRange"){if(y.type===4)return E({numFailures:O,failures:L,results:[],lastResult:void 0});y.type===3?I.push(P=x.clear()):I.push(P=x.delete(i(y)))}else{var J=T?K?[g,b]:[g,null]:[b,null],le=J[0],$=J[1];if(T)for(var Q=0;Q<R;++Q)I.push(P=$&&$[Q]!==void 0?x[_](le[Q],$[Q]):x[_](le[Q])),P.onerror=Y;else for(var Q=0;Q<R;++Q)I.push(P=x[_](le[Q])),P.onerror=Y}var ce=function(Z){var Fe=Z.target.result;I.forEach(function(X,at){return X.error!=null&&(L[at]=X.error)}),E({numFailures:O,failures:L,results:_==="delete"?b:I.map(function(X){return X.result}),lastResult:Fe})};P.onerror=function(Z){Y(Z),ce(Z)},P.onsuccess=ce})}function c(v){var w=v.trans,_=v.values,b=v.query,g=v.reverse,y=v.unique;return new Promise(function(E,A){E=F(E);var x=b.index,K=b.range,T=w.objectStore(p),R=x.isPrimaryKey?T:T.index(x.name),P=g?y?"prevunique":"prev":y?"nextunique":"next",I=_||!("openKeyCursor"in R)?R.openCursor(i(K),P):R.openKeyCursor(i(K),P);I.onerror=ee(A),I.onsuccess=F(function(L){var O=I.result;if(!O){E(null);return}O.___id=++Di,O.done=!1;var Y=O.continue.bind(O),J=O.continuePrimaryKey;J&&(J=J.bind(O));var le=O.advance.bind(O),$=function(){throw new Error("Cursor not started")},Q=function(){throw new Error("Cursor not stopped")};O.trans=w,O.stop=O.continue=O.continuePrimaryKey=O.advance=$,O.fail=F(A),O.next=function(){var ce=this,Z=1;return this.start(function(){return Z--?ce.continue():ce.stop()}).then(function(){return ce})},O.start=function(ce){var Z=new Promise(function(X,at){X=F(X),I.onerror=ee(at),O.fail=at,O.stop=function(Rr){O.stop=O.continue=O.continuePrimaryKey=O.advance=Q,X(Rr)}}),Fe=function(){if(I.result)try{ce()}catch(X){O.fail(X)}else O.done=!0,O.start=function(){throw new Error("Cursor behind last entry")},O.stop()};return I.onsuccess=F(function(X){I.onsuccess=Fe,Fe()}),O.continue=Y,O.continuePrimaryKey=J,O.advance=le,Fe(),Z},E(O)},A)})}function h(v){return function(w){return new Promise(function(_,b){_=F(_);var g=w.trans,y=w.values,E=w.limit,A=w.query,x=E===1/0?void 0:E,K=A.index,T=A.range,R=g.objectStore(p),P=K.isPrimaryKey?R:R.index(K.name),I=i(T);if(E===0)return _({result:[]});if(v){var L=y?P.getAll(I,x):P.getAllKeys(I,x);L.onsuccess=function(le){return _({result:le.target.result})},L.onerror=ee(b)}else{var O=0,Y=y||!("openKeyCursor"in P)?P.openCursor(I):P.openKeyCursor(I),J=[];Y.onsuccess=function(le){var $=Y.result;if(!$)return _({result:J});if(J.push(y?$.value:$.primaryKey),++O===E)return _({result:J});$.continue()},Y.onerror=ee(b)}})}}return{name:p,schema:f,mutate:m,getMany:function(v){var w=v.trans,_=v.keys;return new Promise(function(b,g){b=F(b);for(var y=w.objectStore(p),E=_.length,A=new Array(E),x=0,K=0,T,R=function(O){var Y=O.target;(A[Y._pos]=Y.result)!=null,++K===x&&b(A)},P=ee(g),I=0;I<E;++I){var L=_[I];L!=null&&(T=y.get(_[I]),T._pos=I,T.onsuccess=R,T.onerror=P,++x)}x===0&&b(A)})},get:function(v){var w=v.trans,_=v.key;return new Promise(function(b,g){b=F(b);var y=w.objectStore(p),E=y.get(_);E.onsuccess=function(A){return b(A.target.result)},E.onerror=ee(g)})},query:h(s),openCursor:c,count:function(v){var w=v.query,_=v.trans,b=w.index,g=w.range;return new Promise(function(y,E){var A=_.objectStore(p),x=b.isPrimaryKey?A:A.index(b.name),K=i(g),T=K?x.count(K):x.count();T.onsuccess=F(function(R){return y(R.target.result)}),T.onerror=ee(E)})}}}var u=r(e,n),o=u.schema,s=u.hasGetAll,l=o.tables.map(function(f){return a(f)}),d={};return l.forEach(function(f){return d[f.name]=f}),{stack:"dbcore",transaction:e.transaction.bind(e),table:function(f){var p=d[f];if(!p)throw new Error("Table '"+f+"' not found");return d[f]},MIN_KEY:-1/0,MAX_KEY:Xe(t),schema:o}}function Ii(e,t){return t.reduce(function(n,r){var i=r.create;return D(D({},n),i(n))},e)}function Pi(e,t,n,r){var i=n.IDBKeyRange;n.indexedDB;var a=Ii(Ri(t,i,r),e.dbcore);return{dbcore:a}}function En(e,t){var n=e._novip,r=t.db,i=Pi(n._middlewares,r,n._deps,t);n.core=i.dbcore,n.tables.forEach(function(a){var u=a.name;n.core.schema.tables.some(function(o){return o.name===u})&&(a.core=n.core.table(u),n[u]instanceof n.Table&&(n[u].core=a.core))})}function St(e,t,n,r){var i=e._novip;n.forEach(function(a){var u=r[a];t.forEach(function(o){var s=dn(o,a);(!s||"value"in s&&s.value===void 0)&&(o===i.Transaction.prototype||o instanceof i.Transaction?oe(o,a,{get:function(){return this.table(a)},set:function(l){Jn(this,a,{value:l,writable:!0,configurable:!0,enumerable:!0})}}):o[a]=new i.Table(a,u))})})}function rn(e,t){var n=e._novip;t.forEach(function(r){for(var i in r)r[i]instanceof n.Table&&delete r[i]})}function Bi(e,t){return e._cfg.version-t._cfg.version}function Mi(e,t,n,r){var i=e._dbSchema,a=e._createTransaction("readwrite",e._storeNames,i);a.create(n),a._completion.catch(r);var u=a._reject.bind(a),o=k.transless||k;pe(function(){k.trans=a,k.transless=o,t===0?(N(i).forEach(function(s){xn(n,s,i[s].primKey,i[s].indexes)}),En(e,n),S.follow(function(){return e.on.populate.fire(a)}).catch(u)):Fi(e,t,a,n).catch(u)})}function Fi(e,t,n,r){var i=e._novip,a=[],u=i._versions,o=i._dbSchema=Sn(i,i.idbdb,r),s=!1,l=u.filter(function(f){return f._cfg.version>=t});l.forEach(function(f){a.push(function(){var p=o,m=f._cfg.dbschema;un(i,p,r),un(i,m,r),o=i._dbSchema=m;var c=Er(p,m);c.add.forEach(function(g){xn(r,g[0],g[1].primKey,g[1].indexes)}),c.change.forEach(function(g){if(g.recreate)throw new C.Upgrade("Not yet support for changing primary key");var y=r.objectStore(g.name);g.add.forEach(function(E){return an(y,E)}),g.change.forEach(function(E){y.deleteIndex(E.name),an(y,E)}),g.del.forEach(function(E){return y.deleteIndex(E)})});var h=f._cfg.contentUpgrade;if(h&&f._cfg.version>t){En(i,r),n._memoizedTables={},s=!0;var v=Zn(m);c.del.forEach(function(g){v[g]=p[g]}),rn(i,[i.Transaction.prototype]),St(i,[i.Transaction.prototype],N(v),v),n.schema=v;var w=pn(h);w&&Pe();var _,b=S.follow(function(){if(_=h(n),_&&w){var g=se.bind(null,null);_.then(g,g)}});return _&&typeof _.then=="function"?S.resolve(_):b.then(function(){return _})}}),a.push(function(p){if(!s||!hi){var m=f._cfg.dbschema;ji(m,p)}rn(i,[i.Transaction.prototype]),St(i,[i.Transaction.prototype],i._storeNames,i._dbSchema),n.schema=i._dbSchema})});function d(){return a.length?S.resolve(a.shift()(n.idbtrans)).then(d):S.resolve()}return d().then(function(){Ni(o,r)})}function Er(e,t){var n={del:[],add:[],change:[]},r;for(r in e)t[r]||n.del.push(r);for(r in t){var i=e[r],a=t[r];if(!i)n.add.push([r,a]);else{var u={name:r,def:a,recreate:!1,del:[],add:[],change:[]};if(""+(i.primKey.keyPath||"")!=""+(a.primKey.keyPath||"")||i.primKey.auto!==a.primKey.auto&&!Tt)u.recreate=!0,n.change.push(u);else{var o=i.idxByName,s=a.idxByName,l=void 0;for(l in o)s[l]||u.del.push(l);for(l in s){var d=o[l],f=s[l];d?d.src!==f.src&&u.change.push(f):u.add.push(f)}(u.del.length>0||u.add.length>0||u.change.length>0)&&n.change.push(u)}}}return n}function xn(e,t,n,r){var i=e.db.createObjectStore(t,n.keyPath?{keyPath:n.keyPath,autoIncrement:n.auto}:{autoIncrement:n.auto});return r.forEach(function(a){return an(i,a)}),i}function Ni(e,t){N(e).forEach(function(n){t.db.objectStoreNames.contains(n)||xn(t,n,e[n].primKey,e[n].indexes)})}function ji(e,t){[].slice.call(t.db.objectStoreNames).forEach(function(n){return e[n]==null&&t.db.deleteObjectStore(n)})}function an(e,t){e.createIndex(t.name,t.keyPath,{unique:t.unique,multiEntry:t.multi})}function Sn(e,t,n){var r={},i=Kt(t.objectStoreNames,0);return i.forEach(function(a){for(var u=n.objectStore(a),o=u.keyPath,s=tn(_r(o),o||"",!1,!1,!!u.autoIncrement,o&&typeof o!="string",!0),l=[],d=0;d<u.indexNames.length;++d){var f=u.index(u.indexNames[d]);o=f.keyPath;var p=tn(f.name,o,!!f.unique,!!f.multiEntry,!1,o&&typeof o!="string",!1);l.push(p)}r[a]=wr(a,s,l)}),r}function Li(e,t,n){var r=e._novip;r.verno=t.version/10;var i=r._dbSchema=Sn(r,t,n);r._storeNames=Kt(t.objectStoreNames,0),St(r,[r._allTables],N(i),i)}function Vi(e,t){var n=Sn(e,e.idbdb,t),r=Er(n,e._dbSchema);return!(r.add.length||r.change.some(function(i){return i.add.length||i.change.length}))}function un(e,t,n){for(var r=e._novip,i=n.db.objectStoreNames,a=0;a<i.length;++a){var u=i[a],o=n.objectStore(u);r._hasGetAll="getAll"in o;for(var s=0;s<o.indexNames.length;++s){var l=o.indexNames[s],d=o.index(l).keyPath,f=typeof d=="string"?d:"["+Kt(d).join("+")+"]";if(t[u]){var p=t[u].idxByName[f];p&&(p.name=l,delete t[u].idxByName[f],t[u].idxByName[l]=p)}}}typeof navigator<"u"&&/Safari/.test(navigator.userAgent)&&!/(Chrome\/|Edge\/)/.test(navigator.userAgent)&&M.WorkerGlobalScope&&M instanceof M.WorkerGlobalScope&&[].concat(navigator.userAgent.match(/Safari\/(\d*)/))[1]<604&&(r._hasGetAll=!1)}function Wi(e){return e.split(",").map(function(t,n){t=t.trim();var r=t.replace(/([&*]|\+\+)/g,""),i=/^\[/.test(r)?r.match(/^\[(.*)\]$/)[1].split("+"):r;return tn(r,i||null,/\&/.test(t),/\*/.test(t),/\+\+/.test(t),W(i),n===0)})}var zi=function(){function e(){}return e.prototype._parseStoresSpec=function(t,n){N(t).forEach(function(r){if(t[r]!==null){var i=Wi(t[r]),a=i.shift();if(a.multi)throw new C.Schema("Primary key cannot be multi-valued");i.forEach(function(u){if(u.auto)throw new C.Schema("Only primary key can be marked as autoIncrement (++)");if(!u.keyPath)throw new C.Schema("Index must have a name and cannot be an empty string")}),n[r]=wr(r,a,i)}})},e.prototype.stores=function(t){var n=this.db;this._cfg.storesSource=this._cfg.storesSource?U(this._cfg.storesSource,t):t;var r=n._versions,i={},a={};return r.forEach(function(u){U(i,u._cfg.storesSource),a=u._cfg.dbschema={},u._parseStoresSpec(i,a)}),n._dbSchema=a,rn(n,[n._allTables,n,n.Transaction.prototype]),St(n,[n._allTables,n,n.Transaction.prototype,this._cfg.tables],N(a),a),n._storeNames=N(a),this},e.prototype.upgrade=function(t){return this._cfg.contentUpgrade=mn(this._cfg.contentUpgrade||B,t),this},e}();function Ui(e){return rt(zi.prototype,function(n){this.db=e,this._cfg={version:n,storesSource:null,dbschema:{},tables:{},contentUpgrade:null}})}function An(e,t){var n=e._dbNamesDB;return n||(n=e._dbNamesDB=new Tn(Ot,{addons:[],indexedDB:e,IDBKeyRange:t}),n.version(1).stores({dbnames:"name"})),n.table("dbnames")}function kn(e){return e&&typeof e.databases=="function"}function qi(e){var t=e.indexedDB,n=e.IDBKeyRange;return kn(t)?Promise.resolve(t.databases()).then(function(r){return r.map(function(i){return i.name}).filter(function(i){return i!==Ot})}):An(t,n).toCollection().primaryKeys()}function Hi(e,t){var n=e.indexedDB,r=e.IDBKeyRange;!kn(n)&&t!==Ot&&An(n,r).put({name:t}).catch(B)}function Yi(e,t){var n=e.indexedDB,r=e.IDBKeyRange;!kn(n)&&t!==Ot&&An(n,r).delete(t).catch(B)}function on(e){return pe(function(){return k.letThrough=!0,e()})}function Qi(){var e=!navigator.userAgentData&&/Safari\//.test(navigator.userAgent)&&!/Chrom(e|ium)\//.test(navigator.userAgent);if(!e||!indexedDB.databases)return Promise.resolve();var t;return new Promise(function(n){var r=function(){return indexedDB.databases().finally(n)};t=setInterval(r,100),r()}).finally(function(){return clearInterval(t)})}function Ji(e){var t=e._state,n=e._deps.indexedDB;if(t.isBeingOpened||e.idbdb)return t.dbReadyPromise.then(function(){return t.dbOpenError?j(t.dbOpenError):e});te&&(t.openCanceller._stackHolder=Ae()),t.isBeingOpened=!0,t.dbOpenError=null,t.openComplete=!1;var r=t.openCanceller;function i(){if(t.openCanceller!==r)throw new C.DatabaseClosed("db.open() was cancelled")}var a=t.dbReadyResolve,u=null,o=!1;return S.race([r,(typeof navigator>"u"?S.resolve():Qi()).then(function(){return new S(function(s,l){if(i(),!n)throw new C.MissingAPI;var d=e.name,f=t.autoSchema?n.open(d):n.open(d,Math.round(e.verno*10));if(!f)throw new C.MissingAPI;f.onerror=ee(l),f.onblocked=F(e._fireOnBlocked),f.onupgradeneeded=F(function(p){if(u=f.transaction,t.autoSchema&&!e._options.allowEmptyDB){f.onerror=Qe,u.abort(),f.result.close();var m=n.deleteDatabase(d);m.onsuccess=m.onerror=F(function(){l(new C.NoSuchDatabase("Database "+d+" doesnt exist"))})}else{u.onerror=ee(l);var c=p.oldVersion>Math.pow(2,62)?0:p.oldVersion;o=c<1,e._novip.idbdb=f.result,Mi(e,c/10,u,l)}},l),f.onsuccess=F(function(){u=null;var p=e._novip.idbdb=f.result,m=Kt(p.objectStoreNames);if(m.length>0)try{var c=p.transaction(Ti(m),"readonly");t.autoSchema?Li(e,p,c):(un(e,e._dbSchema,c),Vi(e,c)||console.warn("Dexie SchemaDiff: Schema was extended without increasing the number passed to db.version(). Some queries may fail.")),En(e,c)}catch{}ze.push(e),p.onversionchange=F(function(h){t.vcFired=!0,e.on("versionchange").fire(h)}),p.onclose=F(function(h){e.on("close").fire(h)}),o&&Hi(e._deps,d),s()},l)})})]).then(function(){return i(),t.onReadyBeingFired=[],S.resolve(on(function(){return e.on.ready.fire(e.vip)})).then(function s(){if(t.onReadyBeingFired.length>0){var l=t.onReadyBeingFired.reduce(mn,B);return t.onReadyBeingFired=[],S.resolve(on(function(){return l(e.vip)})).then(s)}})}).finally(function(){t.onReadyBeingFired=null,t.isBeingOpened=!1}).then(function(){return e}).catch(function(s){t.dbOpenError=s;try{u&&u.abort()}catch{}return r===t.openCanceller&&e._close(),j(s)}).finally(function(){t.openComplete=!0,a()})}function sn(e){var t=function(u){return e.next(u)},n=function(u){return e.throw(u)},r=a(t),i=a(n);function a(u){return function(o){var s=u(o),l=s.value;return s.done?l:!l||typeof l.then!="function"?W(l)?Promise.all(l).then(r,i):r(l):l.then(r,i)}}return a(t)()}function Xi(e,t,n){var r=arguments.length;if(r<2)throw new C.InvalidArgument("Too few arguments");for(var i=new Array(r-1);--r;)i[r-1]=arguments[r];n=i.pop();var a=er(i);return[e,a,n]}function xr(e,t,n,r,i){return S.resolve().then(function(){var a=k.transless||k,u=e._createTransaction(t,n,e._dbSchema,r),o={trans:u,transless:a};if(r)u.idbtrans=r.idbtrans;else try{u.create(),e._state.PR1398_maxLoop=3}catch(f){return f.name===yn.InvalidState&&e.isOpen()&&--e._state.PR1398_maxLoop>0?(console.warn("Dexie: Need to reopen db"),e._close(),e.open().then(function(){return xr(e,t,n,null,i)})):j(f)}var s=pn(i);s&&Pe();var l,d=S.follow(function(){if(l=i.call(u,u),l)if(s){var f=se.bind(null,null);l.then(f,f)}else typeof l.next=="function"&&typeof l.throw=="function"&&(l=sn(l))},o);return(l&&typeof l.then=="function"?S.resolve(l).then(function(f){return u.active?f:j(new C.PrematureCommit("Transaction committed too early. See http://bit.ly/2kdckMn"))}):d.then(function(){return l})).then(function(f){return r&&u._resolve(),u._completion.then(function(){return f})}).catch(function(f){return u._reject(f),j(f)})})}function ct(e,t,n){for(var r=W(e)?e.slice():[e],i=0;i<n;++i)r.push(t);return r}function Gi(e){return D(D({},e),{table:function(t){var n=e.table(t),r=n.schema,i={},a=[];function u(h,v,w){var _=Ue(h),b=i[_]=i[_]||[],g=h==null?0:typeof h=="string"?1:h.length,y=v>0,E=D(D({},w),{isVirtual:y,keyTail:v,keyLength:g,extractKey:nn(h),unique:!y&&w.unique});if(b.push(E),E.isPrimaryKey||a.push(E),g>1){var A=g===2?h[0]:h.slice(0,g-1);u(A,v+1,w)}return b.sort(function(x,K){return x.keyTail-K.keyTail}),E}var o=u(r.primaryKey.keyPath,0,r.primaryKey);i[":id"]=[o];for(var s=0,l=r.indexes;s<l.length;s++){var d=l[s];u(d.keyPath,0,d)}function f(h){var v=i[Ue(h)];return v&&v[0]}function p(h,v){return{type:h.type===1?2:h.type,lower:ct(h.lower,h.lowerOpen?e.MAX_KEY:e.MIN_KEY,v),lowerOpen:!0,upper:ct(h.upper,h.upperOpen?e.MIN_KEY:e.MAX_KEY,v),upperOpen:!0}}function m(h){var v=h.query.index;return v.isVirtual?D(D({},h),{query:{index:v,range:p(h.query.range,v.keyTail)}}):h}var c=D(D({},n),{schema:D(D({},r),{primaryKey:o,indexes:a,getIndexByKeyPath:f}),count:function(h){return n.count(m(h))},query:function(h){return n.query(m(h))},openCursor:function(h){var v=h.query.index,w=v.keyTail,_=v.isVirtual,b=v.keyLength;if(!_)return n.openCursor(h);function g(y){function E(x){x!=null?y.continue(ct(x,h.reverse?e.MAX_KEY:e.MIN_KEY,w)):h.unique?y.continue(y.key.slice(0,b).concat(h.reverse?e.MIN_KEY:e.MAX_KEY,w)):y.continue()}var A=Object.create(y,{continue:{value:E},continuePrimaryKey:{value:function(x,K){y.continuePrimaryKey(ct(x,e.MAX_KEY,w),K)}},primaryKey:{get:function(){return y.primaryKey}},key:{get:function(){var x=y.key;return b===1?x[0]:x.slice(0,b)}},value:{get:function(){return y.value}}});return A}return n.openCursor(m(h)).then(function(y){return y&&g(y)})}});return c}})}var $i={stack:"dbcore",name:"VirtualIndexMiddleware",level:1,create:Gi};function Kn(e,t,n,r){return n=n||{},r=r||"",N(e).forEach(function(i){if(!H(t,i))n[r+i]=void 0;else{var a=e[i],u=t[i];if(typeof a=="object"&&typeof u=="object"&&a&&u){var o=Wt(a),s=Wt(u);o!==s?n[r+i]=t[i]:o==="Object"?Kn(a,u,n,r+i+"."):a!==u&&(n[r+i]=t[i])}else a!==u&&(n[r+i]=t[i])}}),N(t).forEach(function(i){H(e,i)||(n[r+i]=t[i])}),n}function Zi(e,t){return t.type==="delete"?t.keys:t.keys||t.values.map(e.extractKey)}var ea={stack:"dbcore",name:"HooksMiddleware",level:2,create:function(e){return D(D({},e),{table:function(t){var n=e.table(t),r=n.schema.primaryKey,i=D(D({},n),{mutate:function(a){var u=k.trans,o=u.table(t).hook,s=o.deleting,l=o.creating,d=o.updating;switch(a.type){case"add":if(l.fire===B)break;return u._promise("readwrite",function(){return f(a)},!0);case"put":if(l.fire===B&&d.fire===B)break;return u._promise("readwrite",function(){return f(a)},!0);case"delete":if(s.fire===B)break;return u._promise("readwrite",function(){return f(a)},!0);case"deleteRange":if(s.fire===B)break;return u._promise("readwrite",function(){return p(a)},!0)}return n.mutate(a);function f(c){var h=k.trans,v=c.keys||Zi(r,c);if(!v)throw new Error("Keys missing");return c=c.type==="add"||c.type==="put"?D(D({},c),{keys:v}):D({},c),c.type!=="delete"&&(c.values=Lt([],c.values,!0)),c.keys&&(c.keys=Lt([],c.keys,!0)),ta(n,c,v).then(function(w){var _=v.map(function(b,g){var y=w[g],E={onerror:null,onsuccess:null};if(c.type==="delete")s.fire.call(E,b,y,h);else if(c.type==="add"||y===void 0){var A=l.fire.call(E,b,c.values[g],h);b==null&&A!=null&&(b=A,c.keys[g]=b,r.outbound||G(c.values[g],r.keyPath,b))}else{var x=Kn(y,c.values[g]),K=d.fire.call(E,x,b,y,h);if(K){var T=c.values[g];Object.keys(K).forEach(function(R){H(T,R)?T[R]=K[R]:G(T,R,K[R])})}}return E});return n.mutate(c).then(function(b){for(var g=b.failures,y=b.results,E=b.numFailures,A=b.lastResult,x=0;x<v.length;++x){var K=y?y[x]:v[x],T=_[x];K==null?T.onerror&&T.onerror(g[x]):T.onsuccess&&T.onsuccess(c.type==="put"&&w[x]?c.values[x]:K)}return{failures:g,results:y,numFailures:E,lastResult:A}}).catch(function(b){return _.forEach(function(g){return g.onerror&&g.onerror(b)}),Promise.reject(b)})})}function p(c){return m(c.trans,c.range,1e4)}function m(c,h,v){return n.query({trans:c,values:!1,query:{index:r,range:h},limit:v}).then(function(w){var _=w.result;return f({type:"delete",keys:_,trans:c}).then(function(b){return b.numFailures>0?Promise.reject(b.failures[0]):_.length<v?{failures:[],numFailures:0,lastResult:void 0}:m(c,D(D({},h),{lower:_[_.length-1],lowerOpen:!0}),v)})})}}});return i}})}};function ta(e,t,n){return t.type==="add"?Promise.resolve([]):e.getMany({trans:t.trans,keys:n,cache:"immutable"})}function Sr(e,t,n){try{if(!t||t.keys.length<e.length)return null;for(var r=[],i=0,a=0;i<t.keys.length&&a<e.length;++i)z(t.keys[i],e[a])===0&&(r.push(n?$e(t.values[i]):t.values[i]),++a);return r.length===e.length?r:null}catch{return null}}var na={stack:"dbcore",level:-1,create:function(e){return{table:function(t){var n=e.table(t);return D(D({},n),{getMany:function(r){if(!r.cache)return n.getMany(r);var i=Sr(r.keys,r.trans._cache,r.cache==="clone");return i?S.resolve(i):n.getMany(r).then(function(a){return r.trans._cache={keys:r.keys,values:r.cache==="clone"?$e(a):a},a})},mutate:function(r){return r.type!=="add"&&(r.trans._cache=null),n.mutate(r)}})}}}},Ft;function Cn(e){return!("from"in e)}var re=function(e,t){if(this)U(this,arguments.length?{d:1,from:e,to:arguments.length>1?t:e}:{d:0});else{var n=new re;return e&&"d"in e&&U(n,e),n}};De(re.prototype,(Ft={add:function(e){return At(this,e),this},addKey:function(e){return Ge(this,e,e),this},addKeys:function(e){var t=this;return e.forEach(function(n){return Ge(t,n,n)}),this}},Ft[zt]=function(){return ln(this)},Ft));function Ge(e,t,n){var r=z(t,n);if(!isNaN(r)){if(r>0)throw RangeError();if(Cn(e))return U(e,{from:t,to:n,d:1});var i=e.l,a=e.r;if(z(n,e.from)<0)return i?Ge(i,t,n):e.l={from:t,to:n,d:1,l:null,r:null},zn(e);if(z(t,e.to)>0)return a?Ge(a,t,n):e.r={from:t,to:n,d:1,l:null,r:null},zn(e);z(t,e.from)<0&&(e.from=t,e.l=null,e.d=a?a.d+1:1),z(n,e.to)>0&&(e.to=n,e.r=null,e.d=e.l?e.l.d+1:1);var u=!e.r;i&&!e.l&&At(e,i),a&&u&&At(e,a)}}function At(e,t){function n(r,i){var a=i.from,u=i.to,o=i.l,s=i.r;Ge(r,a,u),o&&n(r,o),s&&n(r,s)}Cn(t)||n(e,t)}function ra(e,t){var n=ln(t),r=n.next();if(r.done)return!1;for(var i=r.value,a=ln(e),u=a.next(i.from),o=u.value;!r.done&&!u.done;){if(z(o.from,i.to)<=0&&z(o.to,i.from)>=0)return!0;z(i.from,o.from)<0?i=(r=n.next(o.from)).value:o=(u=a.next(i.from)).value}return!1}function ln(e){var t=Cn(e)?null:{s:0,n:e};return{next:function(n){for(var r=arguments.length>0;t;)switch(t.s){case 0:if(t.s=1,r)for(;t.n.l&&z(n,t.n.from)<0;)t={up:t,n:t.n.l,s:1};else for(;t.n.l;)t={up:t,n:t.n.l,s:1};case 1:if(t.s=2,!r||z(n,t.n.to)<=0)return{value:t.n,done:!1};case 2:if(t.n.r){t.s=3,t={up:t,n:t.n.r,s:0};continue}case 3:t=t.up}return{done:!0}}}}function zn(e){var t,n,r=(((t=e.r)===null||t===void 0?void 0:t.d)||0)-(((n=e.l)===null||n===void 0?void 0:n.d)||0),i=r>1?"r":r<-1?"l":"";if(i){var a=i==="r"?"l":"r",u=D({},e),o=e[i];e.from=o.from,e.to=o.to,e[i]=o[i],u[i]=o[a],e[a]=u,u.d=Un(u)}e.d=Un(e)}function Un(e){var t=e.r,n=e.l;return(t?n?Math.max(t.d,n.d):t.d:n?n.d:0)+1}var ia={stack:"dbcore",level:0,create:function(e){var t=e.schema.name,n=new re(e.MIN_KEY,e.MAX_KEY);return D(D({},e),{table:function(r){var i=e.table(r),a=i.schema,u=a.primaryKey,o=u.extractKey,s=u.outbound,l=D(D({},i),{mutate:function(p){var m=p.trans,c=m.mutatedParts||(m.mutatedParts={}),h=function(A){var x="idb://"+t+"/"+r+"/"+A;return c[x]||(c[x]=new re)},v=h(""),w=h(":dels"),_=p.type,b=p.type==="deleteRange"?[p.range]:p.type==="delete"?[p.keys]:p.values.length<50?[[],p.values]:[],g=b[0],y=b[1],E=p.trans._cache;return i.mutate(p).then(function(A){if(W(g)){_!=="delete"&&(g=A.results),v.addKeys(g);var x=Sr(g,E);!x&&_!=="add"&&w.addKeys(g),(x||y)&&aa(h,a,x,y)}else if(g){var K={from:g.lower,to:g.upper};w.add(K),v.add(K)}else v.add(n),w.add(n),a.indexes.forEach(function(T){return h(T.name).add(n)});return A})}}),d=function(p){var m,c,h=p.query,v=h.index,w=h.range;return[v,new re((m=w.lower)!==null&&m!==void 0?m:e.MIN_KEY,(c=w.upper)!==null&&c!==void 0?c:e.MAX_KEY)]},f={get:function(p){return[u,new re(p.key)]},getMany:function(p){return[u,new re().addKeys(p.keys)]},count:d,query:d,openCursor:d};return N(f).forEach(function(p){l[p]=function(m){var c=k.subscr;if(c){var h=function(E){var A="idb://"+t+"/"+r+"/"+E;return c[A]||(c[A]=new re)},v=h(""),w=h(":dels"),_=f[p](m),b=_[0],g=_[1];if(h(b.name||"").add(g),!b.isPrimaryKey)if(p==="count")w.add(n);else{var y=p==="query"&&s&&m.values&&i.query(D(D({},m),{values:!1}));return i[p].apply(this,arguments).then(function(E){if(p==="query"){if(s&&m.values)return y.then(function(T){var R=T.result;return v.addKeys(R),E});var A=m.values?E.result.map(o):E.result;m.values?v.addKeys(A):w.addKeys(A)}else if(p==="openCursor"){var x=E,K=m.values;return x&&Object.create(x,{key:{get:function(){return w.addKey(x.primaryKey),x.key}},primaryKey:{get:function(){var T=x.primaryKey;return w.addKey(T),T}},value:{get:function(){return K&&v.addKey(x.primaryKey),x.value}}})}return E})}}return i[p].apply(this,arguments)}}),l}})}};function aa(e,t,n,r){function i(a){var u=e(a.name||"");function o(l){return l!=null?a.extractKey(l):null}var s=function(l){return a.multiEntry&&W(l)?l.forEach(function(d){return u.addKey(d)}):u.addKey(l)};(n||r).forEach(function(l,d){var f=n&&o(n[d]),p=r&&o(r[d]);z(f,p)!==0&&(f!=null&&s(f),p!=null&&s(p))})}t.indexes.forEach(i)}var Tn=function(){function e(t,n){var r=this;this._middlewares={},this.verno=0;var i=e.dependencies;this._options=n=D({addons:e.addons,autoOpen:!0,indexedDB:i.indexedDB,IDBKeyRange:i.IDBKeyRange},n),this._deps={indexedDB:n.indexedDB,IDBKeyRange:n.IDBKeyRange};var a=n.addons;this._dbSchema={},this._versions=[],this._storeNames=[],this._allTables={},this.idbdb=null,this._novip=this;var u={dbOpenError:null,isBeingOpened:!1,onReadyBeingFired:null,openComplete:!1,dbReadyResolve:B,dbReadyPromise:null,cancelOpen:B,openCanceller:null,autoSchema:!0,PR1398_maxLoop:3};u.dbReadyPromise=new S(function(o){u.dbReadyResolve=o}),u.openCanceller=new S(function(o,s){u.cancelOpen=s}),this._state=u,this.name=t,this.on=nt(this,"populate","blocked","versionchange","close",{ready:[mn,B]}),this.on.ready.subscribe=Xn(this.on.ready.subscribe,function(o){return function(s,l){e.vip(function(){var d=r._state;if(d.openComplete)d.dbOpenError||S.resolve().then(s),l&&o(s);else if(d.onReadyBeingFired)d.onReadyBeingFired.push(s),l&&o(s);else{o(s);var f=r;l||o(function p(){f.on.ready.unsubscribe(s),f.on.ready.unsubscribe(p)})}})}}),this.Collection=_i(this),this.Table=vi(this),this.Transaction=Ci(this),this.Version=Ui(this),this.WhereClause=ki(this),this.on("versionchange",function(o){o.newVersion>0?console.warn("Another connection wants to upgrade database '"+r.name+"'. Closing db now to resume the upgrade."):console.warn("Another connection wants to delete database '"+r.name+"'. Closing db now to resume the delete request."),r.close()}),this.on("blocked",function(o){!o.newVersion||o.newVersion<o.oldVersion?console.warn("Dexie.delete('"+r.name+"') was blocked"):console.warn("Upgrade '"+r.name+"' blocked by other connection holding version "+o.oldVersion/10)}),this._maxKey=Xe(n.IDBKeyRange),this._createTransaction=function(o,s,l,d){return new r.Transaction(o,s,l,r._options.chromeTransactionDurability,d)},this._fireOnBlocked=function(o){r.on("blocked").fire(o),ze.filter(function(s){return s.name===r.name&&s!==r&&!s._state.vcFired}).map(function(s){return s.on("versionchange").fire(o)})},this.use($i),this.use(ea),this.use(ia),this.use(na),this.vip=Object.create(this,{_vip:{value:!0}}),a.forEach(function(o){return o(r)})}return e.prototype.version=function(t){if(isNaN(t)||t<.1)throw new C.Type("Given version is not a positive number");if(t=Math.round(t*10)/10,this.idbdb||this._state.isBeingOpened)throw new C.Schema("Cannot add version when database is open");this.verno=Math.max(this.verno,t);var n=this._versions,r=n.filter(function(i){return i._cfg.version===t})[0];return r||(r=new this.Version(t),n.push(r),n.sort(Bi),r.stores({}),this._state.autoSchema=!1,r)},e.prototype._whenReady=function(t){var n=this;return this.idbdb&&(this._state.openComplete||k.letThrough||this._vip)?t():new S(function(r,i){if(n._state.openComplete)return i(new C.DatabaseClosed(n._state.dbOpenError));if(!n._state.isBeingOpened){if(!n._options.autoOpen){i(new C.DatabaseClosed);return}n.open().catch(B)}n._state.dbReadyPromise.then(r,i)}).then(t)},e.prototype.use=function(t){var n=t.stack,r=t.create,i=t.level,a=t.name;a&&this.unuse({stack:n,name:a});var u=this._middlewares[n]||(this._middlewares[n]=[]);return u.push({stack:n,create:r,level:i??10,name:a}),u.sort(function(o,s){return o.level-s.level}),this},e.prototype.unuse=function(t){var n=t.stack,r=t.name,i=t.create;return n&&this._middlewares[n]&&(this._middlewares[n]=this._middlewares[n].filter(function(a){return i?a.create!==i:r?a.name!==r:!1})),this},e.prototype.open=function(){return Ji(this)},e.prototype._close=function(){var t=this._state,n=ze.indexOf(this);if(n>=0&&ze.splice(n,1),this.idbdb){try{this.idbdb.close()}catch{}this._novip.idbdb=null}t.dbReadyPromise=new S(function(r){t.dbReadyResolve=r}),t.openCanceller=new S(function(r,i){t.cancelOpen=i})},e.prototype.close=function(){this._close();var t=this._state;this._options.autoOpen=!1,t.dbOpenError=new C.DatabaseClosed,t.isBeingOpened&&t.cancelOpen(t.dbOpenError)},e.prototype.delete=function(){var t=this,n=arguments.length>0,r=this._state;return new S(function(i,a){var u=function(){t.close();var o=t._deps.indexedDB.deleteDatabase(t.name);o.onsuccess=F(function(){Yi(t._deps,t.name),i()}),o.onerror=ee(a),o.onblocked=t._fireOnBlocked};if(n)throw new C.InvalidArgument("Arguments not allowed in db.delete()");r.isBeingOpened?r.dbReadyPromise.then(u):u()})},e.prototype.backendDB=function(){return this.idbdb},e.prototype.isOpen=function(){return this.idbdb!==null},e.prototype.hasBeenClosed=function(){var t=this._state.dbOpenError;return t&&t.name==="DatabaseClosed"},e.prototype.hasFailed=function(){return this._state.dbOpenError!==null},e.prototype.dynamicallyOpened=function(){return this._state.autoSchema},Object.defineProperty(e.prototype,"tables",{get:function(){var t=this;return N(this._allTables).map(function(n){return t._allTables[n]})},enumerable:!1,configurable:!0}),e.prototype.transaction=function(){var t=Xi.apply(this,arguments);return this._transaction.apply(this,t)},e.prototype._transaction=function(t,n,r){var i=this,a=k.trans;(!a||a.db!==this||t.indexOf("!")!==-1)&&(a=null);var u=t.indexOf("?")!==-1;t=t.replace("!","").replace("?","");var o,s;try{if(s=n.map(function(d){var f=d instanceof i.Table?d.name:d;if(typeof f!="string")throw new TypeError("Invalid table argument to Dexie.transaction(). Only Table or String are allowed");return f}),t=="r"||t===Rt)o=Rt;else if(t=="rw"||t==It)o=It;else throw new C.InvalidArgument("Invalid transaction mode: "+t);if(a){if(a.mode===Rt&&o===It)if(u)a=null;else throw new C.SubTransaction("Cannot enter a sub-transaction with READWRITE mode when parent transaction is READONLY");a&&s.forEach(function(d){if(a&&a.storeNames.indexOf(d)===-1)if(u)a=null;else throw new C.SubTransaction("Table "+d+" not included in parent transaction.")}),u&&a&&!a.active&&(a=null)}}catch(d){return a?a._promise(null,function(f,p){p(d)}):j(d)}var l=xr.bind(null,this,o,s,a,r);return a?a._promise(o,l,"lock"):k.trans?Be(k.transless,function(){return i._whenReady(l)}):this._whenReady(l)},e.prototype.table=function(t){if(!H(this._allTables,t))throw new C.InvalidTable("Table "+t+" does not exist");return this._allTables[t]},e}(),ua=typeof Symbol<"u"&&"observable"in Symbol?Symbol.observable:"@@observable",oa=function(){function e(t){this._subscribe=t}return e.prototype.subscribe=function(t,n,r){return this._subscribe(!t||typeof t=="function"?{next:t,error:n,complete:r}:t)},e.prototype[ua]=function(){return this},e}();function Ar(e,t){return N(t).forEach(function(n){var r=e[n]||(e[n]=new re);At(r,t[n])}),e}function sa(e){return new oa(function(t){var n=pn(e);function r(m){n&&Pe();var c=function(){return pe(e,{subscr:m,trans:null})},h=k.trans?Be(k.transless,c):c();return n&&h.then(se,se),h}var i=!1,a={},u={},o={get closed(){return i},unsubscribe:function(){i=!0,ye.storagemutated.unsubscribe(f)}};t.start&&t.start(o);var s=!1,l=!1;function d(){return N(u).some(function(m){return a[m]&&ra(a[m],u[m])})}var f=function(m){Ar(a,m),d()&&p()},p=function(){if(!(s||i)){a={};var m={},c=r(m);l||(ye(Je,f),l=!0),s=!0,Promise.resolve(c).then(function(h){s=!1,!i&&(d()?p():(a={},u=m,t.next&&t.next(h)))},function(h){s=!1,t.error&&t.error(h),o.unsubscribe()})}};return p(),o})}var cn;try{cn={indexedDB:M.indexedDB||M.mozIndexedDB||M.webkitIndexedDB||M.msIndexedDB,IDBKeyRange:M.IDBKeyRange||M.webkitIDBKeyRange}}catch{cn={indexedDB:null,IDBKeyRange:null}}var me=Tn;De(me,D(D({},Ct),{delete:function(e){var t=new me(e,{addons:[]});return t.delete()},exists:function(e){return new me(e,{addons:[]}).open().then(function(t){return t.close(),!0}).catch("NoSuchDatabaseError",function(){return!1})},getDatabaseNames:function(e){try{return qi(me.dependencies).then(e)}catch{return j(new C.MissingAPI)}},defineClass:function(){function e(t){U(this,t)}return e},ignoreTransaction:function(e){return k.trans?Be(k.transless,e):e()},vip:on,async:function(e){return function(){try{var t=sn(e.apply(this,arguments));return!t||typeof t.then!="function"?S.resolve(t):t}catch(n){return j(n)}}},spawn:function(e,t,n){try{var r=sn(e.apply(n,t||[]));return!r||typeof r.then!="function"?S.resolve(r):r}catch(i){return j(i)}},currentTransaction:{get:function(){return k.trans||null}},waitFor:function(e,t){var n=S.resolve(typeof e=="function"?me.ignoreTransaction(e):e).timeout(t||6e4);return k.trans?k.trans.waitFor(n):n},Promise:S,debug:{get:function(){return te},set:function(e){nr(e,e==="dexie"?function(){return!0}:yr)}},derive:Re,extend:U,props:De,override:Xn,Events:nt,on:ye,liveQuery:sa,extendObservabilitySet:Ar,getByKeyPath:ue,setByKeyPath:G,delByKeyPath:Lr,shallowClone:Zn,deepClone:$e,getObjectDiff:Kn,cmp:z,asap:Gn,minKey:en,addons:[],connections:ze,errnames:yn,dependencies:cn,semVer:Fn,version:Fn.split(".").map(function(e){return parseInt(e)}).reduce(function(e,t,n){return e+t/Math.pow(10,n*2)})}));me.maxKey=Xe(me.dependencies.IDBKeyRange);typeof dispatchEvent<"u"&&typeof addEventListener<"u"&&(ye(Je,function(e){if(!ae){var t;Tt?(t=document.createEvent("CustomEvent"),t.initCustomEvent(de,!0,!0,e)):t=new CustomEvent(de,{detail:e}),ae=!0,dispatchEvent(t),ae=!1}}),addEventListener(de,function(e){var t=e.detail;ae||kt(t)}));function kt(e){var t=ae;try{ae=!0,ye.storagemutated.fire(e)}finally{ae=t}}var ae=!1;if(typeof BroadcastChannel<"u"){var qn=new BroadcastChannel(de);ye(Je,function(e){ae||qn.postMessage(e)}),qn.onmessage=function(e){e.data&&kt(e.data)}}else if(typeof self<"u"&&typeof navigator<"u"){ye(Je,function(e){try{ae||(typeof localStorage<"u"&&localStorage.setItem(de,JSON.stringify({trig:Math.random(),changedParts:e})),typeof self.clients=="object"&&Lt([],self.clients.matchAll({includeUncontrolled:!0}),!0).forEach(function(t){return t.postMessage({type:de,changedParts:e})}))}catch{}}),typeof addEventListener<"u"&&addEventListener("storage",function(e){if(e.key===de){var t=JSON.parse(e.newValue);t&&kt(t.changedParts)}});var Hn=self.document&&navigator.serviceWorker;Hn&&Hn.addEventListener("message",la)}function la(e){var t=e.data;t&&t.type===de&&kt(t.changedParts)}S.rejectionMapper=Jr;nr(te,yr);function ca(e,t,n=30,r=null){let i=[];for(let a of e){a={...a},delete a.limit,delete a.since,delete a.until;let u=new Map;for(let o of da(a))u.set(JSON.stringify(o),[]);for(let o of t)fa(u,a,o);for(let[o,s]of u)ha(i,o,s,n,r)}return i}function Ne(e,t,n,r,i=null,a=!1){if(n){if(t[n]&&t[n].length>1){for(let u of t[n])if(a){for(let o of r.tags)if(o[0]==i&&o[1]===u){Nt(e,{...t,[n]:[u]},r);break}}else if(i!=null&&r[i]===u){Nt(e,{...t,[n]:[u]},r);break}return!0}return!1}else Nt(e,t,r)}function Nt(e,t,n){let r=JSON.stringify(t),i=e.get(r);i?i.push(n):e.set(r,[n])}function fa(e,t,n){Ne(e,t,"authors",n,"pubkey",!1)||Ne(e,t,"ids",n,"ids",!1)||Ne(e,t,"#p",n,"p",!0)||Ne(e,t,"#e",n,"e",!0)||Ne(e,t,null,n)}function ha(e,t,n,r,i){n=n.sort((a,u)=>a.created_at-u.created_at);for(let a=0;a<n.length;a+=r)r>1||n.length==1?e.push({filter:t,events:n.slice(a,a+r)}):e.push({filter:t,event:n[a]});i&&e.push({filter:t,query_info:i})}function da(e){let t=[];if(e.authors&&e.authors.length>1)for(let n of e.authors)t.push({...e,authors:[n]});else if(e.ids&&e.ids.length>1)for(let n of e.ids)t.push({...e,ids:[n]});else if(e["#p"]&&e["#p"].length>1)for(let n of e["#p"])t.push({...e,"#p":[n]});else if(e["#e"]&&e["#e"].length>1)for(let n of e["#e"])t.push({...e,"#e":[n]});else t.push(e);return t}class pa extends Tn{constructor(){super("nostr_events",{chromeTransactionDurability:"relaxed"}),this.version(1).stores({events:"++,filter"})}}const kr=new pa;function je(e,t,n){return t?e[t]&&e[t].length>1?n.anyOf(e[t].map(r=>JSON.stringify({...e,[t]:[r]}))):null:n.equals(JSON.stringify(e))}function va(e,t){let n=je(e,"authors",t)||je(e,"ids",t)||je(e,"#p",t)||je(e,"#e",t)||je(e,null,t);if(!n)throw new Error("splitWhereClause bug");return n}function Kr(e,t,n=30,r=null){console.log("putEvents called with ",t.length," events");let i=ca(e,t,n,r);return kr.events.bulkPut(i)}function ya(e){let t;for(let n of e){let r=t?t.or("filter"):kr.events.where("filter");n={...n},delete n.limit,t=va(n,r)}return t?t.toArray().then(n=>{let r=n.map(a=>a.events||a.event||[]).flat(),i=n.filter(a=>a.query_info);return{events:r,query_infos:i}}):new Promise(n=>({events:[],query_infos:[]}))}function ma(e,t){return e.reduce((n,r)=>(n[t(r)]=r,n),new Map)}function On(e,t){return e.reduce((n,r)=>{const i=t(r);return n.get(i)||n.set(i,[]),n.get(i).push(r),n},new Map)}function ga(e){return[...new Set(e)]}function ba(e,t){return new Map(Array.from(e.entries()).map(([n,r])=>[n,t(r)]))}function _a(e){let[t,...n]=e.trim().split("?");return t.slice(0,4)==="http"&&(t="ws"+t.slice(4)),t.slice(0,2)!=="ws"&&(t="wss://"+t),t.length&&t[t.length-1]==="/"&&(t=t.slice(0,-1)),[t,...n].join("?")}async function za(e,t,n){return n.pubkey===t?Rn.decrypt(e,n.tags[0][1],n.content):Rn.decrypt(e,n.pubkey,n.content)}function Ua(e){return[...e].sort((t,n)=>n.created_at-t.created_at)}function wa(e){var t,n;let r=!1;var i,a={},u={connect:[],disconnect:[],error:[],notice:[]},o={},s={};async function l(){return new Promise((m,c)=>{t=new WebSocket(e),t.onopen=()=>{r=!0;for(let h in a)f(["REQ",h,...a[h].filters]);u.connect.forEach(h=>h()),m()},t.onerror=()=>{u.error.forEach(h=>h()),c()},t.onclose=async()=>{u.disconnect.forEach(h=>h()),n&&n()},t.onmessage=async h=>{var w,_,b,g;var v;try{v=JSON.parse(h.data)}catch{v=h.data}if(v.length>=1)switch(v[0]){case"EVENT":if(v.length!==3)return;let y=v[1],E=v[2];Ir(E)&&a[y]&&(a[y].skipVerification||Pr(E))&&Br(a[y].filters,E)&&(a[y],(((w=o[y])==null?void 0:w.event)||[]).forEach(x=>x(E)));return;case"EOSE":{if(v.length!==2)return;let x=v[1];(((_=o[x])==null?void 0:_.eose)||[]).forEach(K=>K());return}case"OK":{if(v.length<3)return;let x=v[1],K=v[2],T=v[3]||"";K?(b=s[x])==null||b.ok.forEach(R=>R()):(g=s[x])==null||g.failed.forEach(R=>R(T));return}case"NOTICE":if(v.length!==2)return;let A=v[1];u.notice.forEach(x=>x(A));return}}})}async function d(){t!=null&&t.readyState&&t.readyState===1||await l()}async function f(m){let c=JSON.stringify(m);await i,t.send(c)}const p=(m,{skipVerification:c=!1,id:h=Math.random().toString().slice(2)}={})=>{let v=h;return a[v]={id:v,filters:m,skipVerification:c},r&&f(["REQ",v,...m]),{sub:(w,_={})=>p(w||m,{skipVerification:_.skipVerification||c,id:v}),unsub:()=>{delete a[v],delete o[v],r&&f(["CLOSE",v])},on:(w,_)=>{o[v]=o[v]||{event:[],eose:[]},o[v][w].push(_)},off:(w,_)=>{let b=o[v],g=b[w].indexOf(_);g>=0&&b[w].splice(g,1)}}};return{url:e,sub:p,on:(m,c)=>{u[m].push(c),m==="connect"&&(t==null?void 0:t.readyState)===1&&c()},off:(m,c)=>{let h=u[m].indexOf(c);h!==-1&&u[m].splice(h,1)},publish(m){if(!m.id)throw new Error(`event ${m} has no id`);let c=m.id;var h=!1,v=!1;f(["EVENT",m]).then(()=>{h=!0,v&&(w(),v=!1)}).catch(()=>{});const w=()=>{let _=p([{ids:[c]}],{id:`monitor-${c.slice(0,5)}`}),b=setTimeout(()=>{var g;(((g=s[c])==null?void 0:g.failed)||[]).forEach(y=>y("event not seen after 5 seconds")),_.unsub()},5e3);_.on("event",()=>{var g;clearTimeout(b),(((g=s[c])==null?void 0:g.seen)||[]).forEach(y=>y())})};return{on:(_,b)=>{s[c]=s[c]||{ok:[],seen:[],failed:[]},s[c][_].push(b),_==="seen"&&(h?w():v=!0)},off:(_,b)=>{let g=s[c];if(!g)return;let y=g[_].indexOf(b);y>=0&&g[_].splice(y,1)}}},connect:d,close(){return t.close(),new Promise(m=>{n=m})},get status(){return(t==null?void 0:t.readyState)??3}}}function Ea(e,t){if(t={...t},t.ids){if(t.ids=t.ids.filter(n=>!e.find(r=>r.id==Oe(n))),!t.ids.length)return null}else if(t.authors){if(t.authors=t.authors.filter(n=>!e.find(r=>r.pubkey==Oe(n))),!t.authors.length)return null}else throw new Error("onlyOne option not supported for this filter"+JSON.stringify(t));return t}function xa(e,t,n,r,i){let a=[];for(let u of t){u={...u};let o=n.onlyOne;if(u.ids&&u.ids.length==0||u.authors&&u.authors.length==0||u.kinds&&u.kinds.length==0){console.timeLog(e,"no need to send subscription because filter is empty");continue}if(u.ids&&(o=!0),o){let l=Ea(r,u);if(!l){console.timeLog(e,"no need to send subscription because all events are already in the database");continue}u=l}if(u.authors&&!u.retrieve_old){console.log("splitting by authors",u.authors),console.log("events",r);let l=On(r,p=>p.pubkey),d=ba(l,p=>Math.max(...p.map(m=>m.created_at)));console.log("last_created_at_by_author",d);let f=[];for(let p of u.authors){let m=d.get(Oe(p));if(m==null)f.push(p);else{let c={...u};c.authors=[p],c.since=m+1,a.push(mt(c))}}if(f.length==0)continue;u.authors=f}let s=!1;for(let l of Object.keys(u)){if(!l.startsWith("#"))continue;console.log("Splitting by tag",l,u[l]);let d=[];for(let f of u[l]){let p=l.slice(1),m=Math.max(...r.filter(c=>c.tags.find(h=>h[0]==p&&h[1]==f)).map(c=>c.created_at));if(console.log("last_created_at",m,p,f),m==null)d.push(f);else{let c={...u};c[l]=[f],c.since=m+1,a.push(mt(c))}}if(d.length==0){s=!0;break}u[l]=d}s||a.push(mt(u))}if(a.length!=0)return a}let Oe=e=>typeof e=="string"?e:e[0];function mt(e){let t={};e.ids&&(t.ids=e.ids.map(Oe)),e.kinds&&(t.kinds=e.kinds),e.authors&&(t.authors=e.authors.map(Oe)),e.since&&(t.since=e.since),e.until&&(t.until=e.until),e.limit&&(t.limit=e.limit);for(let n of Object.keys(e))n.startsWith("#")&&(t[n]=e[n].map(Oe));return t}let jt=0,Se="wss://nostr-relay.wlvs.space";Se="wss://relay.damus.io";Se="wss://nostr.fmt.wiz.biz";Se="wss://relay.damus.io";Se="wss://nostr.fmt.wiz.biz";Se=_a(Se);const it=wa(Se);it.on("error",e=>{console.log("Relay error",e)});it.on("notice",e=>{console.log("Relay notice",e)});function Sa(e,t){for(let n of e)if(n.id==t)return!0;return!1}let Cr=e=>{var t;(t=e.sub)==null||t.unsub(),e.sub=void 0};function Aa(e){e.query_info.eose_received_at=fn(),e.query_info.total_events=e.events.length,e.query_info.new_events=e.newEvents.length,console.timeLog(e.label,"EOSE with "+e.events.length+" events, from that "+e.newEvents.length+" new"),console.timeEnd(e.label),console.log("Writing query info",e.query_info),Kr(e.filters,e.newEvents,void 0,e.query_info),e.newEvents=[],e.changed&&e.callback&&e.callback(e.events),e.eose=!0,e.autoClose&&Cr(e)}function ka(e,t){e.changed=!0,e.events.push(t),e.eose?(Kr(e.filters,[t]),console.time("callback"),e.callback(e.events),console.timeEnd("callback")):e.newEvents.push(t)}function Ka(e,t){e.query_info.received_events++,Sa(e.events,t.id)||ka(e,t)}it.on("disconnect",()=>{console.log("relay disconnected")});it.connect();function Ca(e){console.log("relay.sub",e.subText,...e.filters);let t=it.sub(e.filters);e.sub=t,t.on("event",n=>{console.log("event",e.subText,n),Ka(e,n)}),t.on("eose",()=>Aa(e))}const fn=()=>Math.floor(Date.now()/1e3);function Tr(e,t,n={}){let r=JSON.stringify(e);console.time(r);let i="sub"+jt;jt=jt+1;let a=fn(),u;return ya(e.map(mt)).then(({events:o,query_infos:s})=>{let l=o.length;o.length&&t(o);let d=xa(r,e,n,o);console.timeLog(r,`got ${l} indexedDB events for filter, query_infos`,s,"filter_result",d),d&&(u={events:o,callback:t,filters:d,changed:!1,options:n,label:r,subText:i,newEvents:[],query_info:{db_queried_at:a,req_sent_at:fn(),received_events:0}},console.log("sending subscription REQ",i,...u.filters,", original label",u.label,", req_sent_at",u.query_info.req_sent_at),Ca(u))}),()=>{u&&(Cr(u),u.callback=null)}}function Me(e,t){return Yn([],function(r){return Tr(e,r,t)})}function Dn(e,t,n){let r=null;return Yn([],function(a){return e.subscribe(u=>{r&&r(),r=Tr(t(u),a,n)}),()=>{r&&r()}})}let Ta=(e,t=500)=>Me([{authors:[e],limit:t}]),Oa=(e,t=500)=>Me([{"#p":[e],limit:t}]),Da=(e,t)=>Dn(e,n=>{let r={kinds:[0],authors:[t]};console.log("filtering profiles",n);for(let i=0;i<n.length;i++){let a=n[i];r.authors=ga(r.authors.concat(a.tags.filter(u=>u[0]=="p"&&u[1]&&u[1].length>8).map(u=>u[1])))}return[r]},{onlyOne:!0}),Ra=e=>hn(e,t=>ma(t,n=>n.pubkey)),Ia=e=>hn(e,t=>{var r;return((r=t.findLast(i=>i.kind===ge.Contacts))==null?void 0:r.tags.map(i=>i[1]))||[]}),Pa=e=>t=>t.filter(n=>n.kind===e),Ba=(e,t=500)=>Dn(e,n=>[{authors:n,limit:t}]),Or=e=>{let t=e.filter(i=>i.kind==ge.Text).map(i=>i.tags).flat().filter(i=>i[0]=="e").map(i=>i.slice(1)),n=On(t,i=>i[0]),r=[];for(let[i,a]of n){let u=a.map(o=>o.slice(1)).flat();r.push([i,...new Set(u)])}return{ids:r}},Ma=e=>hn(Me([Or(e)],{onlyOne:!0}),t=>On(t,n=>n.id));function Fa(e,t=null){const{subscribe:n,set:r}=Qn(JSON.parse(localStorage.getItem(e))||t);return{subscribe:n,set:i=>{localStorage.setItem(e,JSON.stringify(i)),r(i)}}}function Dr(e,t=null){const{subscribe:n,set:r}=Qn(localStorage.getItem(e)||t);return{subscribe:n,set:i=>{localStorage.setItem(e,i),r(i)}}}let Na=()=>Dr("nostr_profile_state");async function ja(e){let t=Me([{kinds:[ge.Contacts],authors:[e]}],{onlyOne:!0});return new Promise((n,r)=>{t.subscribe(i=>{i.length>0&&n(i[0].tags.filter(a=>a[0]=="p").map(a=>a[1]))})})}let La=(e,t)=>Me([{authors:[e],limit:200},{"#p":[e],limit:200},{authors:[e],kinds:[ge.Contacts]},{authors:[e],kinds:[ge.Metadata]},{authors:t,limit:50},{"#p":t,limit:50},{authors:t,kinds:[ge.Contacts],onlyOne:!0},{authors:t,kinds:[ge.Metadata],onlyOne:!0}]);const qa=Object.freeze(Object.defineProperty({__proto__:null,subscribeAndCacheResultsStore:Me,derivedSubscribeStore:Dn,publishedStore:Ta,receivedStore:Oa,publishedProfilesStore:Da,publishedProfilesByPubKeyStore:Ra,contactsStore:Ia,filterByKind:Pa,eventsFromFollowedStore:Ba,repliesFilter:Or,repliesStore:Ma,localStorageJSONStore:Fa,localStorageStore:Dr,profileStateLocalStore:Na,getFollowed:ja,getEvents:La},Symbol.toStringTag,{value:"Module"}));export{La as a,Me as b,ya as c,za as d,qa as e,On as g,ma as m,Or as r,Ua as s};
